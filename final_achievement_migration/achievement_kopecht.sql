-- Migration: Create Achievement System Tables
-- Schema: kopecht


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 1: Create Tables
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SET search_path TO kopecht;

-- 1. Achievement Categories (global - shared across all kickers)
CREATE TABLE IF NOT EXISTS kopecht.achievement_categories (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    key TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    description TEXT,
    icon TEXT,
    sort_order INT NOT NULL DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 2. Achievement Definitions (global - shared across all kickers)
CREATE TABLE IF NOT EXISTS kopecht.achievement_definitions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    key TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    description TEXT NOT NULL,
    category_id BIGINT NOT NULL REFERENCES kopecht.achievement_categories(id) ON DELETE CASCADE,
    trigger_event TEXT NOT NULL, -- 'MATCH_ENDED', 'GOAL_SCORED', 'SEASON_ENDED'
    condition JSONB NOT NULL DEFAULT '{}',
    points INT NOT NULL DEFAULT 10,
    icon TEXT,
    is_hidden BOOLEAN NOT NULL DEFAULT FALSE,
    is_repeatable BOOLEAN NOT NULL DEFAULT FALSE,
    max_progress INT NOT NULL DEFAULT 1,
    season_id BIGINT REFERENCES kopecht.seasons(id) ON DELETE SET NULL,
    parent_id BIGINT REFERENCES kopecht.achievement_definitions(id) ON DELETE SET NULL,
    sort_order INT NOT NULL DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 3. Player Achievement Progress (for tracking progress towards achievements)
CREATE TABLE IF NOT EXISTS kopecht.player_achievement_progress (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    player_id BIGINT NOT NULL REFERENCES kopecht.player(id) ON DELETE CASCADE,
    achievement_id BIGINT NOT NULL REFERENCES kopecht.achievement_definitions(id) ON DELETE CASCADE,
    current_progress INT NOT NULL DEFAULT 0,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT player_achievement_progress_unique UNIQUE (player_id, achievement_id)
);

-- 4. Player Achievements (unlocked achievements)
CREATE TABLE IF NOT EXISTS kopecht.player_achievements (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    player_id BIGINT NOT NULL REFERENCES kopecht.player(id) ON DELETE CASCADE,
    achievement_id BIGINT NOT NULL REFERENCES kopecht.achievement_definitions(id) ON DELETE CASCADE,
    unlocked_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    times_completed INT NOT NULL DEFAULT 1,
    season_id BIGINT REFERENCES kopecht.seasons(id) ON DELETE SET NULL,
    match_id BIGINT REFERENCES kopecht.matches(id) ON DELETE SET NULL,
    CONSTRAINT player_achievements_unique UNIQUE (player_id, achievement_id, season_id)
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_achievement_definitions_trigger ON kopecht.achievement_definitions(trigger_event);
CREATE INDEX IF NOT EXISTS idx_achievement_definitions_category ON kopecht.achievement_definitions(category_id);
CREATE INDEX IF NOT EXISTS idx_achievement_definitions_parent ON kopecht.achievement_definitions(parent_id);
CREATE INDEX IF NOT EXISTS idx_achievement_definitions_season ON kopecht.achievement_definitions(season_id);
CREATE INDEX IF NOT EXISTS idx_player_achievement_progress_player ON kopecht.player_achievement_progress(player_id);
CREATE INDEX IF NOT EXISTS idx_player_achievement_progress_achievement ON kopecht.player_achievement_progress(achievement_id);
CREATE INDEX IF NOT EXISTS idx_player_achievements_player ON kopecht.player_achievements(player_id);
CREATE INDEX IF NOT EXISTS idx_player_achievements_achievement ON kopecht.player_achievements(achievement_id);
CREATE INDEX IF NOT EXISTS idx_player_achievements_season ON kopecht.player_achievements(season_id);
CREATE INDEX IF NOT EXISTS idx_player_achievements_unlocked ON kopecht.player_achievements(unlocked_at DESC);

-- Enable Row Level Security
ALTER TABLE kopecht.achievement_categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE kopecht.achievement_definitions ENABLE ROW LEVEL SECURITY;
ALTER TABLE kopecht.player_achievement_progress ENABLE ROW LEVEL SECURITY;
ALTER TABLE kopecht.player_achievements ENABLE ROW LEVEL SECURITY;

-- RLS Policies for achievement_categories (global - all authenticated users can view, only super admin can manage)
CREATE POLICY "Authenticated users can view achievement categories"
    ON kopecht.achievement_categories FOR SELECT
    USING (auth.role() = 'authenticated');

CREATE POLICY "Super admin can manage achievement categories"
    ON kopecht.achievement_categories FOR ALL
    USING (auth.uid() = 'caeedd2f-5809-41ff-8a79-0c4c64836d2b'::uuid);

CREATE POLICY "Service role can manage achievement categories"
    ON kopecht.achievement_categories FOR ALL
    USING (auth.role() = 'service_role');

-- RLS Policies for achievement_definitions (global - users can view non-hidden or unlocked, only super admin can manage)
CREATE POLICY "Authenticated users can view achievement definitions"
    ON kopecht.achievement_definitions FOR SELECT
    USING (
        auth.role() = 'authenticated'
        AND (
            is_hidden = FALSE
            OR EXISTS (
                SELECT 1 FROM kopecht.player_achievements pa
                JOIN kopecht.player p ON pa.player_id = p.id
                WHERE pa.achievement_id = achievement_definitions.id
                AND p.user_id = auth.uid()
            )
        )
    );

CREATE POLICY "Super admin can manage achievement definitions"
    ON kopecht.achievement_definitions FOR ALL
    USING (auth.uid() = 'caeedd2f-5809-41ff-8a79-0c4c64836d2b'::uuid);

CREATE POLICY "Service role can manage achievement definitions"
    ON kopecht.achievement_definitions FOR ALL
    USING (auth.role() = 'service_role');

-- RLS Policies for player_achievement_progress
CREATE POLICY "Users can view their own achievement progress"
    ON kopecht.player_achievement_progress FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM kopecht.player p
            WHERE p.id = player_achievement_progress.player_id
            AND p.user_id = auth.uid()
        )
    );

CREATE POLICY "Service role can manage all progress"
    ON kopecht.player_achievement_progress FOR ALL
    USING (auth.role() = 'service_role');

-- RLS Policies for player_achievements
CREATE POLICY "Users can view achievements for players in their kickers"
    ON kopecht.player_achievements FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM kopecht.player p
            JOIN kopecht.player p2 ON p.kicker_id = p2.kicker_id
            WHERE p2.id = player_achievements.player_id
            AND p.user_id = auth.uid()
        )
    );

CREATE POLICY "Service role can manage all achievements"
    ON kopecht.player_achievements FOR ALL
    USING (auth.role() = 'service_role');

-- Function to update achievement_definitions updated_at
CREATE OR REPLACE FUNCTION kopecht.update_achievement_definition_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger for updated_at
CREATE TRIGGER update_achievement_definitions_updated_at
    BEFORE UPDATE ON kopecht.achievement_definitions
    FOR EACH ROW
    EXECUTE FUNCTION kopecht.update_achievement_definition_updated_at();

-- Function to update player_achievement_progress updated_at
CREATE OR REPLACE FUNCTION kopecht.update_achievement_progress_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger for progress updated_at
CREATE TRIGGER update_player_achievement_progress_updated_at
    BEFORE UPDATE ON kopecht.player_achievement_progress
    FOR EACH ROW
    EXECUTE FUNCTION kopecht.update_achievement_progress_updated_at();

-- Enable realtime for player_achievements (for toast notifications)
ALTER PUBLICATION supabase_realtime ADD TABLE kopecht.player_achievements;




-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 2: INSERT CATEGORIES
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Create Goals Category
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('goals', 'Goals', 'Achievements for scoring goals', 'âš½', 1)
ON CONFLICT (key) DO NOTHING;

-- Speed Category (for time-based achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('speed', 'Speed', 'Achievements for fast plays', 'âš¡', 2)
ON CONFLICT (key) DO NOTHING;

-- Matches Category (for match count achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('matches', 'Matches', 'Achievements for playing matches', 'ðŸŽ®', 3)
ON CONFLICT (key) DO NOTHING;

-- Wins Category (for winning achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('wins', 'Victories', 'Achievements for winning matches', 'ðŸ†', 4)
ON CONFLICT (key) DO NOTHING;

-- Skill Category (for skill-based achievements like MMR)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('skill', 'Skill', 'Achievements for skill milestones', 'ðŸ“ˆ', 5)
ON CONFLICT (key) DO NOTHING;

-- Comeback Category (for comeback achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('comeback', 'Comebacks', 'Achievements for epic comebacks', 'ðŸ”¥', 6)
ON CONFLICT (key) DO NOTHING;

-- Playtime Category (for time played achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('playtime', 'Playtime', 'Achievements for time played', 'â±ï¸', 7)
ON CONFLICT (key) DO NOTHING;

-- Teamwork Category (for 2on2 specific achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('teamwork', 'Teamwork', 'Achievements for team play', 'ðŸ¤', 8)
ON CONFLICT (key) DO NOTHING;

-- Streaks Category (for streak achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('streaks', 'Streaks', 'Achievements for win/loss streaks', 'ðŸ”—', 9)
ON CONFLICT (key) DO NOTHING;

-- Season Category (for season achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('season', 'Season', 'Seasonal achievements', 'ðŸ…', 10)
ON CONFLICT (key) DO NOTHING;

-- Meta Category (for meta achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('meta', 'Meta', 'Achievements about achievements', 'ðŸŽ¯', 11)
ON CONFLICT (key) DO NOTHING;

-- Secret Category (for hidden/joke achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('secret', 'Secret', 'Secret achievements', 'ðŸ”®', 99)
ON CONFLICT (key) DO NOTHING;


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 3: INSERT ACHIEVEMENTS
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Bambini - 10 goals in 1on1
INSERT INTO kopecht.achievement_definitions (
    key, 
    name, 
    description, 
    category_id, 
    trigger_event, 
    condition, 
    points, 
    max_progress, 
    is_hidden,
    is_repeatable
) VALUES (
    'goals_1on1_10', 
    'Bambini', 
    'Score 10 goals in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 10, "filters": {"gamemode": "1on1"}}',
    50,
    10,
    false,
    false
);

-- TorjÃ¤ger - 100 goals in 1on1
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_1on1_100', 
    'Tryharder', 
    'Score 100 goals in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 100, "filters": {"gamemode": "1on1"}}',
    100,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_1on1_10')
);

-- ScharfschÃ¼tze - 500 goals in 1on1
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_1on1_500', 
    'Sniper', 
    'Score 500 goals in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 500, "filters": {"gamemode": "1on1"}}',
    250,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_1on1_100')
);

-- Tormaschine - 1000 goals in 1on1
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_1on1_1000', 
    'Goal Machine', 
    'Score 1000 goals in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 1000, "filters": {"gamemode": "1on1"}}',
    500,
    1000,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_1on1_500')
);

-- Solo-Legende - 2500 goals in 1on1
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_1on1_2500', 
    'Solo Legend', 
    'Score 2500 goals in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 2500, "filters": {"gamemode": "1on1"}}',
    1000,
    2500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_1on1_1000')
);

-- EinzelkÃ¤mpfer - 5000 goals in 1on1
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_1on1_5000', 
    'EinzelkÃ¤mpfer', 
    'Score 5000 goals in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 5000, "filters": {"gamemode": "1on1"}}',
    2000,
    5000,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_1on1_2500')
);

-- ============================================
-- 2ON2 GOAL ACHIEVEMENTS
-- ============================================

-- Teamplayer - 10 goals in 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'goals_2on2_10', 
    'Teamplayer', 
    'Score 10 goals in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 10, "filters": {"gamemode": "2on2"}}',
    50,
    10,
    false,
    false
);

-- Doppelpacker - 100 goals in 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_2on2_100', 
    'Double Striker', 
    'Score 100 goals in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 100, "filters": {"gamemode": "2on2"}}',
    100,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_2on2_10')
);

-- Team-Kanone - 500 goals in 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_2on2_500', 
    'Team Cannon', 
    'Score 500 goals in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 500, "filters": {"gamemode": "2on2"}}',
    250,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_2on2_100')
);

-- Duo-Dynamo - 1000 goals in 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_2on2_1000', 
    'Duo Dynamo', 
    'Score 1000 goals in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 1000, "filters": {"gamemode": "2on2"}}',
    500,
    1000,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_2on2_500')
);

-- Team-Legende - 2500 goals in 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_2on2_2500', 
    'Team Legend', 
    'Score 2500 goals in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 2500, "filters": {"gamemode": "2on2"}}',
    1000,
    2500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_2on2_1000')
);

-- Duo-Gott - 5000 goals in 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_2on2_5000', 
    'Duo God', 
    'Score 5000 goals in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 5000, "filters": {"gamemode": "2on2"}}',
    2000,
    5000,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_2on2_2500')
);

-- ============================================
-- SPEED ACHIEVEMENTS (1on1 and 2on2)
-- ============================================

-- Quick Start 1on1 - Score in first 10 seconds
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'quick_start_1on1', 
    'Quick Start (1on1)', 
    'Score a goal in the first 10 seconds of a 1on1 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'speed'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "early_goal", "target": 10, "filters": {"gamemode": "1on1"}}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Quick Start 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'quick_start_2on2', 
    'Quick Start (2on2)', 
    'Score a goal in the first 10 seconds of a 2on2 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'speed'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "early_goal", "target": 10, "filters": {"gamemode": "2on2"}}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Hat Trick Speed 1on1 - 3 goals in 60 seconds
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'hat_trick_speed_1on1', 
    'Speed Demon (1on1)', 
    'Score 3 goals within 60 seconds in a 1on1 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'speed'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "goals_in_timeframe", "target": 3, "timeframe_seconds": 60, "filters": {"gamemode": "1on1"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Hat Trick Speed 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'hat_trick_speed_2on2', 
    'Speed Demon (2on2)', 
    'Score 3 goals within 60 seconds in a 2on2 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'speed'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "goals_in_timeframe", "target": 3, "timeframe_seconds": 60, "filters": {"gamemode": "2on2"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Blitz Victory 1on1 - Win under 4 minutes
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'blitzkrieg_1on1', 
    'Blitzkrieg (1on1)', 
    'Win a 1on1 match in under 4 minutes',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'speed'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "fast_win", "target": 240, "filters": {"gamemode": "1on1", "result": "win"}}',
    75,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Blitz Victory 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'blitzkrieg_2on2', 
    'Blitzkrieg (2on2)', 
    'Win a 2on2 match in under 4 minutes',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'speed'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "fast_win", "target": 240, "filters": {"gamemode": "2on2", "result": "win"}}',
    75,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- MATCHES PLAYED ACHIEVEMENTS (1on1)
-- ============================================

-- Matches 1on1 Chain: 10 -> 50 -> 100 -> 250 -> 500 -> 1000
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'matches_1on1_10', 
    'Getting Started (1on1)', 
    'Play 10 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 10, "filters": {"gamemode": "1on1"}}',
    25,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_1on1_50', 
    'Regular Player (1on1)', 
    'Play 50 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 50, "filters": {"gamemode": "1on1"}}',
    50,
    50,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_1on1_10')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_1on1_100', 
    'Centurion (1on1)', 
    'Play 100 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 100, "filters": {"gamemode": "1on1"}}',
    100,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_1on1_50')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_1on1_250', 
    'Veteran (1on1)', 
    'Play 250 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 250, "filters": {"gamemode": "1on1"}}',
    200,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_1on1_100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_1on1_500', 
    'Dedicated (1on1)', 
    'Play 500 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 500, "filters": {"gamemode": "1on1"}}',
    400,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_1on1_250')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_1on1_1000', 
    'Legend (1on1)', 
    'Play 1000 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 1000, "filters": {"gamemode": "1on1"}}',
    1000,
    1000,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_1on1_500')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- MATCHES PLAYED ACHIEVEMENTS (2on2)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'matches_2on2_10', 
    'Getting Started (2on2)', 
    'Play 10 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 10, "filters": {"gamemode": "2on2"}}',
    25,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_2on2_50', 
    'Regular Player (2on2)', 
    'Play 50 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 50, "filters": {"gamemode": "2on2"}}',
    50,
    50,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_2on2_10')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_2on2_100', 
    'Centurion (2on2)', 
    'Play 100 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 100, "filters": {"gamemode": "2on2"}}',
    100,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_2on2_50')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_2on2_250', 
    'Veteran (2on2)', 
    'Play 250 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 250, "filters": {"gamemode": "2on2"}}',
    200,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_2on2_100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_2on2_500', 
    'Dedicated (2on2)', 
    'Play 500 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 500, "filters": {"gamemode": "2on2"}}',
    400,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_2on2_250')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_2on2_1000', 
    'Legend (2on2)', 
    'Play 1000 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 1000, "filters": {"gamemode": "2on2"}}',
    1000,
    1000,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_2on2_500')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- WINS ACHIEVEMENTS (1on1)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'wins_1on1_10', 
    'First Victories (1on1)', 
    'Win 10 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 10, "filters": {"gamemode": "1on1", "result": "win"}}',
    25,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_1on1_25', 
    'Rising Star (1on1)', 
    'Win 25 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 25, "filters": {"gamemode": "1on1", "result": "win"}}',
    50,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_1on1_10')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_1on1_50', 
    'Winner (1on1)', 
    'Win 50 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 50, "filters": {"gamemode": "1on1", "result": "win"}}',
    75,
    50,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_1on1_25')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_1on1_100', 
    'Champion (1on1)', 
    'Win 100 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 100, "filters": {"gamemode": "1on1", "result": "win"}}',
    150,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_1on1_50')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_1on1_250', 
    'Dominator (1on1)', 
    'Win 250 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 250, "filters": {"gamemode": "1on1", "result": "win"}}',
    300,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_1on1_100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_1on1_500', 
    'Master (1on1)', 
    'Win 500 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 500, "filters": {"gamemode": "1on1", "result": "win"}}',
    500,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_1on1_250')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_1on1_1000', 
    'Unstoppable (1on1)', 
    'Win 1000 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 1000, "filters": {"gamemode": "1on1", "result": "win"}}',
    1500,
    1000,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_1on1_500')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- WINS ACHIEVEMENTS (2on2)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'wins_2on2_10', 
    'First Victories (2on2)', 
    'Win 10 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 10, "filters": {"gamemode": "2on2", "result": "win"}}',
    25,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_2on2_25', 
    'Rising Star (2on2)', 
    'Win 25 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 25, "filters": {"gamemode": "2on2", "result": "win"}}',
    50,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_2on2_10')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_2on2_50', 
    'Winner (2on2)', 
    'Win 50 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 50, "filters": {"gamemode": "2on2", "result": "win"}}',
    75,
    50,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_2on2_25')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_2on2_100', 
    'Champion (2on2)', 
    'Win 100 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 100, "filters": {"gamemode": "2on2", "result": "win"}}',
    150,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_2on2_50')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_2on2_250', 
    'Dominator (2on2)', 
    'Win 250 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 250, "filters": {"gamemode": "2on2", "result": "win"}}',
    300,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_2on2_100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_2on2_500', 
    'Master (2on2)', 
    'Win 500 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 500, "filters": {"gamemode": "2on2", "result": "win"}}',
    500,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_2on2_250')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_2on2_1000', 
    'Unstoppable (2on2)', 
    'Win 1000 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 1000, "filters": {"gamemode": "2on2", "result": "win"}}',
    1500,
    1000,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_2on2_500')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- PERFECT WIN (10:0)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'perfect_win_1on1', 
    'Flawless Victory (1on1)', 
    'Win a 1on1 match 10:0',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "perfect_win", "filters": {"gamemode": "1on1", "result": "win", "score_diff": {"min": 10}}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'perfect_win_2on2', 
    'Flawless Victory (2on2)', 
    'Win a 2on2 match 10:0',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "perfect_win", "filters": {"gamemode": "2on2", "result": "win", "score_diff": {"min": 10}}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- WIN STREAKS
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'win_streak_5_1on1', 
    'Hot Streak (1on1)', 
    'Win 5 matches in a row in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "win", "min_streak": 5}, "filters": {"gamemode": "1on1"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'win_streak_5_2on2', 
    'Hot Streak (2on2)', 
    'Win 5 matches in a row in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "win", "min_streak": 5}, "filters": {"gamemode": "2on2"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- COMEBACK ACHIEVEMENTS
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'comeback_5_1on1', 
    'Never Give Up (1on1)', 
    'Win a 1on1 match after being down 0:5',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'comeback'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "comeback", "target": 5, "filters": {"gamemode": "1on1", "result": "win"}}',
    150,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'comeback_5_2on2', 
    'Never Give Up (2on2)', 
    'Win a 2on2 match after being down 0:5',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'comeback'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "comeback", "target": 5, "filters": {"gamemode": "2on2", "result": "win"}}',
    150,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- MMR ACHIEVEMENTS (1on1)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'mmr_1on1_1100', 
    'Rising Talent (1on1)', 
    'Reach 1100 MMR in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1100, "filters": {"gamemode": "1on1"}}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_1on1_1200', 
    'Skilled Player (1on1)', 
    'Reach 1200 MMR in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1200, "filters": {"gamemode": "1on1"}}',
    100,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_1on1_1100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_1on1_1300', 
    'Expert (1on1)', 
    'Reach 1300 MMR in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1300, "filters": {"gamemode": "1on1"}}',
    200,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_1on1_1200')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_1on1_1400', 
    'Elite (1on1)', 
    'Reach 1400 MMR in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1400, "filters": {"gamemode": "1on1"}}',
    400,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_1on1_1300')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_1on1_1500', 
    'Grandmaster (1on1)', 
    'Reach 1500 MMR in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1500, "filters": {"gamemode": "1on1"}}',
    1000,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_1on1_1400')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- MMR ACHIEVEMENTS (2on2)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'mmr_2on2_1100', 
    'Rising Talent (2on2)', 
    'Reach 1100 MMR in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1100, "filters": {"gamemode": "2on2"}}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_2on2_1200', 
    'Skilled Player (2on2)', 
    'Reach 1200 MMR in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1200, "filters": {"gamemode": "2on2"}}',
    100,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_2on2_1100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_2on2_1300', 
    'Expert (2on2)', 
    'Reach 1300 MMR in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1300, "filters": {"gamemode": "2on2"}}',
    200,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_2on2_1200')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_2on2_1400', 
    'Elite (2on2)', 
    'Reach 1400 MMR in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1400, "filters": {"gamemode": "2on2"}}',
    400,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_2on2_1300')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_2on2_1500', 
    'Grandmaster (2on2)', 
    'Reach 1500 MMR in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1500, "filters": {"gamemode": "2on2"}}',
    1000,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_2on2_1400')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- GIANT SLAYER (Beat +200 MMR opponent)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'giant_slayer_1on1', 
    'Giant Slayer (1on1)', 
    'Beat an opponent with 200+ higher MMR in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr_diff_win", "target": 200, "filters": {"gamemode": "1on1", "result": "win"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'giant_slayer_2on2', 
    'Giant Slayer (2on2)', 
    'Beat opponents with 200+ higher average MMR in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr_diff_win", "target": 200, "filters": {"gamemode": "2on2", "result": "win"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- PLAYTIME ACHIEVEMENTS
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'playtime_8h', 
    'Time Flies', 
    'Play for a total of 8 hours',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "playtime_seconds", "target": 28800}',
    50,
    28800,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'playtime_16h', 
    'Dedicated Player', 
    'Play for a total of 16 hours',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "playtime_seconds", "target": 57600}',
    100,
    57600,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'playtime_8h')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'playtime_24h', 
    'Full Day', 
    'Play for a total of 24 hours',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "playtime_seconds", "target": 86400}',
    200,
    86400,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'playtime_16h')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- TEAMWORK (2on2 only)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'carry_2on2', 
    'The Carry', 
    'Score all goals for your team and win the 2on2 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'teamwork'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "carry_win", "filters": {"gamemode": "2on2", "result": "win"}}',
    150,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- HIDDEN ACHIEVEMENTS
-- ============================================

-- Silent Partner - Win 2on2 without scoring
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'silent_partner', 
    'Silent Partner', 
    'Win a 2on2 match without scoring a single goal',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "silent_win", "filters": {"gamemode": "2on2", "result": "win"}}',
    100,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Losing Streak
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'losing_streak_10', 
    'Persistence', 
    'Lose 10 matches in a row',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "loss", "min_streak": 10}}',
    50,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Undefeated Season
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'undefeated_season', 
    'Undefeated', 
    'Finish a season without losing a single match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "losses", "target": 0}',
    1000,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Miracle Comeback (0:9)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'miracle_comeback', 
    'Miracle Comeback', 
    'Win a match after being down 0:9',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "comeback", "target": 9, "filters": {"result": "win"}}',
    500,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Own Goal Hat Trick
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_hat_trick', 
    'Oops...', 
    'Score 3 own goals in a single match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "own_goals_in_match", "target": 3}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- META ACHIEVEMENTS
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'achievement_hunter_25', 
    'Achievement Hunter', 
    'Unlock 25 achievements',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievements_unlocked", "target": 25}',
    100,
    25,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'completionist', 
    'Completionist', 
    'Unlock all achievements',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "threshold", "metric": "all_achievements"}',
    1000,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'achievement_hunter_25')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- SEASON ACHIEVEMENTS
-- ============================================

-- Finish on podium (top 3) in 1on1 season
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'season_podium_1on1', 
    'On the Podium (1on1)', 
    'Finish a 1on1 season in the top 3',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_rank", "target": 3, "comparison": "lte", "filters": {"gamemode": "1on1"}}',
    200,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Finish on podium (top 3) in 2on2 season
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'season_podium_2on2', 
    'On the Podium (2on2)', 
    'Finish a 2on2 season in the top 3',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_rank", "target": 3, "comparison": "lte", "filters": {"gamemode": "2on2"}}',
    200,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Season Champion 1on1
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'season_champion_1on1', 
    'Season Champion (1on1)', 
    'Finish a 1on1 season in 1st place',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_rank", "target": 1, "filters": {"gamemode": "1on1"}}',
    500,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Season Champion 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'season_champion_2on2', 
    'Season Champion (2on2)', 
    'Finish a 2on2 season in 1st place',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_rank", "target": 1, "filters": {"gamemode": "2on2"}}',
    500,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- PLAYTIME ACHIEVEMENTS
-- ============================================

-- Play at least 1 hour in a day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'playtime_1h_day', 
    'Dedicated Player', 
    'Play at least 1 hour in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "playtime_in_day", "target": 3600}',
    75,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play at least 3 hours in a week
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'playtime_3h_week', 
    'Weekly Warrior', 
    'Play at least 3 hours within a week',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "playtime_in_week", "target": 10800}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- VICTORIES ACHIEVEMENTS
-- ============================================

-- Defeat 5 different players in 1on1
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'beat_5_different_players_1on1', 
    'Variety is Key', 
    'Defeat 5 different players in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "unique_opponents_defeated", "target": 5, "filters": {"gamemode": "1on1", "result": "win"}}',
    75,
    5,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Win with 5 different teammates in 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'win_5_different_teammates_2on2', 
    'Team Player', 
    'Win with 5 different teammates in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "unique_teammates_won_with", "target": 5, "filters": {"gamemode": "2on2", "result": "win"}}',
    75,
    5,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Win 5 matches in one day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'wins_5_in_day', 
    'Unstoppable Day', 
    'Win 5 matches in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "wins_in_day", "target": 5, "filters": {"result": "win"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Win a match 10-9
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'win_10_9', 
    'Nail Biter', 
    'Win a match with the score 10-9',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "close_win", "target": 1, "filters": {"result": "win", "final_score": "10-9"}}',
    75,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- MATCHES ACHIEVEMENTS
-- ============================================

-- Play 5 matches in one day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'matches_5_in_day', 
    'Marathon Session', 
    'Play 5 matches in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "matches_in_day", "target": 5}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play 5 1on1 matches in one day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'matches_5_1on1_in_day', 
    'Solo Grinder', 
    'Play 5 1on1 matches in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "matches_in_day", "target": 5, "filters": {"gamemode": "1on1"}}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play 5 2on2 matches in one day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'matches_5_2on2_in_day', 
    'Team Grinder', 
    'Play 5 2on2 matches in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "matches_in_day", "target": 5, "filters": {"gamemode": "2on2"}}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play 2 1on1 and 2 2on2 in one day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'matches_mixed_day', 
    'All-Rounder', 
    'Play at least 2 1on1 and 2 2on2 matches in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "compound", "conditions": [{"metric": "matches_in_day", "target": 2, "filters": {"gamemode": "1on1"}}, {"metric": "matches_in_day", "target": 2, "filters": {"gamemode": "2on2"}}]}',
    75,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- STREAKS ACHIEVEMENTS (Extensions to Hot Streak)
-- ============================================

-- Win 10 in a row 1on1 (chain from win_streak_5_1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'win_streak_10_1on1', 
    'On Fire (1on1)', 
    'Win 10 matches in a row in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "win", "min_streak": 10}, "filters": {"gamemode": "1on1"}}',
    200,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'win_streak_5_1on1')
) ON CONFLICT (key) DO NOTHING;

-- Win 15 in a row 1on1 (chain from win_streak_10_1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'win_streak_15_1on1', 
    'Unstoppable (1on1)', 
    'Win 15 matches in a row in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "win", "min_streak": 15}, "filters": {"gamemode": "1on1"}}',
    300,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'win_streak_10_1on1')
) ON CONFLICT (key) DO NOTHING;

-- Win 10 in a row 2on2 (chain from win_streak_5_2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'win_streak_10_2on2', 
    'On Fire (2on2)', 
    'Win 10 matches in a row in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "win", "min_streak": 10}, "filters": {"gamemode": "2on2"}}',
    200,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'win_streak_5_2on2')
) ON CONFLICT (key) DO NOTHING;

-- Win 15 in a row 2on2 (chain from win_streak_10_2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'win_streak_15_2on2', 
    'Unstoppable (2on2)', 
    'Win 15 matches in a row in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "win", "min_streak": 15}, "filters": {"gamemode": "2on2"}}',
    300,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'win_streak_10_2on2')
) ON CONFLICT (key) DO NOTHING;

-- Beat a player on a hot streak (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'streak_breaker_1on1', 
    'Streak Breaker (1on1)', 
    'Defeat a player who has a win streak of at least 5 in 1on1',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "broke_opponent_streak", "target": 5, "filters": {"gamemode": "1on1", "result": "win"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Beat a player on a hot streak (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'streak_breaker_2on2', 
    'Streak Breaker (2on2)', 
    'Defeat a player who has a win streak of at least 5 in 2on2',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "broke_opponent_streak", "target": 5, "filters": {"gamemode": "2on2", "result": "win"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- GOALS ACHIEVEMENTS
-- ============================================

-- Score 25 goals in a day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'goals_25_in_day', 
    'Sharpshooter', 
    'Score 25 goals in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "goals_in_day", "target": 25}',
    75,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score 42 goals in a day (chain from 25)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_42_in_day', 
    'Goal Machine', 
    'Score 42 goals in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "goals_in_day", "target": 42}',
    150,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_25_in_day')
) ON CONFLICT (key) DO NOTHING;

-- Score 50 goals in a day (chain from 42)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_50_in_day', 
    'Unstoppable Scorer', 
    'Score 50 goals in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "goals_in_day", "target": 50}',
    250,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_42_in_day')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- META ACHIEVEMENTS (Extensions to Achievement Hunter)
-- ============================================

-- Achievement Hunter 50 (chain from achievement_hunter_25)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'achievement_hunter_50', 
    'Achievement Collector', 
    'Unlock 50 achievements',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievements_unlocked", "target": 50}',
    200,
    50,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'achievement_hunter_25')
) ON CONFLICT (key) DO NOTHING;

-- Update completionist to be child of achievement_hunter_50
UPDATE kopecht.achievement_definitions 
SET parent_id = (SELECT id FROM kopecht.achievement_definitions WHERE key = 'achievement_hunter_50')
WHERE key = 'completionist';

-- Unlock 3 hidden achievements
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'secret_finder', 
    'Secret Finder', 
    'Unlock 5 hidden achievements',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "secret_achievements_unlocked", "target": 5}',
    150,
    5,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- TEAMWORK ACHIEVEMENTS
-- ============================================

-- Score exactly 5 goals in a 2on2 match and win (perfect 50/50 split)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'perfect_teamwork', 
    'Perfect Teamwork', 
    'Score exactly 5 goals in a 2on2 match where you win 10-X',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'teamwork'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "goals_in_match", "target": 5, "comparison": "eq", "filters": {"gamemode": "2on2", "result": "win", "team_score": 10}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score 9 goals in a 2on2 match and win
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'carry_9_goals', 
    'Heavy Lifter', 
    'Score 9 goals in a 2on2 match and win 10-X',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'teamwork'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "goals_in_match", "target": 9, "comparison": "eq", "filters": {"gamemode": "2on2", "result": "win", "team_score": 10}}',
    150,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- HIDDEN/SECRET ACHIEVEMENTS
-- ============================================

-- Score an own goal at 9-X (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_at_9_1on1', 
    'So Close... (1on1)', 
    'Score an own goal when you are at 9-X in a 1on1 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 9, "filters": {"gamemode": "1on1", "goal_type": "own_goal"}}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score an own goal at 9-X (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_at_9_2on2', 
    'So Close... (2on2)', 
    'Score an own goal when your team is at 9-X in a 2on2 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 9, "filters": {"gamemode": "2on2", "goal_type": "own_goal"}}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score an own goal at 1-X (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_at_1_1on1', 
    'Adding Insult to Injury (1on1)', 
    'Score an own goal when you are at 1-X in a 1on1 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 1, "filters": {"gamemode": "1on1", "goal_type": "own_goal"}}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score an own goal at 1-X (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_at_1_2on2', 
    'Adding Insult to Injury (2on2)', 
    'Score an own goal when your team is at 1-X in a 2on2 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 1, "filters": {"gamemode": "2on2", "goal_type": "own_goal"}}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Additional Achievements Migration (kopecht schema)
-- Run this in Supabase SQL Editor

-- ============================================
-- GOALS ACHIEVEMENTS - First Blood Series
-- ============================================

-- Score 10 first goals (1-0) in 1on1
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'first_blood_10_1on1', 
    'First Blood Initiate (1on1)', 
    'Score 10 opening goals (1-0) in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 10, "filters": {"gamemode": "1on1"}}',
    50,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score 25 first goals (1-0) in 1on1 (chain from 10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_25_1on1', 
    'First Blood Apprentice (1on1)', 
    'Score 25 opening goals (1-0) in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 25, "filters": {"gamemode": "1on1"}}',
    100,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_10_1on1')
) ON CONFLICT (key) DO NOTHING;

-- Score 100 first goals (1-0) in 1on1 (chain from 25)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_100_1on1', 
    'First Blood Expert (1on1)', 
    'Score 100 opening goals (1-0) in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 100, "filters": {"gamemode": "1on1"}}',
    200,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_25_1on1')
) ON CONFLICT (key) DO NOTHING;

-- Score 250 first goals (1-0) in 1on1 (chain from 100)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_250_1on1', 
    'First Blood Master (1on1)', 
    'Score 250 opening goals (1-0) in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 250, "filters": {"gamemode": "1on1"}}',
    350,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_100_1on1')
) ON CONFLICT (key) DO NOTHING;

-- Score 500 first goals (1-0) in 1on1 (chain from 250)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_500_1on1', 
    'First Blood Legend (1on1)', 
    'Score 500 opening goals (1-0) in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 500, "filters": {"gamemode": "1on1"}}',
    500,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_250_1on1')
) ON CONFLICT (key) DO NOTHING;

-- Score 10 first goals (1-0) in 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'first_blood_10_2on2', 
    'First Blood Initiate (2on2)', 
    'Score 10 opening goals (1-0) in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 10, "filters": {"gamemode": "2on2"}}',
    50,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score 25 first goals (1-0) in 2on2 (chain from 10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_25_2on2', 
    'First Blood Apprentice (2on2)', 
    'Score 25 opening goals (1-0) in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 25, "filters": {"gamemode": "2on2"}}',
    100,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_10_2on2')
) ON CONFLICT (key) DO NOTHING;

-- Score 100 first goals (1-0) in 2on2 (chain from 25)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_100_2on2', 
    'First Blood Expert (2on2)', 
    'Score 100 opening goals (1-0) in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 100, "filters": {"gamemode": "2on2"}}',
    200,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_25_2on2')
) ON CONFLICT (key) DO NOTHING;

-- Score 250 first goals (1-0) in 2on2 (chain from 100)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_250_2on2', 
    'First Blood Master (2on2)', 
    'Score 250 opening goals (1-0) in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 250, "filters": {"gamemode": "2on2"}}',
    350,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_100_2on2')
) ON CONFLICT (key) DO NOTHING;

-- Score 500 first goals (1-0) in 2on2 (chain from 250)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_500_2on2', 
    'First Blood Legend (2on2)', 
    'Score 500 opening goals (1-0) in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 500, "filters": {"gamemode": "2on2"}}',
    500,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_250_2on2')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- GOALS ACHIEVEMENTS - Own Goal Hidden
-- ============================================

-- Score an own goal at 0-0 (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_at_0_1on1', 
    'False Start (1on1)', 
    'Score an own goal when the score is 0-0 in a 1on1 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 0, "filters": {"gamemode": "1on1", "goal_type": "own_goal", "both_scores": 0}}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score an own goal at 0-0 (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_at_0_2on2', 
    'False Start (2on2)', 
    'Score an own goal when the score is 0-0 in a 2on2 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 0, "filters": {"gamemode": "2on2", "goal_type": "own_goal", "both_scores": 0}}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score 5 own goals in a day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goals_5_in_day', 
    'Wrong Direction Day', 
    'Score 5 own goals in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals_in_day", "target": 5, "filters": {"goal_type": "own_goal"}}',
    50,
    5,
    true,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- VICTORIES ACHIEVEMENTS - Perfect Games
-- ============================================

-- Win 5 matches 10-0
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'perfect_wins_5', 
    'Flawless Victory', 
    'Win 5 matches with the score 10-0',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "perfect_wins", "target": 5, "filters": {"result": "win", "final_score": "10-0"}}',
    150,
    5,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Win 10 matches 10-0 (chain from 5)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'perfect_wins_10', 
    'Domination Expert', 
    'Win 10 matches with the score 10-0',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "perfect_wins", "target": 10, "filters": {"result": "win", "final_score": "10-0"}}',
    300,
    10,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'perfect_wins_5')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- PLAYTIME ACHIEVEMENTS - Early Bird & Night Owl
-- ============================================

-- Play 1 match before 09:00
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'early_bird_1', 
    'Early Bird', 
    'Play a match before 09:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_before_time", "target": 1, "filters": {"time_before": "09:00"}}',
    25,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play 10 matches before 09:00 (chain from 1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'early_bird_10', 
    'Morning Enthusiast', 
    'Play 10 matches before 09:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_before_time", "target": 10, "filters": {"time_before": "09:00"}}',
    75,
    10,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'early_bird_1')
) ON CONFLICT (key) DO NOTHING;

-- Play 25 matches before 09:00 (chain from 10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'early_bird_25', 
    'Dawn Champion', 
    'Play 25 matches before 09:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_before_time", "target": 25, "filters": {"time_before": "09:00"}}',
    150,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'early_bird_10')
) ON CONFLICT (key) DO NOTHING;

-- Play 1 match after 17:00
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'night_owl_1', 
    'Evening Player', 
    'Play a match after 17:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_after_time", "target": 1, "filters": {"time_after": "17:00"}}',
    25,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play 10 matches after 17:00 (chain from 1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'night_owl_10', 
    'Night Owl', 
    'Play 10 matches after 17:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_after_time", "target": 10, "filters": {"time_after": "17:00"}}',
    75,
    10,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'night_owl_1')
) ON CONFLICT (key) DO NOTHING;

-- Play 25 matches after 17:00 (chain from 10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'night_owl_25', 
    'Twilight Master', 
    'Play 25 matches after 17:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_after_time", "target": 25, "filters": {"time_after": "17:00"}}',
    150,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'night_owl_10')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- MATCHES ACHIEVEMENTS - After Meeting Party
-- ============================================

-- Play 10 matches on Wednesday between 15:00 and 18:00
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'after_meeting_party_10', 
    'After Meeting Rookie', 
    'Play 10 matches on Wednesdays between 15:00 and 18:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_in_time_window", "target": 10, "filters": {"day_of_week": "wednesday", "time_after": "15:00", "time_before": "18:00"}}',
    75,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play 25 matches on Wednesday between 15:00 and 18:00 (chain from 10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'after_meeting_party_25', 
    'After Meeting Regular', 
    'Play 25 matches on Wednesdays between 15:00 and 18:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_in_time_window", "target": 25, "filters": {"day_of_week": "wednesday", "time_after": "15:00", "time_before": "18:00"}}',
    150,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'after_meeting_party_10')
) ON CONFLICT (key) DO NOTHING;

-- Play 50 matches on Wednesday between 15:00 and 18:00 (chain from 25)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'after_meeting_party_50', 
    'After Meeting Legend', 
    'Play 50 matches on Wednesdays between 15:00 and 18:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_in_time_window", "target": 50, "filters": {"day_of_week": "wednesday", "time_after": "15:00", "time_before": "18:00"}}',
    300,
    50,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'after_meeting_party_25')
) ON CONFLICT (key) DO NOTHING;


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 4: ENABLE REALTIME
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- Enable realtime for player_achievement_progress
ALTER PUBLICATION supabase_realtime ADD TABLE kopecht.player_achievement_progress;

-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 5: CREATE SQL WEBHOOKS (POSTGRESQL TRIGGER)
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 1. Sicherstellen, dass die pg_net Erweiterung aktiviert ist
create extension if not exists pg_net;

-- 2. Die universelle Trigger-Funktion fÃ¼r Achievements im Schema 'kopecht'
create or replace function kopecht.trigger_process_achievement()
returns trigger 
language plpgsql
security definer -- WICHTIG: LÃ¤uft mit Rechten des Erstellers (Admin)
set search_path = public, kopecht, extensions
as $$
declare
  -- KONFIGURATION
  -- URL deiner Edge Function
  endpoint_url text := 'https://dixhaxicjwqchhautpje.supabase.co/functions/v1/process-achievement';
  
  -- AUTHENTIFIZIERUNG
  -- Ersetze dies mit deinem 'service_role' secret aus dem Supabase Dashboard (Settings -> API)
  -- Dieser Key umgeht RLS und erlaubt den Zugriff auf die geschÃ¼tzte Function.
  service_role_key text := 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpeGhheGljandxY2hoYXV0cGplIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTY5ODQyODUwNSwiZXhwIjoyMDE0MDA0NTA1fQ.tzNZNw1M1NjFHuLFQ7CVkuBE4G9wcmypZBfWd3fiikc';
  
  -- Der Name des Webhooks wird als Argument Ã¼bergeben
  webhook_name text := TG_ARGV[0];
  
begin
  -- HTTP POST Request senden
  perform net.http_post(
      url := endpoint_url,
      headers := jsonb_build_object(
          'Content-Type', 'application/json',
          'Authorization', 'Bearer ' || service_role_key
      ),
      body := jsonb_build_object(
          'webhook_name', webhook_name, 
          'type', TG_OP,                -- INSERT oder UPDATE
          'table', TG_TABLE_NAME,       -- matches, goals, etc.
          'schema', TG_TABLE_SCHEMA,    -- kopecht
          'record', new,                
          'old_record', old             
      )
  );
  
  return new;
end;
$$;


-- 3. Definition der Trigger auf den Tabellen im 'kopecht' Schema

-- Webhook 1: on_achievement_unlocked_kopecht
drop trigger if exists "on_achievement_unlocked_kopecht" on kopecht.player_achievements;
create trigger "on_achievement_unlocked_kopecht"
after insert on kopecht.player_achievements
for each row
execute function kopecht.trigger_process_achievement('on_achievement_unlocked_kopecht');

-- Webhook 2: achievement-match-ended_kopecht
drop trigger if exists "achievement-match-ended_kopecht" on kopecht.matches;
create trigger "achievement-match-ended_kopecht"
after update on kopecht.matches
for each row
execute function kopecht.trigger_process_achievement('achievement-match-ended_kopecht');

-- Webhook 3: achievement-goal-scored_kopecht
drop trigger if exists "achievement-goal-scored_kopecht" on kopecht.goals;
create trigger "achievement-goal-scored_kopecht"
after insert on kopecht.goals
for each row
execute function kopecht.trigger_process_achievement('achievement-goal-scored_kopecht');

-- Webhook 4: achievement-season-ended_kopecht
drop trigger if exists "achievement-season-ended_kopecht" on kopecht.seasons;
create trigger "achievement-season-ended_kopecht"
after update on kopecht.seasons
for each row
execute function kopecht.trigger_process_achievement('achievement-season-ended_kopecht');

-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 6: ACHIEVEMENT UNLOCKED TRIGGER
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Migration: Create trigger for ACHIEVEMENT_UNLOCKED event
-- This triggers the process-achievement Edge Function when a player unlocks an achievement

-- Create the webhook trigger for player_achievements inserts
CREATE OR REPLACE FUNCTION kopecht.notify_achievement_unlocked()
RETURNS TRIGGER AS $$
DECLARE
    payload JSON;
BEGIN
    -- Build payload matching the webhook format
    payload := json_build_object(
        'type', 'INSERT',
        'table', 'player_achievements',
        'schema', 'kopecht',
        'record', row_to_json(NEW),
        'old_record', NULL
    );
    
    -- Call the Edge Function via pg_net (if available) or http extension
    -- Note: You may need to adjust this based on your Supabase setup
    PERFORM
        net.http_post(
            url := current_setting('app.settings.edge_function_url', true) || '/process-achievement',
            headers := jsonb_build_object(
                'Content-Type', 'application/json',
                'Authorization', 'Bearer ' || current_setting('app.settings.service_role_key', true)
            ),
            body := payload::jsonb
        );
    
    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        -- Log error but don't fail the insert
        RAISE WARNING 'Failed to notify achievement unlocked: %', SQLERRM;
        RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create the trigger
DROP TRIGGER IF EXISTS on_achievement_unlocked ON kopecht.player_achievements;
CREATE TRIGGER on_achievement_unlocked
    AFTER INSERT ON kopecht.player_achievements
    FOR EACH ROW
    EXECUTE FUNCTION kopecht.notify_achievement_unlocked();

-- Grant execute permission
GRANT EXECUTE ON FUNCTION kopecht.notify_achievement_unlocked() TO service_role;

COMMENT ON FUNCTION kopecht.notify_achievement_unlocked() IS 
    'Triggers the process-achievement Edge Function when a player unlocks an achievement';


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 7: SEASON SPECIFIC ACHIEVEMENTS
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Migration: Add season-specific achievement support
-- Schema: kopecht
-- This migration adds is_season_specific flag and season_id to progress table

SET search_path TO kopecht;

-- ============================================
-- 1. Add is_season_specific column to achievement_definitions
-- ============================================
ALTER TABLE kopecht.achievement_definitions 
ADD COLUMN IF NOT EXISTS is_season_specific BOOLEAN NOT NULL DEFAULT true;

-- ============================================
-- 2. Add season_id to player_achievement_progress
-- ============================================
ALTER TABLE kopecht.player_achievement_progress 
ADD COLUMN IF NOT EXISTS season_id BIGINT REFERENCES kopecht.seasons(id) ON DELETE SET NULL;

-- Drop old unique constraint and create new one with season_id
ALTER TABLE kopecht.player_achievement_progress 
DROP CONSTRAINT IF EXISTS player_achievement_progress_unique;

ALTER TABLE kopecht.player_achievement_progress 
ADD CONSTRAINT player_achievement_progress_unique 
UNIQUE (player_id, achievement_id, season_id);

-- Add index for season-based progress queries
CREATE INDEX IF NOT EXISTS idx_player_achievement_progress_season 
ON kopecht.player_achievement_progress(season_id);

-- ============================================
-- 3. Set is_season_specific = false for global achievements
-- Global achievements: Meta category, Season category
-- ============================================

-- Meta achievements are global (track all-time achievement count)
UPDATE kopecht.achievement_definitions 
SET is_season_specific = false 
WHERE category_id IN (
    SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'
);

-- Season achievements are global (podium, champion - they're inherently season-based but tracked globally)
UPDATE kopecht.achievement_definitions 
SET is_season_specific = false 
WHERE category_id IN (
    SELECT id FROM kopecht.achievement_categories WHERE key = 'season'
);

-- ============================================
-- 4. Create all-time (global) versions of key achievements
-- These have higher targets and track across all seasons
-- ============================================

-- Create 'alltime' category (global - no kicker_id)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('alltime', 'All-Time', 'Achievements that track your entire career across all seasons', 'ðŸŒŸ', 100)
ON CONFLICT (key) DO NOTHING;

-- ============================================
-- ALL-TIME MATCHES ACHIEVEMENTS
-- ============================================

-- 500 Matches All-Time (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'matches_500_alltime_1on1',
    'Veteran (1on1)',
    'Play 500 1on1 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 500, "filters": {"gamemode": "1on1"}}',
    300,
    500,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 1000 Matches All-Time (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'matches_1000_alltime_1on1',
    'Legend (1on1)',
    'Play 1000 1on1 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 1000, "filters": {"gamemode": "1on1"}}',
    500,
    1000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_500_alltime_1on1')
) ON CONFLICT (key) DO NOTHING;

-- 500 Matches All-Time (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'matches_500_alltime_2on2',
    'Veteran (2on2)',
    'Play 500 2on2 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 500, "filters": {"gamemode": "2on2"}}',
    300,
    500,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 1000 Matches All-Time (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'matches_1000_alltime_2on2',
    'Legend (2on2)',
    'Play 1000 2on2 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 1000, "filters": {"gamemode": "2on2"}}',
    500,
    1000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_500_alltime_2on2')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- ALL-TIME WINS ACHIEVEMENTS
-- ============================================

-- 500 Wins All-Time (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'wins_500_alltime_1on1',
    'Champion Soul (1on1)',
    'Win 500 1on1 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 500, "filters": {"gamemode": "1on1"}}',
    400,
    500,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 1000 Wins All-Time (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'wins_1000_alltime_1on1',
    'Immortal (1on1)',
    'Win 1000 1on1 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 1000, "filters": {"gamemode": "1on1"}}',
    750,
    1000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_500_alltime_1on1')
) ON CONFLICT (key) DO NOTHING;

-- 500 Wins All-Time (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'wins_500_alltime_2on2',
    'Champion Soul (2on2)',
    'Win 500 2on2 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 500, "filters": {"gamemode": "2on2"}}',
    400,
    500,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 1000 Wins All-Time (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'wins_1000_alltime_2on2',
    'Immortal (2on2)',
    'Win 1000 2on2 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 1000, "filters": {"gamemode": "2on2"}}',
    750,
    1000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_500_alltime_2on2')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- ALL-TIME GOALS ACHIEVEMENTS
-- ============================================

-- 1000 Goals All-Time
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'goals_1000_alltime',
    'Thousand Strikes',
    'Score 1000 goals across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 1000}',
    500,
    1000,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 2500 Goals All-Time
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'goals_2500_alltime',
    'Goal Machine',
    'Score 2500 goals across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 2500}',
    750,
    2500,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_1000_alltime')
) ON CONFLICT (key) DO NOTHING;

-- 5000 Goals All-Time
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'goals_5000_alltime',
    'Living Legend',
    'Score 5000 goals across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 5000}',
    1000,
    5000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_2500_alltime')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- ALL-TIME PLAYTIME ACHIEVEMENTS
-- ============================================

-- 100 Hours All-Time
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'playtime_100h_alltime',
    'Dedicated',
    'Play for 100 hours across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "playtime_seconds", "target": 360000}',
    400,
    360000,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 250 Hours All-Time
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'playtime_250h_alltime',
    'Obsessed',
    'Play for 250 hours across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "playtime_seconds", "target": 900000}',
    600,
    900000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'playtime_100h_alltime')
) ON CONFLICT (key) DO NOTHING;

-- 500 Hours All-Time
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'playtime_500h_alltime',
    'No Life',
    'Play for 500 hours across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'alltime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "playtime_seconds", "target": 1800000}',
    1000,
    1800000,
    true,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'playtime_250h_alltime')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- 5. Add index on matches.season_id for performance
-- ============================================
CREATE INDEX IF NOT EXISTS idx_matches_season_id ON kopecht.matches(season_id);




-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 8: FIX INCREMENT PROGRESS SEASON
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Fix increment_achievement_progress function to handle NULL season_id correctly
-- The previous ON CONFLICT clause doesn't work with NULL values in PostgreSQL
-- This update uses explicit SELECT + INSERT/UPDATE logic instead

-- Drop old function with kicker_id parameter (if exists) to avoid ambiguity
DROP FUNCTION IF EXISTS kopecht.increment_achievement_progress(BIGINT, BIGINT, BIGINT, INTEGER, BIGINT);

CREATE OR REPLACE FUNCTION kopecht.increment_achievement_progress(
    p_player_id BIGINT,
    p_achievement_id BIGINT,
    p_increment INTEGER DEFAULT 1,
    p_season_id BIGINT DEFAULT NULL
)
RETURNS TABLE (
    new_progress INTEGER,
    max_progress INTEGER,
    is_completed BOOLEAN
) AS $$
DECLARE
    v_max_progress INTEGER;
    v_new_progress INTEGER;
    v_current_progress INTEGER;
    v_is_completed BOOLEAN := FALSE;
    v_is_season_specific BOOLEAN;
    v_progress_season_id BIGINT;
    v_existing_id BIGINT;
BEGIN
    -- Get max_progress and is_season_specific from achievement definition (global - no kicker_id filter)
    SELECT ad.max_progress, COALESCE(ad.is_season_specific, true) 
    INTO v_max_progress, v_is_season_specific
    FROM kopecht.achievement_definitions ad
    WHERE ad.id = p_achievement_id;
    
    IF v_max_progress IS NULL THEN
        RAISE EXCEPTION 'Achievement not found: %', p_achievement_id;
    END IF;

    -- Determine the season_id for progress tracking
    -- Season-specific achievements use the provided season_id
    -- Global achievements (is_season_specific = false) use NULL
    IF v_is_season_specific THEN
        v_progress_season_id := p_season_id;
    ELSE
        v_progress_season_id := NULL;
    END IF;

    -- Check if progress record exists (handle NULL season_id explicitly)
    IF v_progress_season_id IS NULL THEN
        SELECT id, current_progress INTO v_existing_id, v_current_progress
        FROM kopecht.player_achievement_progress
        WHERE player_id = p_player_id 
          AND achievement_id = p_achievement_id
          AND season_id IS NULL
        FOR UPDATE;
    ELSE
        SELECT id, current_progress INTO v_existing_id, v_current_progress
        FROM kopecht.player_achievement_progress
        WHERE player_id = p_player_id 
          AND achievement_id = p_achievement_id
          AND season_id = v_progress_season_id
        FOR UPDATE;
    END IF;

    IF v_existing_id IS NOT NULL THEN
        -- Update existing record
        v_new_progress := LEAST(v_current_progress + p_increment, v_max_progress);
        
        UPDATE kopecht.player_achievement_progress
        SET current_progress = v_new_progress,
            updated_at = NOW()
        WHERE id = v_existing_id;
    ELSE
        -- Insert new record
        v_new_progress := LEAST(p_increment, v_max_progress);
        
        INSERT INTO kopecht.player_achievement_progress (
            player_id, 
            achievement_id, 
            current_progress,
            season_id,
            updated_at
        )
        VALUES (
            p_player_id, 
            p_achievement_id, 
            v_new_progress,
            v_progress_season_id,
            NOW()
        );
    END IF;

    -- Check if achievement is now completed
    IF v_new_progress >= v_max_progress THEN
        -- Try to award the achievement
        -- Use explicit check for NULL season_id
        IF p_season_id IS NULL THEN
            -- Check if achievement already awarded (for all-time achievements)
            IF NOT EXISTS (
                SELECT 1 FROM kopecht.player_achievements
                WHERE player_id = p_player_id 
                  AND achievement_id = p_achievement_id
                  AND season_id IS NULL
            ) THEN
                INSERT INTO kopecht.player_achievements (
                    player_id, 
                    achievement_id, 
                    unlocked_at,
                    season_id
                )
                VALUES (
                    p_player_id, 
                    p_achievement_id, 
                    NOW(),
                    NULL
                );
                v_is_completed := TRUE;
            END IF;
        ELSE
            -- Check if achievement already awarded for this season
            IF NOT EXISTS (
                SELECT 1 FROM kopecht.player_achievements
                WHERE player_id = p_player_id 
                  AND achievement_id = p_achievement_id
                  AND season_id = p_season_id
            ) THEN
                INSERT INTO kopecht.player_achievements (
                    player_id, 
                    achievement_id, 
                    unlocked_at,
                    season_id
                )
                VALUES (
                    p_player_id, 
                    p_achievement_id, 
                    NOW(),
                    p_season_id
                );
                v_is_completed := TRUE;
            END IF;
        END IF;
    END IF;

    RETURN QUERY SELECT v_new_progress, v_max_progress, v_is_completed;
END;
$$ LANGUAGE plpgsql;

-- Grant execute permission
GRANT EXECUTE ON FUNCTION kopecht.increment_achievement_progress TO authenticated;
GRANT EXECUTE ON FUNCTION kopecht.increment_achievement_progress TO service_role;



-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 9: FIX PROGRESS UNIQUE CONSTRAINT
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- Fix unique constraint for player_achievement_progress to handle NULL season_id correctly
-- PostgreSQL doesn't consider NULL = NULL, so we need two partial indexes

-- First, clean up any existing duplicate rows where season_id IS NULL
-- Keep the row with the highest current_progress (or most recent updated_at if tied)
DELETE FROM kopecht.player_achievement_progress a
USING kopecht.player_achievement_progress b
WHERE a.season_id IS NULL
  AND b.season_id IS NULL
  AND a.player_id = b.player_id
  AND a.achievement_id = b.achievement_id
  AND a.id < b.id
  AND (a.current_progress < b.current_progress 
       OR (a.current_progress = b.current_progress AND a.updated_at < b.updated_at)
       OR (a.current_progress = b.current_progress AND a.updated_at = b.updated_at));

-- Also handle the case where we keep the one with higher progress even if it has lower id
DELETE FROM kopecht.player_achievement_progress a
USING kopecht.player_achievement_progress b
WHERE a.season_id IS NULL
  AND b.season_id IS NULL
  AND a.player_id = b.player_id
  AND a.achievement_id = b.achievement_id
  AND a.id > b.id
  AND (a.current_progress < b.current_progress 
       OR (a.current_progress = b.current_progress AND a.updated_at < b.updated_at));

-- Drop the existing unique constraint
ALTER TABLE kopecht.player_achievement_progress 
DROP CONSTRAINT IF EXISTS player_achievement_progress_unique;

-- Create partial unique index for rows WITH season_id
CREATE UNIQUE INDEX IF NOT EXISTS idx_player_achievement_progress_unique_with_season 
ON kopecht.player_achievement_progress (player_id, achievement_id, season_id) 
WHERE season_id IS NOT NULL;

-- Create partial unique index for rows WITHOUT season_id (all-time achievements)
CREATE UNIQUE INDEX IF NOT EXISTS idx_player_achievement_progress_unique_no_season 
ON kopecht.player_achievement_progress (player_id, achievement_id) 
WHERE season_id IS NULL;


-- ============================================
-- OWN GOALS ACHIEVEMENTS - Season-Specific Chain (10/25/50/100)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'own_goals_season_10', 
    'Butterfingers (Season)', 
    'Score 10 own goals in a season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 10, "filters": {"goal_type": "own_goal"}}',
    25,
    10,
    true,
    false,
    true
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'own_goals_season_25', 
    'Wrong Way Warrior (Season)', 
    'Score 25 own goals in a season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 25, "filters": {"goal_type": "own_goal"}}',
    50,
    25,
    true,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'own_goals_season_10')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'own_goals_season_50', 
    'Self-Saboteur (Season)', 
    'Score 50 own goals in a season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 50, "filters": {"goal_type": "own_goal"}}',
    100,
    50,
    true,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'own_goals_season_25')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'own_goals_season_100', 
    'Own Goal Legend (Season)', 
    'Score 100 own goals in a season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 100, "filters": {"goal_type": "own_goal"}}',
    200,
    100,
    true,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'own_goals_season_50')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- OWN GOALS ACHIEVEMENTS - All-Time Chain (50/100/250/500)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'own_goals_alltime_50', 
    'Career Butterfingers', 
    'Score 50 own goals across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 50, "filters": {"goal_type": "own_goal"}}',
    50,
    50,
    true,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'own_goals_alltime_100', 
    'Wrong Way Veteran', 
    'Score 100 own goals across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 100, "filters": {"goal_type": "own_goal"}}',
    100,
    100,
    true,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'own_goals_alltime_50')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'own_goals_alltime_250', 
    'Self-Destruction Expert', 
    'Score 250 own goals across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 250, "filters": {"goal_type": "own_goal"}}',
    200,
    250,
    true,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'own_goals_alltime_100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'own_goals_alltime_500', 
    'The Anti-Striker', 
    'Score 500 own goals across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 500, "filters": {"goal_type": "own_goal"}}',
    500,
    500,
    true,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'own_goals_alltime_250')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- LOW MMR ACHIEVEMENTS - Season-Specific (below 700)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'mmr_below_700_1on1', 
    'Rock Bottom (1on1)', 
    'Drop below 700 MMR in 1on1 during a season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr_below", "target": 700, "filters": {"gamemode": "1on1"}}',
    10,
    1,
    true,
    false,
    true
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'mmr_below_700_2on2', 
    'Rock Bottom (2on2)', 
    'Drop below 700 MMR in 2on2 during a season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr_below", "target": 700, "filters": {"gamemode": "2on2"}}',
    10,
    1,
    true,
    false,
    true
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- FINAL NAIL IN COFFIN - Own goal at 1-9 to make it 0-9
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'final_nail_1on1', 
    'Final Nail (1on1)', 
    'Score an own goal when losing 1-9 to make it 0-9',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 1, "filters": {"gamemode": "1on1", "goal_type": "own_goal", "opponent_score": 9}}',
    50,
    1,
    true,
    false,
    true
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'final_nail_2on2', 
    'Final Nail (2on2)', 
    'Score an own goal when losing 1-9 to make it 0-9',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 1, "filters": {"gamemode": "2on2", "goal_type": "own_goal", "opponent_score": 9}}',
    50,
    1,
    true,
    false,
    true
) ON CONFLICT (key) DO NOTHING;

-- Migration: Create rewards system tables
-- Schema: kopecht

-- ============================================
-- REWARD DEFINITIONS TABLE
-- Stores all available rewards that can be unlocked via achievements
-- ============================================
CREATE TABLE IF NOT EXISTS kopecht.reward_definitions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    key TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    description TEXT,
    type TEXT NOT NULL CHECK (type IN ('title', 'frame', 'right')),
    -- For titles: 'prefix' means "Title Name", 'suffix' means "Name, Title"
    display_position TEXT CHECK (display_position IN ('prefix', 'suffix')),
    -- The actual value: title text, frame URL, or right identifier
    display_value TEXT NOT NULL,
    -- Achievement that unlocks this reward (NULL = unlocked by default or other means)
    achievement_key TEXT REFERENCES kopecht.achievement_definitions(key),
    icon TEXT,
    sort_order INT NOT NULL DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================
-- PLAYER SELECTED REWARDS TABLE
-- Stores each player's currently active reward per type
-- ============================================
CREATE TABLE IF NOT EXISTS kopecht.player_selected_rewards (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    player_id BIGINT NOT NULL REFERENCES kopecht.player(id) ON DELETE CASCADE,
    reward_type TEXT NOT NULL CHECK (reward_type IN ('title', 'frame')),
    reward_id BIGINT REFERENCES kopecht.reward_definitions(id) ON DELETE SET NULL,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT player_selected_rewards_unique UNIQUE (player_id, reward_type)
);

-- ============================================
-- INDEXES
-- ============================================
CREATE INDEX IF NOT EXISTS idx_reward_definitions_type ON kopecht.reward_definitions(type);
CREATE INDEX IF NOT EXISTS idx_reward_definitions_achievement ON kopecht.reward_definitions(achievement_key);
CREATE INDEX IF NOT EXISTS idx_player_selected_rewards_player ON kopecht.player_selected_rewards(player_id);

-- ============================================
-- RLS POLICIES
-- ============================================
ALTER TABLE kopecht.reward_definitions ENABLE ROW LEVEL SECURITY;
ALTER TABLE kopecht.player_selected_rewards ENABLE ROW LEVEL SECURITY;

-- Reward definitions: Everyone can read
CREATE POLICY "reward_definitions_select_policy" ON kopecht.reward_definitions
    FOR SELECT USING (true);

-- Reward definitions: Only super admin can insert/update/delete
CREATE POLICY "reward_definitions_insert_policy" ON kopecht.reward_definitions
    FOR INSERT WITH CHECK (auth.uid() = 'caeedd2f-5809-41ff-8a79-0c4c64836d2b'::uuid);

CREATE POLICY "reward_definitions_update_policy" ON kopecht.reward_definitions
    FOR UPDATE USING (auth.uid() = 'caeedd2f-5809-41ff-8a79-0c4c64836d2b'::uuid);

CREATE POLICY "reward_definitions_delete_policy" ON kopecht.reward_definitions
    FOR DELETE USING (auth.uid() = 'caeedd2f-5809-41ff-8a79-0c4c64836d2b'::uuid);

-- Player selected rewards: Players can manage their own selections
CREATE POLICY "player_selected_rewards_select_policy" ON kopecht.player_selected_rewards
    FOR SELECT USING (true);

CREATE POLICY "player_selected_rewards_insert_policy" ON kopecht.player_selected_rewards
    FOR INSERT WITH CHECK (
        player_id IN (SELECT id FROM kopecht.player WHERE user_id = auth.uid())
    );

CREATE POLICY "player_selected_rewards_update_policy" ON kopecht.player_selected_rewards
    FOR UPDATE USING (
        player_id IN (SELECT id FROM kopecht.player WHERE user_id = auth.uid())
    );

CREATE POLICY "player_selected_rewards_delete_policy" ON kopecht.player_selected_rewards
    FOR DELETE USING (
        player_id IN (SELECT id FROM kopecht.player WHERE user_id = auth.uid())
    );

-- ============================================
-- RPC: Get player with rewards
-- Returns player data along with their selected title and frame
-- ============================================
CREATE OR REPLACE FUNCTION kopecht.get_player_with_rewards(p_player_id BIGINT)
RETURNS TABLE (
    player_id BIGINT,
    player_name TEXT,
    avatar TEXT,
    title_id BIGINT,
    title_name TEXT,
    title_display_position TEXT,
    title_display_value TEXT,
    frame_id BIGINT,
    frame_name TEXT,
    frame_display_value TEXT
) 
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        p.id AS player_id,
        p.name AS player_name,
        p.avatar,
        t.id AS title_id,
        t.name AS title_name,
        t.display_position AS title_display_position,
        t.display_value AS title_display_value,
        f.id AS frame_id,
        f.name AS frame_name,
        f.display_value AS frame_display_value
    FROM kopecht.player p
    LEFT JOIN kopecht.player_selected_rewards psr_title 
        ON p.id = psr_title.player_id AND psr_title.reward_type = 'title'
    LEFT JOIN kopecht.reward_definitions t 
        ON psr_title.reward_id = t.id
    LEFT JOIN kopecht.player_selected_rewards psr_frame 
        ON p.id = psr_frame.player_id AND psr_frame.reward_type = 'frame'
    LEFT JOIN kopecht.reward_definitions f 
        ON psr_frame.reward_id = f.id
    WHERE p.id = p_player_id;
END;
$$;

-- ============================================
-- RPC: Get unlocked rewards for a player
-- Returns all rewards the player has unlocked (via achievements)
-- ============================================
CREATE OR REPLACE FUNCTION kopecht.get_player_unlocked_rewards(p_player_id BIGINT)
RETURNS TABLE (
    reward_id BIGINT,
    reward_key TEXT,
    reward_name TEXT,
    reward_description TEXT,
    reward_type TEXT,
    display_position TEXT,
    display_value TEXT,
    icon TEXT,
    achievement_key TEXT,
    achievement_name TEXT,
    is_selected BOOLEAN
) 
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        rd.id AS reward_id,
        rd.key AS reward_key,
        rd.name AS reward_name,
        rd.description AS reward_description,
        rd.type AS reward_type,
        rd.display_position,
        rd.display_value,
        rd.icon,
        rd.achievement_key,
        ad.name AS achievement_name,
        CASE WHEN psr.id IS NOT NULL THEN true ELSE false END AS is_selected
    FROM kopecht.reward_definitions rd
    -- Join to get the achievement definition name
    LEFT JOIN kopecht.achievement_definitions ad ON rd.achievement_key = ad.key
    -- Check if this reward is currently selected
    LEFT JOIN kopecht.player_selected_rewards psr 
        ON psr.player_id = p_player_id 
        AND psr.reward_id = rd.id 
        AND psr.reward_type = rd.type
    WHERE 
        -- Reward has no achievement requirement (always unlocked)
        rd.achievement_key IS NULL
        OR
        -- Player has unlocked the achievement
        EXISTS (
            SELECT 1 
            FROM kopecht.player_achievements pa
            JOIN kopecht.achievement_definitions ad2 ON pa.achievement_id = ad2.id
            WHERE pa.player_id = p_player_id 
            AND ad2.key = rd.achievement_key
        )
    ORDER BY rd.type, rd.sort_order;
END;
$$;

-- ============================================
-- RPC: Update player selected reward
-- ============================================
CREATE OR REPLACE FUNCTION kopecht.update_player_selected_reward(
    p_player_id BIGINT,
    p_reward_type TEXT,
    p_reward_id BIGINT DEFAULT NULL
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_user_id UUID;
BEGIN
    -- Get the user_id for the player
    SELECT user_id INTO v_user_id FROM kopecht.player WHERE id = p_player_id;
    
    -- Check if the current user owns this player
    IF v_user_id != auth.uid() THEN
        RAISE EXCEPTION 'Not authorized to update rewards for this player';
    END IF;

    -- If reward_id is NULL, remove the selection
    IF p_reward_id IS NULL THEN
        DELETE FROM kopecht.player_selected_rewards
        WHERE player_id = p_player_id AND reward_type = p_reward_type;
    ELSE
        -- Verify the player has unlocked this reward
        IF NOT EXISTS (
            SELECT 1 FROM kopecht.reward_definitions rd
            WHERE rd.id = p_reward_id
            AND (
                rd.achievement_key IS NULL
                OR EXISTS (
                    SELECT 1 
                    FROM kopecht.player_achievements pa
                    JOIN kopecht.achievement_definitions ad ON pa.achievement_id = ad.id
                    WHERE pa.player_id = p_player_id 
                    AND ad.key = rd.achievement_key
                )
            )
        ) THEN
            RAISE EXCEPTION 'Reward not unlocked';
        END IF;

        -- Upsert the selection
        INSERT INTO kopecht.player_selected_rewards (player_id, reward_type, reward_id, updated_at)
        VALUES (p_player_id, p_reward_type, p_reward_id, NOW())
        ON CONFLICT (player_id, reward_type) 
        DO UPDATE SET reward_id = p_reward_id, updated_at = NOW();
    END IF;

    RETURN true;
END;
$$;

-- ============================================
-- INITIAL REWARD DATA
-- Example titles linked to achievements
-- ============================================

-- Titles
INSERT INTO kopecht.reward_definitions (key, name, description, type, display_position, display_value, achievement_key, icon, sort_order) VALUES
-- Carry achievement unlocks "Carry" title
('title_carry', 'Carry', 'Show everyone you carry the team', 'title', 'prefix', 'Carry', 'carry_2on2', 'ðŸ’ª', 10),

-- Giant Slayer achievement unlocks title
('title_giant_slayer', 'Giant Slayer', 'Display your prowess against stronger opponents', 'title', 'suffix', 'the Giant Slayer', 'giant_slayer_1on1', 'âš”ï¸', 20),

-- Win streak achievements
('title_unstoppable', 'Unstoppable', 'For those on an incredible winning streak', 'title', 'prefix', 'Unstoppable', 'win_streak_10_1on1', 'ðŸ”¥', 30),

-- Perfect games
('title_perfectionist', 'Perfectionist', 'For achieving perfect victories', 'title', 'suffix', 'the Perfectionist', 'perfect_wins_10', 'âœ¨', 40),

-- Speed demon - blitzkrieg is the fast win achievement
('title_speedster', 'Speedster', 'For lightning-fast victories', 'title', 'prefix', 'Speedster', 'blitzkrieg_1on1', 'âš¡', 50),

-- Comeback king
('title_comeback_king', 'Comeback King', 'For those who never give up', 'title', 'suffix', 'the Comeback King', 'miracle_comeback', 'ðŸ‘‘', 60),

-- Veteran title
('title_veteran', 'Veteran', 'For experienced players', 'title', 'prefix', 'Veteran', 'matches_1on1_100', 'ðŸŽ–ï¸', 70),

-- Champion
('title_champion', 'Champion', 'For season champions', 'title', 'suffix', 'the Champion', 'season_champion_1on1', 'ðŸ†', 80),

-- Secret achievements - own goal specialist
('title_own_goal_master', 'Own Goal Specialist', 'Embrace your unique playstyle', 'title', 'suffix', 'the Own Goal Specialist', 'own_goals_alltime_100', 'ðŸ™ƒ', 90),

-- MMR Below 700 - for the meme
('title_underdog', 'Underdog', 'Started from the bottom', 'title', 'prefix', 'Underdog', 'mmr_below_700_1on1', 'ðŸ¢', 100),

-- Final nail - scoring own goal at 1-9
('title_final_nail', 'Final Nail', 'Master of unfortunate timing', 'title', 'suffix', 'the Final Nail', 'final_nail_1on1', 'âš°ï¸', 110)

ON CONFLICT (key) DO NOTHING;

-- Grant execute permissions
GRANT EXECUTE ON FUNCTION kopecht.get_player_with_rewards(BIGINT) TO authenticated;
GRANT EXECUTE ON FUNCTION kopecht.get_player_unlocked_rewards(BIGINT) TO authenticated;
GRANT EXECUTE ON FUNCTION kopecht.update_player_selected_reward(BIGINT, TEXT, BIGINT) TO authenticated;
