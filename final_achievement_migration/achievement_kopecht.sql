-- Migration: Create Achievement System Tables
-- Schema: kopecht


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 1: Create Tables
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
SET search_path TO kopecht;

-- 1. Achievement Categories (global - shared across all kickers)
CREATE TABLE IF NOT EXISTS kopecht.achievement_categories (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    key TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    description TEXT,
    icon TEXT,
    sort_order INT NOT NULL DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 2. Achievement Definitions (global - shared across all kickers)
CREATE TABLE IF NOT EXISTS kopecht.achievement_definitions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    key TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    description TEXT NOT NULL,
    category_id BIGINT NOT NULL REFERENCES kopecht.achievement_categories(id) ON DELETE CASCADE,
    trigger_event TEXT NOT NULL, -- 'MATCH_ENDED', 'GOAL_SCORED', 'SEASON_ENDED'
    condition JSONB NOT NULL DEFAULT '{}',
    points INT NOT NULL DEFAULT 10,
    icon TEXT,
    is_hidden BOOLEAN NOT NULL DEFAULT FALSE,
    is_repeatable BOOLEAN NOT NULL DEFAULT FALSE,
    max_progress INT NOT NULL DEFAULT 1,
    season_id BIGINT REFERENCES kopecht.seasons(id) ON DELETE SET NULL,
    parent_id BIGINT REFERENCES kopecht.achievement_definitions(id) ON DELETE SET NULL,
    sort_order INT NOT NULL DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 3. Player Achievement Progress (for tracking progress towards achievements)
CREATE TABLE IF NOT EXISTS kopecht.player_achievement_progress (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    player_id BIGINT NOT NULL REFERENCES kopecht.player(id) ON DELETE CASCADE,
    achievement_id BIGINT NOT NULL REFERENCES kopecht.achievement_definitions(id) ON DELETE CASCADE,
    current_progress INT NOT NULL DEFAULT 0,
    season_id BIGINT REFERENCES kopecht.seasons(id) ON DELETE SET NULL,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    -- season_id = NULL for global achievements, season_id = X for season-specific
    CONSTRAINT player_achievement_progress_unique UNIQUE (player_id, achievement_id, season_id)
);

-- 4. Player Achievements (unlocked achievements)
CREATE TABLE IF NOT EXISTS kopecht.player_achievements (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    player_id BIGINT NOT NULL REFERENCES kopecht.player(id) ON DELETE CASCADE,
    achievement_id BIGINT NOT NULL REFERENCES kopecht.achievement_definitions(id) ON DELETE CASCADE,
    unlocked_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    times_completed INT NOT NULL DEFAULT 1,
    season_id BIGINT REFERENCES kopecht.seasons(id) ON DELETE SET NULL,
    match_id BIGINT REFERENCES kopecht.matches(id) ON DELETE SET NULL,
    CONSTRAINT player_achievements_unique UNIQUE (player_id, achievement_id, season_id)
);

-- Indexes for performance
CREATE INDEX IF NOT EXISTS idx_achievement_definitions_trigger ON kopecht.achievement_definitions(trigger_event);
CREATE INDEX IF NOT EXISTS idx_achievement_definitions_category ON kopecht.achievement_definitions(category_id);
CREATE INDEX IF NOT EXISTS idx_achievement_definitions_parent ON kopecht.achievement_definitions(parent_id);
CREATE INDEX IF NOT EXISTS idx_achievement_definitions_season ON kopecht.achievement_definitions(season_id);
CREATE INDEX IF NOT EXISTS idx_player_achievement_progress_player ON kopecht.player_achievement_progress(player_id);
CREATE INDEX IF NOT EXISTS idx_player_achievement_progress_achievement ON kopecht.player_achievement_progress(achievement_id);
CREATE INDEX IF NOT EXISTS idx_player_achievement_progress_season ON kopecht.player_achievement_progress(season_id);
CREATE INDEX IF NOT EXISTS idx_player_achievements_player ON kopecht.player_achievements(player_id);
CREATE INDEX IF NOT EXISTS idx_player_achievements_achievement ON kopecht.player_achievements(achievement_id);
CREATE INDEX IF NOT EXISTS idx_player_achievements_season ON kopecht.player_achievements(season_id);
CREATE INDEX IF NOT EXISTS idx_player_achievements_unlocked ON kopecht.player_achievements(unlocked_at DESC);

-- Enable Row Level Security
ALTER TABLE kopecht.achievement_categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE kopecht.achievement_definitions ENABLE ROW LEVEL SECURITY;
ALTER TABLE kopecht.player_achievement_progress ENABLE ROW LEVEL SECURITY;
ALTER TABLE kopecht.player_achievements ENABLE ROW LEVEL SECURITY;

-- RLS Policies for achievement_categories (global - all authenticated users can view, only super admin can manage)
CREATE POLICY "Authenticated users can view achievement categories"
    ON kopecht.achievement_categories FOR SELECT
    USING (auth.role() = 'authenticated');

CREATE POLICY "Super admin can manage achievement categories"
    ON kopecht.achievement_categories FOR ALL
    USING (auth.uid() = 'caeedd2f-5809-41ff-8a79-0c4c64836d2b'::uuid);

CREATE POLICY "Service role can manage achievement categories"
    ON kopecht.achievement_categories FOR ALL
    USING (auth.role() = 'service_role');

-- RLS Policies for achievement_definitions (global - users can view non-hidden or unlocked, only super admin can manage)
CREATE POLICY "Authenticated users can view achievement definitions"
    ON kopecht.achievement_definitions FOR SELECT
    USING (
        auth.role() = 'authenticated'
        AND (
            is_hidden = FALSE
            OR EXISTS (
                SELECT 1 FROM kopecht.player_achievements pa
                JOIN kopecht.player p ON pa.player_id = p.id
                WHERE pa.achievement_id = achievement_definitions.id
                AND p.user_id = auth.uid()
            )
        )
    );

CREATE POLICY "Super admin can manage achievement definitions"
    ON kopecht.achievement_definitions FOR ALL
    USING (auth.uid() = 'caeedd2f-5809-41ff-8a79-0c4c64836d2b'::uuid);

CREATE POLICY "Service role can manage achievement definitions"
    ON kopecht.achievement_definitions FOR ALL
    USING (auth.role() = 'service_role');

-- RLS Policies for player_achievement_progress
CREATE POLICY "Users can view their own achievement progress"
    ON kopecht.player_achievement_progress FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM kopecht.player p
            WHERE p.id = player_achievement_progress.player_id
            AND p.user_id = auth.uid()
        )
    );

CREATE POLICY "Service role can manage all progress"
    ON kopecht.player_achievement_progress FOR ALL
    USING (auth.role() = 'service_role');

-- RLS Policies for player_achievements
CREATE POLICY "Users can view achievements for players in their kickers"
    ON kopecht.player_achievements FOR SELECT
    USING (
        EXISTS (
            SELECT 1 FROM kopecht.player p
            JOIN kopecht.player p2 ON p.kicker_id = p2.kicker_id
            WHERE p2.id = player_achievements.player_id
            AND p.user_id = auth.uid()
        )
    );

CREATE POLICY "Service role can manage all achievements"
    ON kopecht.player_achievements FOR ALL
    USING (auth.role() = 'service_role');

-- Function to update achievement_definitions updated_at
CREATE OR REPLACE FUNCTION kopecht.update_achievement_definition_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger for updated_at
CREATE TRIGGER update_achievement_definitions_updated_at
    BEFORE UPDATE ON kopecht.achievement_definitions
    FOR EACH ROW
    EXECUTE FUNCTION kopecht.update_achievement_definition_updated_at();

-- Function to update player_achievement_progress updated_at
CREATE OR REPLACE FUNCTION kopecht.update_achievement_progress_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger for progress updated_at
CREATE TRIGGER update_player_achievement_progress_updated_at
    BEFORE UPDATE ON kopecht.player_achievement_progress
    FOR EACH ROW
    EXECUTE FUNCTION kopecht.update_achievement_progress_updated_at();

-- Enable realtime for player_achievements (for toast notifications)
ALTER PUBLICATION supabase_realtime ADD TABLE kopecht.player_achievements;




-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 2: INSERT CATEGORIES
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Create Goals Category
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('goals', 'Goals', 'Achievements for scoring goals', 'âš½', 1)
ON CONFLICT (key) DO NOTHING;

-- Speed Category (for time-based achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('speed', 'Speed', 'Achievements for fast plays', 'âš¡', 2)
ON CONFLICT (key) DO NOTHING;

-- Matches Category (for match count achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('matches', 'Matches', 'Achievements for playing matches', 'ðŸŽ®', 3)
ON CONFLICT (key) DO NOTHING;

-- Wins Category (for winning achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('wins', 'Victories', 'Achievements for winning matches', 'ðŸ†', 4)
ON CONFLICT (key) DO NOTHING;

-- Skill Category (for skill-based achievements like MMR)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('skill', 'Skill', 'Achievements for skill milestones', 'ðŸ“ˆ', 5)
ON CONFLICT (key) DO NOTHING;

-- Comeback Category (for comeback achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('comeback', 'Comebacks', 'Achievements for epic comebacks', 'ðŸ”¥', 6)
ON CONFLICT (key) DO NOTHING;

-- Playtime Category (for time played achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('playtime', 'Playtime', 'Achievements for time played', 'â±ï¸', 7)
ON CONFLICT (key) DO NOTHING;

-- Teamwork Category (for 2on2 specific achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('teamwork', 'Teamwork', 'Achievements for team play', 'ðŸ¤', 8)
ON CONFLICT (key) DO NOTHING;

-- Streaks Category (for streak achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('streaks', 'Streaks', 'Achievements for win/loss streaks', 'ðŸ”—', 9)
ON CONFLICT (key) DO NOTHING;

-- Season Category (for season achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('season', 'Season', 'Seasonal achievements', 'ðŸ…', 10)
ON CONFLICT (key) DO NOTHING;

-- Meta Category (for meta achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('meta', 'Meta', 'Achievements about achievements', 'ðŸŽ¯', 11)
ON CONFLICT (key) DO NOTHING;

-- Secret Category (for hidden/joke achievements)
INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
VALUES ('secret', 'Secret', 'Secret achievements', 'ðŸ”®', 99)
ON CONFLICT (key) DO NOTHING;


-- ============================================
-- PRE-REQUISITE: Add is_season_specific column before inserting achievements that use it
-- ============================================
ALTER TABLE kopecht.achievement_definitions 
ADD COLUMN IF NOT EXISTS is_season_specific BOOLEAN NOT NULL DEFAULT true;


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 3: INSERT ACHIEVEMENTS
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- ============================================
-- 1ON1 GOAL ACHIEVEMENTS - SEASON-SPECIFIC (10/50/100/250)
-- These reset each season and track progress within the current season
-- ============================================

-- Bambini - 10 goals in 1on1 (season-specific)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'goals_1on1_10', 
    'Bambini', 
    'Score 10 goals in 1on1 matches this season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 10, "filters": {"gamemode": "1on1"}}',
    50,
    10,
    false,
    false,
    true
);

-- Striker - 50 goals in 1on1 (season-specific, chain from goals_1on1_10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'goals_1on1_50', 
    'Striker', 
    'Score 50 goals in 1on1 matches this season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 50, "filters": {"gamemode": "1on1"}}',
    75,
    50,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_1on1_10')
);

-- Tryharder - 100 goals in 1on1 (season-specific, chain from goals_1on1_50)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'goals_1on1_100', 
    'Tryharder', 
    'Score 100 goals in 1on1 matches this season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 100, "filters": {"gamemode": "1on1"}}',
    100,
    100,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_1on1_50')
);

-- Sniper - 250 goals in 1on1 (season-specific, chain from goals_1on1_100)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'goals_1on1_250', 
    'Sniper', 
    'Score 250 goals in 1on1 matches this season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 250, "filters": {"gamemode": "1on1"}}',
    150,
    250,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_1on1_100')
);

-- ============================================
-- 1ON1 GOAL ACHIEVEMENTS - CROSS-SEASON / ALL-TIME (500/1000/2500/5000)
-- These track progress across all seasons
-- ============================================

-- Goal Machine - 500 goals in 1on1 all-time (cross-season, independent chain)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'goals_1on1_alltime_500', 
    'Goal Machine', 
    'Score 500 goals in 1on1 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 500, "filters": {"gamemode": "1on1"}}',
    250,
    500,
    false,
    false,
    false
);

-- Solo Legend - 1000 goals in 1on1 all-time (cross-season, chain from goals_1on1_alltime_500)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'goals_1on1_alltime_1000', 
    'Solo Legend', 
    'Score 1000 goals in 1on1 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 1000, "filters": {"gamemode": "1on1"}}',
    500,
    1000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_1on1_alltime_500')
);

-- EinzelkÃ¤mpfer - 2500 goals in 1on1 all-time (cross-season, chain from goals_1on1_alltime_1000)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'goals_1on1_alltime_2500', 
    'EinzelkÃ¤mpfer', 
    'Score 2500 goals in 1on1 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 2500, "filters": {"gamemode": "1on1"}}',
    1000,
    2500,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_1on1_alltime_1000')
);

-- Solo God - 5000 goals in 1on1 all-time (cross-season, chain from goals_1on1_alltime_2500)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'goals_1on1_alltime_5000', 
    'Solo God', 
    'Score 5000 goals in 1on1 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 5000, "filters": {"gamemode": "1on1"}}',
    2000,
    5000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_1on1_alltime_2500')
);

-- ============================================
-- 2ON2 GOAL ACHIEVEMENTS - SEASON-SPECIFIC (10/50/100/250)
-- These reset each season and track progress within the current season
-- ============================================

-- Tag Team Rookie - 10 goals in 2on2 (season-specific)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'goals_2on2_10', 
    'Not Useless', 
    'Score 10 goals in 2on2 matches this season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 10, "filters": {"gamemode": "2on2"}}',
    50,
    10,
    false,
    false,
    true
);

-- Got Aim - 50 goals in 2on2 (season-specific, chain from goals_2on2_10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'goals_2on2_50', 
    'Got Aim', 
    'Score 50 goals in 2on2 matches this season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 50, "filters": {"gamemode": "2on2"}}',
    75,
    50,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_2on2_10')
);

-- Solid Partner - 100 goals in 2on2 (season-specific, chain from goals_2on2_50)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'goals_2on2_100', 
    'Solid Partner', 
    'Score 100 goals in 2on2 matches this season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 100, "filters": {"gamemode": "2on2"}}',
    100,
    100,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_2on2_50')
);

-- Tandem Master - 250 goals in 2on2 (season-specific, chain from goals_2on2_100)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'goals_2on2_250', 
    'Tandem Master', 
    'Score 250 goals in 2on2 matches this season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 250, "filters": {"gamemode": "2on2"}}',
    150,
    250,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_2on2_100')
);

-- ============================================
-- 2ON2 GOAL ACHIEVEMENTS - CROSS-SEASON / ALL-TIME (500/1000/2500/5000)
-- These track progress across all seasons
-- ============================================

-- Duo Dynamo - 500 goals in 2on2 all-time (cross-season, independent chain)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'goals_2on2_alltime_500', 
    'Duo Dynamo', 
    'Score 500 goals in 2on2 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 500, "filters": {"gamemode": "2on2"}}',
    250,
    500,
    false,
    false,
    false
);

-- Team Legend - 1000 goals in 2on2 all-time (cross-season, chain from goals_2on2_alltime_500)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'goals_2on2_alltime_1000', 
    'Team Legend', 
    'Score 1000 goals in 2on2 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 1000, "filters": {"gamemode": "2on2"}}',
    500,
    1000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_2on2_alltime_500')
);

-- Duo Master - 2500 goals in 2on2 all-time (cross-season, chain from goals_2on2_alltime_1000)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'goals_2on2_alltime_2500', 
    'Duo Master', 
    'Score 2500 goals in 2on2 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 2500, "filters": {"gamemode": "2on2"}}',
    1000,
    2500,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_2on2_alltime_1000')
);

-- Duo God - 5000 goals in 2on2 all-time (cross-season, chain from goals_2on2_alltime_2500)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'goals_2on2_alltime_5000', 
    'Duo God', 
    'Score 5000 goals in 2on2 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "goals", "target": 5000, "filters": {"gamemode": "2on2"}}',
    2000,
    5000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_2on2_alltime_2500')
);

-- ============================================
-- SPEED ACHIEVEMENTS (1on1 and 2on2)
-- ============================================

-- Quick Start 1on1 - Score in first 10 seconds
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'quick_start_1on1', 
    'Quick Start (1on1)', 
    'Score a goal in the first 10 seconds of a 1on1 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'speed'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "early_goal", "target": 10, "filters": {"gamemode": "1on1"}}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Quick Start 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'quick_start_2on2', 
    'Quick Start (2on2)', 
    'Score a goal in the first 10 seconds of a 2on2 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'speed'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "early_goal", "target": 10, "filters": {"gamemode": "2on2"}}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Hat Trick Speed 1on1 - 3 goals in 60 seconds
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'hat_trick_speed_1on1', 
    'Speed Demon (1on1)', 
    'Score 3 goals within 60 seconds in a 1on1 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'speed'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "goals_in_timeframe", "target": 3, "timeframe_seconds": 60, "filters": {"gamemode": "1on1"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Hat Trick Speed 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'hat_trick_speed_2on2', 
    'Speed Demon (2on2)', 
    'Score 3 goals within 60 seconds in a 2on2 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'speed'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "goals_in_timeframe", "target": 3, "timeframe_seconds": 60, "filters": {"gamemode": "2on2"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Blitz Victory 1on1 - Win under 4 minutes
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'blitzkrieg_1on1', 
    'Blitzkrieg (1on1)', 
    'Win a 1on1 match in under 4 minutes',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'speed'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "fast_win", "target": 240, "filters": {"gamemode": "1on1", "result": "win"}}',
    75,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Blitz Victory 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'blitzkrieg_2on2', 
    'Blitzkrieg (2on2)', 
    'Win a 2on2 match in under 4 minutes',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'speed'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "fast_win", "target": 240, "filters": {"gamemode": "2on2", "result": "win"}}',
    75,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- MATCHES PLAYED ACHIEVEMENTS (1on1)
-- ============================================

-- Matches 1on1 Chain: 10 -> 50 -> 100 -> 250 -> 500 -> 1000
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'matches_1on1_10', 
    'Getting Started (1on1)', 
    'Play 10 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 10, "filters": {"gamemode": "1on1"}}',
    25,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_1on1_50', 
    'Regular Player (1on1)', 
    'Play 50 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 50, "filters": {"gamemode": "1on1"}}',
    50,
    50,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_1on1_10')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_1on1_100', 
    'Centurion (1on1)', 
    'Play 100 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 100, "filters": {"gamemode": "1on1"}}',
    100,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_1on1_50')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_1on1_250', 
    'Veteran (1on1)', 
    'Play 250 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 250, "filters": {"gamemode": "1on1"}}',
    200,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_1on1_100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_1on1_500', 
    'Dedicated (1on1)', 
    'Play 500 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 500, "filters": {"gamemode": "1on1"}}',
    400,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_1on1_250')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_1on1_1000', 
    'Legend (1on1)', 
    'Play 1000 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 1000, "filters": {"gamemode": "1on1"}}',
    1000,
    1000,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_1on1_500')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- MATCHES PLAYED ACHIEVEMENTS (2on2)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'matches_2on2_10', 
    'Getting Started (2on2)', 
    'Play 10 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 10, "filters": {"gamemode": "2on2"}}',
    25,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_2on2_50', 
    'Regular Player (2on2)', 
    'Play 50 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 50, "filters": {"gamemode": "2on2"}}',
    50,
    50,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_2on2_10')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_2on2_100', 
    'Centurion (2on2)', 
    'Play 100 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 100, "filters": {"gamemode": "2on2"}}',
    100,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_2on2_50')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_2on2_250', 
    'Veteran (2on2)', 
    'Play 250 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 250, "filters": {"gamemode": "2on2"}}',
    200,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_2on2_100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_2on2_500', 
    'Dedicated (2on2)', 
    'Play 500 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 500, "filters": {"gamemode": "2on2"}}',
    400,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_2on2_250')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'matches_2on2_1000', 
    'Legend (2on2)', 
    'Play 1000 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 1000, "filters": {"gamemode": "2on2"}}',
    1000,
    1000,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_2on2_500')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- WINS ACHIEVEMENTS (1on1)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'wins_1on1_10', 
    'First Victories (1on1)', 
    'Win 10 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 10, "filters": {"gamemode": "1on1", "result": "win"}}',
    25,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_1on1_25', 
    'Rising Star (1on1)', 
    'Win 25 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 25, "filters": {"gamemode": "1on1", "result": "win"}}',
    50,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_1on1_10')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_1on1_50', 
    'Winner (1on1)', 
    'Win 50 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 50, "filters": {"gamemode": "1on1", "result": "win"}}',
    75,
    50,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_1on1_25')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_1on1_100', 
    'Champion (1on1)', 
    'Win 100 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 100, "filters": {"gamemode": "1on1", "result": "win"}}',
    150,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_1on1_50')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_1on1_250', 
    'Dominator (1on1)', 
    'Win 250 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 250, "filters": {"gamemode": "1on1", "result": "win"}}',
    300,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_1on1_100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_1on1_500', 
    'Master (1on1)', 
    'Win 500 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 500, "filters": {"gamemode": "1on1", "result": "win"}}',
    500,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_1on1_250')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_1on1_1000', 
    'Unstoppable (1on1)', 
    'Win 1000 matches in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 1000, "filters": {"gamemode": "1on1", "result": "win"}}',
    1500,
    1000,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_1on1_500')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- WINS ACHIEVEMENTS (2on2)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'wins_2on2_10', 
    'First Victories (2on2)', 
    'Win 10 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 10, "filters": {"gamemode": "2on2", "result": "win"}}',
    25,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_2on2_25', 
    'Rising Star (2on2)', 
    'Win 25 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 25, "filters": {"gamemode": "2on2", "result": "win"}}',
    50,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_2on2_10')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_2on2_50', 
    'Winner (2on2)', 
    'Win 50 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 50, "filters": {"gamemode": "2on2", "result": "win"}}',
    75,
    50,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_2on2_25')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_2on2_100', 
    'Champion (2on2)', 
    'Win 100 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 100, "filters": {"gamemode": "2on2", "result": "win"}}',
    150,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_2on2_50')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_2on2_250', 
    'Dominator (2on2)', 
    'Win 250 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 250, "filters": {"gamemode": "2on2", "result": "win"}}',
    300,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_2on2_100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_2on2_500', 
    'Master (2on2)', 
    'Win 500 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 500, "filters": {"gamemode": "2on2", "result": "win"}}',
    500,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_2on2_250')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'wins_2on2_1000', 
    'Unstoppable (2on2)', 
    'Win 1000 matches in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 1000, "filters": {"gamemode": "2on2", "result": "win"}}',
    1500,
    1000,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_2on2_500')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- PERFECT WIN (10:0)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'perfect_win_1on1', 
    'Flawless Victory (1on1)', 
    'Win a 1on1 match 10:0',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "perfect_win", "filters": {"gamemode": "1on1", "result": "win", "score_diff": {"min": 10}}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'perfect_win_2on2', 
    'Flawless Victory (2on2)', 
    'Win a 2on2 match 10:0',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "perfect_win", "filters": {"gamemode": "2on2", "result": "win", "score_diff": {"min": 10}}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- WIN STREAKS
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'win_streak_5_1on1', 
    'Hot Streak (1on1)', 
    'Win 5 matches in a row in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "win", "min_streak": 5}, "filters": {"gamemode": "1on1"}}',
    100,
    5,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'win_streak_5_2on2', 
    'Hot Streak (2on2)', 
    'Win 5 matches in a row in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "win", "min_streak": 5}, "filters": {"gamemode": "2on2"}}',
    100,
    5,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- COMEBACK ACHIEVEMENTS
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'comeback_5_1on1', 
    'Never Give Up (1on1)', 
    'Win a 1on1 match after being down 0:5',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'comeback'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "comeback", "target": 5, "filters": {"gamemode": "1on1", "result": "win"}}',
    150,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'comeback_5_2on2', 
    'Never Give Up (2on2)', 
    'Win a 2on2 match after being down 0:5',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'comeback'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "comeback", "target": 5, "filters": {"gamemode": "2on2", "result": "win"}}',
    150,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Perfect Comeback (1on1) - Win after 5+ deficit without opponent scoring after
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'perfect_comeback_1on1', 
    'Perfect Comeback (1on1)', 
    'Win a 1on1 after being down 5+ goals without opponent scoring another point',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'comeback'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "perfect_comeback", "target": 5, "filters": {"gamemode": "1on1", "result": "win"}}',
    200,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Perfect Comeback (2on2) - Win after 5+ deficit without opponent scoring after
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'perfect_comeback_2on2', 
    'Perfect Comeback (2on2)', 
    'Win a 2on2 after being down 5+ goals without opponent scoring another point',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'comeback'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "perfect_comeback", "target": 5, "filters": {"gamemode": "2on2", "result": "win"}}',
    200,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Reverse Sweep (1on1) - Exact 0:5 to 10:5 win
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'reverse_sweep_1on1', 
    'Reverse Sweep (1on1)', 
    'Win a 1on1 exactly 10:5 after being down 0:5',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'comeback'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "reverse_sweep", "target": 1, "filters": {"gamemode": "1on1", "result": "win"}}',
    300,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Reverse Sweep (2on2) - Exact 0:5 to 10:5 win
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'reverse_sweep_2on2', 
    'Reverse Sweep (2on2)', 
    'Win a 2on2 exactly 10:5 after being down 0:5',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'comeback'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "reverse_sweep", "target": 1, "filters": {"gamemode": "2on2", "result": "win"}}',
    300,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Comeback Specialist - Win 10x after being down 5+ goals
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'comeback_specialist', 
    'Comeback Specialist', 
    'Win 10 matches after being down 5+ goals',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'comeback'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "comeback", "target": 5, "filters": {"result": "win"}}',
    250,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Momentum Shift (1on1) - Score 5 goals in a row after being behind 3+ goals
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'momentum_shift_1on1', 
    'Momentum Shift (1on1)', 
    'Score 5 goals in a row after being behind 3+ goals in 1on1',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'comeback'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "team_streak_from_deficit", "target": 5, "deficit_min": 3, "filters": {"gamemode": "1on1"}}',
    175,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Momentum Shift (2on2) - Score 5 team goals in a row after being behind 3+ goals
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'momentum_shift_2on2', 
    'Momentum Shift (2on2)', 
    'Score 5 team goals in a row after being behind 3+ goals in 2on2',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'comeback'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "team_streak_from_deficit", "target": 5, "deficit_min": 3, "filters": {"gamemode": "2on2"}}',
    175,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- On My Back - Score all comeback goals yourself in 2on2 after 3+ deficit
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'on_my_back', 
    'On My Back', 
    'Score all comeback goals yourself in a 2on2 win after being down 3+ goals',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'comeback'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "solo_comeback", "target": 3, "filters": {"gamemode": "2on2", "result": "win"}}',
    250,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- MMR ACHIEVEMENTS (1on1)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'mmr_1on1_1100', 
    'Rising Talent (1on1)', 
    'Reach 1100 MMR in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1100, "filters": {"gamemode": "1on1"}}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_1on1_1200', 
    'Skilled Player (1on1)', 
    'Reach 1200 MMR in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1200, "filters": {"gamemode": "1on1"}}',
    100,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_1on1_1100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_1on1_1300', 
    'Expert (1on1)', 
    'Reach 1300 MMR in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1300, "filters": {"gamemode": "1on1"}}',
    200,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_1on1_1200')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_1on1_1400', 
    'Elite (1on1)', 
    'Reach 1400 MMR in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1400, "filters": {"gamemode": "1on1"}}',
    400,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_1on1_1300')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_1on1_1500', 
    'Grandmaster (1on1)', 
    'Reach 1500 MMR in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1500, "filters": {"gamemode": "1on1"}}',
    1000,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_1on1_1400')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- MMR ACHIEVEMENTS (2on2)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'mmr_2on2_1100', 
    'Rising Talent (2on2)', 
    'Reach 1100 MMR in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1100, "filters": {"gamemode": "2on2"}}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_2on2_1200', 
    'Skilled Player (2on2)', 
    'Reach 1200 MMR in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1200, "filters": {"gamemode": "2on2"}}',
    100,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_2on2_1100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_2on2_1300', 
    'Expert (2on2)', 
    'Reach 1300 MMR in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1300, "filters": {"gamemode": "2on2"}}',
    200,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_2on2_1200')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_2on2_1400', 
    'Elite (2on2)', 
    'Reach 1400 MMR in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1400, "filters": {"gamemode": "2on2"}}',
    400,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_2on2_1300')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'mmr_2on2_1500', 
    'Grandmaster (2on2)', 
    'Reach 1500 MMR in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr", "target": 1500, "filters": {"gamemode": "2on2"}}',
    1000,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'mmr_2on2_1400')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- GIANT SLAYER (Beat +200 MMR opponent)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'giant_slayer_1on1', 
    'Giant Slayer (1on1)', 
    'Beat an opponent with 200+ higher MMR in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr_diff_win", "target": 200, "filters": {"gamemode": "1on1", "result": "win"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'giant_slayer_2on2', 
    'Giant Slayer (2on2)', 
    'Beat opponents with 200+ higher average MMR in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'skill'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr_diff_win", "target": 200, "filters": {"gamemode": "2on2", "result": "win"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- PLAYTIME ACHIEVEMENTS
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'playtime_8h', 
    'Time Flies', 
    'Play for a total of 8 hours',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "playtime_seconds", "target": 28800}',
    50,
    28800,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'playtime_16h', 
    'Dedicated Player', 
    'Play for a total of 16 hours',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "playtime_seconds", "target": 57600}',
    100,
    57600,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'playtime_8h')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'playtime_24h', 
    'Full Day', 
    'Play for a total of 24 hours',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "playtime_seconds", "target": 86400}',
    200,
    86400,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'playtime_16h')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- TEAMWORK (2on2 only)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'carry_2on2', 
    'The Carry', 
    'Score all goals for your team and win the 2on2 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'teamwork'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "carry_win", "filters": {"gamemode": "2on2", "result": "win"}}',
    150,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- HIDDEN ACHIEVEMENTS
-- ============================================

-- Silent Partner - Win 2on2 without scoring
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'silent_partner', 
    'Silent Partner', 
    'Win a 2on2 match without scoring a single goal',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "silent_win", "filters": {"gamemode": "2on2", "result": "win"}}',
    100,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Losing Streak
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'losing_streak_10', 
    'Persistence', 
    'Lose 10 matches in a row',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "loss", "min_streak": 10}}',
    50,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Undefeated Season 1on1
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'undefeated_season_1on1', 
    'Undefeated (1on1)', 
    'Finish a 1on1 season without losing a single match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "losses", "target": 0, "filters": {"gamemode": "1on1"}}',
    1000,
    1,
    true,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Undefeated Season 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'undefeated_season_2on2', 
    'Undefeated (2on2)', 
    'Finish a 2on2 season without losing a single match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "losses", "target": 0, "filters": {"gamemode": "2on2"}}',
    1000,
    1,
    true,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Miracle Comeback (0:9)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'miracle_comeback', 
    'Miracle Comeback', 
    'Win a match after being down 0:9',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "comeback", "target": 9, "filters": {"result": "win"}}',
    500,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Own Goal Hat Trick
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_hat_trick', 
    'Oops...', 
    'Score 3 own goals in a single match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "own_goals_in_match", "target": 3}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- META ACHIEVEMENTS
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'achievement_hunter_25', 
    'Achievement Hunter', 
    'Unlock 25 achievements',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievements_unlocked", "target": 25}',
    100,
    25,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'completionist', 
    'Completionist', 
    'Unlock all achievements',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "threshold", "metric": "all_achievements"}',
    1000,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'achievement_hunter_25')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- SEASON ACHIEVEMENTS
-- ============================================

-- Finish on podium (top 3) in 1on1 season
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'season_podium_1on1', 
    'On the Podium (1on1)', 
    'Finish a 1on1 season in the top 3',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_rank", "target": 3, "comparison": "lte", "filters": {"gamemode": "1on1"}}',
    200,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Finish on podium (top 3) in 2on2 season
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'season_podium_2on2', 
    'On the Podium (2on2)', 
    'Finish a 2on2 season in the top 3',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_rank", "target": 3, "comparison": "lte", "filters": {"gamemode": "2on2"}}',
    200,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Season Champion 1on1
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'season_champion_1on1', 
    'Season Champion (1on1)', 
    'Finish a 1on1 season in 1st place',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_rank", "target": 1, "filters": {"gamemode": "1on1"}}',
    500,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Season Champion 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'season_champion_2on2', 
    'Season Champion (2on2)', 
    'Finish a 2on2 season in 1st place',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_rank", "target": 1, "filters": {"gamemode": "2on2"}}',
    500,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- PLAYTIME ACHIEVEMENTS
-- ============================================

-- Play at least 1 hour in a day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'playtime_1h_day', 
    'Dedicated Player', 
    'Play at least 1 hour in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "playtime_in_day", "target": 3600}',
    75,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play at least 3 hours in a week
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'playtime_3h_week', 
    'Weekly Warrior', 
    'Play at least 3 hours within a week',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "playtime_in_week", "target": 10800}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- VICTORIES ACHIEVEMENTS
-- ============================================

-- Defeat 5 different players in 1on1
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'beat_5_different_players_1on1', 
    'Variety is Key', 
    'Defeat 5 different players in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "unique_opponents_defeated", "target": 5, "filters": {"gamemode": "1on1", "result": "win"}}',
    75,
    5,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Win with 5 different teammates in 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'win_5_different_teammates_2on2', 
    'Team Player', 
    'Win with 5 different teammates in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "unique_teammates_won_with", "target": 5, "filters": {"gamemode": "2on2", "result": "win"}}',
    75,
    5,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Win 5 matches in one day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'wins_5_in_day', 
    'Unstoppable Day', 
    'Win 5 matches in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "wins_in_day", "target": 5, "filters": {"result": "win"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Win a match 10-9
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'win_10_9', 
    'Nail Biter', 
    'Win a match with the score 10-9',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "match_won", "target": 1, "filters": {"result": "win", "final_score": "10-9"}}',
    75,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- MATCHES ACHIEVEMENTS
-- ============================================

-- Play 5 matches in one day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'matches_5_in_day', 
    'Marathon Session', 
    'Play 5 matches in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "matches_in_day", "target": 5}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play 5 1on1 matches in one day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'matches_5_1on1_in_day', 
    'Solo Grinder', 
    'Play 5 1on1 matches in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "matches_in_day", "target": 5, "filters": {"gamemode": "1on1"}}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play 5 2on2 matches in one day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'matches_5_2on2_in_day', 
    'Team Grinder', 
    'Play 5 2on2 matches in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "matches_in_day", "target": 5, "filters": {"gamemode": "2on2"}}',
    50,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play 2 1on1 and 2 2on2 in one day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'matches_mixed_day', 
    'All-Rounder', 
    'Play at least 2 1on1 and 2 2on2 matches in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "compound", "conditions": [{"metric": "matches_in_day", "target": 2, "filters": {"gamemode": "1on1"}}, {"metric": "matches_in_day", "target": 2, "filters": {"gamemode": "2on2"}}]}',
    75,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- STREAKS ACHIEVEMENTS (Extensions to Hot Streak)
-- ============================================

-- Win 10 in a row 1on1 (chain from win_streak_5_1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'win_streak_10_1on1', 
    'On Fire (1on1)', 
    'Win 10 matches in a row in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "win", "min_streak": 10}, "filters": {"gamemode": "1on1"}}',
    200,
    10,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'win_streak_5_1on1')
) ON CONFLICT (key) DO NOTHING;

-- Win 15 in a row 1on1 (chain from win_streak_10_1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'win_streak_15_1on1', 
    'Unstoppable (1on1)', 
    'Win 15 matches in a row in 1on1 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "win", "min_streak": 15}, "filters": {"gamemode": "1on1"}}',
    300,
    15,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'win_streak_10_1on1')
) ON CONFLICT (key) DO NOTHING;

-- Win 10 in a row 2on2 (chain from win_streak_5_2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'win_streak_10_2on2', 
    'On Fire (2on2)', 
    'Win 10 matches in a row in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "win", "min_streak": 10}, "filters": {"gamemode": "2on2"}}',
    200,
    10,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'win_streak_5_2on2')
) ON CONFLICT (key) DO NOTHING;

-- Win 15 in a row 2on2 (chain from win_streak_10_2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'win_streak_15_2on2', 
    'Unstoppable (2on2)', 
    'Win 15 matches in a row in 2on2 mode',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "streak", "streak_condition": {"result": "win", "min_streak": 15}, "filters": {"gamemode": "2on2"}}',
    300,
    15,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'win_streak_10_2on2')
) ON CONFLICT (key) DO NOTHING;

-- Beat a player on a hot streak (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'streak_breaker_1on1', 
    'Streak Breaker (1on1)', 
    'Defeat a player who has a win streak of at least 5 in 1on1',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "broke_opponent_streak", "target": 5, "filters": {"gamemode": "1on1", "result": "win"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Beat a player on a hot streak (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'streak_breaker_2on2', 
    'Streak Breaker (2on2)', 
    'Defeat a player who has a win streak of at least 5 in 2on2',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "broke_opponent_streak", "target": 5, "filters": {"gamemode": "2on2", "result": "win"}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- GOALS ACHIEVEMENTS
-- ============================================

-- Score 25 goals in a day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'goals_25_in_day', 
    'Sharpshooter', 
    'Score 25 goals in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "goals_in_day", "target": 25}',
    75,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score 42 goals in a day (chain from 25)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_42_in_day', 
    'Goal Machine', 
    'Score 42 goals in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "goals_in_day", "target": 42}',
    150,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_25_in_day')
) ON CONFLICT (key) DO NOTHING;

-- Score 50 goals in a day (chain from 42)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'goals_50_in_day', 
    'Unstoppable Scorer', 
    'Score 50 goals in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "goals_in_day", "target": 50}',
    250,
    1,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'goals_42_in_day')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- META ACHIEVEMENTS (Extensions to Achievement Hunter)
-- ============================================

-- Achievement Hunter 50 (chain from achievement_hunter_25)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'achievement_hunter_50', 
    'Achievement Collector', 
    'Unlock 50 achievements',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievements_unlocked", "target": 50}',
    200,
    50,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'achievement_hunter_25')
) ON CONFLICT (key) DO NOTHING;

-- Update completionist to be child of achievement_hunter_50
UPDATE kopecht.achievement_definitions 
SET parent_id = (SELECT id FROM kopecht.achievement_definitions WHERE key = 'achievement_hunter_50')
WHERE key = 'completionist';

-- Unlock 3 hidden achievements
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'secret_finder', 
    'Secret Finder', 
    'Unlock 5 hidden achievements',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "secret_achievements_unlocked", "target": 5}',
    150,
    5,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- TITLE COLLECTOR ACHIEVEMENTS (Season-Specific)
-- ============================================

-- Unlock 1 title
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'title_collector_1', 
    'Title Unlocked', 
    'Unlock your first title',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "titles_unlocked", "target": 1}',
    50,
    1,
    false,
    false,
    true
) ON CONFLICT (key) DO NOTHING;

-- Unlock 5 titles (chain from title_collector_1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'title_collector_5', 
    'Title Collector', 
    'Unlock 5 titles',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "titles_unlocked", "target": 5}',
    100,
    5,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'title_collector_1')
) ON CONFLICT (key) DO NOTHING;

-- Unlock 10 titles (chain from title_collector_5)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'title_collector_10', 
    'Title Hoarder', 
    'Unlock 10 titles',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "titles_unlocked", "target": 10}',
    200,
    10,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'title_collector_5')
) ON CONFLICT (key) DO NOTHING;

-- Unlock 15 titles (chain from title_collector_10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'title_collector_15', 
    'Title Master', 
    'Unlock 15 titles',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "titles_unlocked", "target": 15}',
    300,
    15,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'title_collector_10')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- FRAME COLLECTOR ACHIEVEMENTS (Season-Specific)
-- ============================================

-- Unlock 1 frame
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'frame_collector_1', 
    'Frame Unlocked', 
    'Unlock your first avatar frame',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "frames_unlocked", "target": 1}',
    50,
    1,
    false,
    false,
    true
) ON CONFLICT (key) DO NOTHING;

-- Unlock 5 frames (chain from frame_collector_1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'frame_collector_5', 
    'Frame Collector', 
    'Unlock 5 avatar frames',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "frames_unlocked", "target": 5}',
    150,
    5,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'frame_collector_1')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- TEAMWORK ACHIEVEMENTS
-- ============================================

-- Score exactly 5 goals in a 2on2 match and win (perfect 50/50 split)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'perfect_teamwork', 
    'Perfect Teamwork', 
    'Score exactly 5 goals in a 2on2 match where you win 10-X',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'teamwork'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "goals_in_match", "target": 5, "comparison": "eq", "filters": {"gamemode": "2on2", "result": "win", "team_score": 10}}',
    100,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score at least 8 goals in a 2on2 match and win
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'carry_9_goals', 
    'Heavy Lifter', 
    'Score at least 8 goals in a 2on2 match and win 10-X',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'teamwork'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "goals_in_match", "target": 8, "comparison": "gte", "filters": {"gamemode": "2on2", "result": "win", "team_score": 10}}',
    150,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- HIDDEN/SECRET ACHIEVEMENTS
-- ============================================

-- Score an own goal at 9-X (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_at_9_1on1', 
    'So Close... (1on1)', 
    'Score an own goal when you are at 9-X in a 1on1 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 9, "filters": {"gamemode": "1on1", "goal_type": "own_goal"}}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score an own goal at 9-X (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_at_9_2on2', 
    'So Close... (2on2)', 
    'Score an own goal when your team is at 9-X in a 2on2 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 9, "filters": {"gamemode": "2on2", "goal_type": "own_goal"}}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score an own goal at 1-X (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_at_1_1on1', 
    'Adding Insult to Injury (1on1)', 
    'Score an own goal when you are at 1-X in a 1on1 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 1, "filters": {"gamemode": "1on1", "goal_type": "own_goal"}}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score an own goal at 1-X (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_at_1_2on2', 
    'Adding Insult to Injury (2on2)', 
    'Score an own goal when your team is at 1-X in a 2on2 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 1, "filters": {"gamemode": "2on2", "goal_type": "own_goal"}}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Additional Achievements Migration (kopecht schema)
-- Run this in Supabase SQL Editor

-- ============================================
-- GOALS ACHIEVEMENTS - First Blood Series
-- ============================================

-- Score 10 first goals (1-0) in 1on1
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'first_blood_10_1on1', 
    'First Blood Initiate (1on1)', 
    'Score 10 opening goals (1-0) in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 10, "filters": {"gamemode": "1on1"}}',
    50,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score 25 first goals (1-0) in 1on1 (chain from 10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_25_1on1', 
    'First Blood Apprentice (1on1)', 
    'Score 25 opening goals (1-0) in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 25, "filters": {"gamemode": "1on1"}}',
    100,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_10_1on1')
) ON CONFLICT (key) DO NOTHING;

-- Score 100 first goals (1-0) in 1on1 (chain from 25)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_100_1on1', 
    'First Blood Expert (1on1)', 
    'Score 100 opening goals (1-0) in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 100, "filters": {"gamemode": "1on1"}}',
    200,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_25_1on1')
) ON CONFLICT (key) DO NOTHING;

-- Score 250 first goals (1-0) in 1on1 (chain from 100)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_250_1on1', 
    'First Blood Master (1on1)', 
    'Score 250 opening goals (1-0) in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 250, "filters": {"gamemode": "1on1"}}',
    350,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_100_1on1')
) ON CONFLICT (key) DO NOTHING;

-- Score 500 first goals (1-0) in 1on1 (chain from 250)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_500_1on1', 
    'First Blood Legend (1on1)', 
    'Score 500 opening goals (1-0) in 1on1 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 500, "filters": {"gamemode": "1on1"}}',
    500,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_250_1on1')
) ON CONFLICT (key) DO NOTHING;

-- Score 10 first goals (1-0) in 2on2
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'first_blood_10_2on2', 
    'First Blood Initiate (2on2)', 
    'Score 10 opening goals (1-0) in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 10, "filters": {"gamemode": "2on2"}}',
    50,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score 25 first goals (1-0) in 2on2 (chain from 10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_25_2on2', 
    'First Blood Apprentice (2on2)', 
    'Score 25 opening goals (1-0) in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 25, "filters": {"gamemode": "2on2"}}',
    100,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_10_2on2')
) ON CONFLICT (key) DO NOTHING;

-- Score 100 first goals (1-0) in 2on2 (chain from 25)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_100_2on2', 
    'First Blood Expert (2on2)', 
    'Score 100 opening goals (1-0) in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 100, "filters": {"gamemode": "2on2"}}',
    200,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_25_2on2')
) ON CONFLICT (key) DO NOTHING;

-- Score 250 first goals (1-0) in 2on2 (chain from 100)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_250_2on2', 
    'First Blood Master (2on2)', 
    'Score 250 opening goals (1-0) in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 250, "filters": {"gamemode": "2on2"}}',
    350,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_100_2on2')
) ON CONFLICT (key) DO NOTHING;

-- Score 500 first goals (1-0) in 2on2 (chain from 250)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'first_blood_500_2on2', 
    'First Blood Legend (2on2)', 
    'Score 500 opening goals (1-0) in 2on2 matches',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'goals'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "first_blood_goals", "target": 500, "filters": {"gamemode": "2on2"}}',
    500,
    500,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'first_blood_250_2on2')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- GOALS ACHIEVEMENTS - Own Goal Hidden
-- ============================================

-- Score an own goal at 0-0 (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_at_0_1on1', 
    'False Start (1on1)', 
    'Score an own goal when the score is 0-0 in a 1on1 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 0, "filters": {"gamemode": "1on1", "goal_type": "own_goal", "both_scores": 0}}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score an own goal at 0-0 (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goal_at_0_2on2', 
    'False Start (2on2)', 
    'Score an own goal when the score is 0-0 in a 2on2 match',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 0, "filters": {"gamemode": "2on2", "goal_type": "own_goal", "both_scores": 0}}',
    25,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Score 5 own goals in a day
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'own_goals_5_in_day', 
    'Wrong Direction Day', 
    'Score 5 own goals in a single day',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals_in_day", "target": 5, "filters": {"goal_type": "own_goal"}}',
    50,
    5,
    true,
    false
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- VICTORIES ACHIEVEMENTS - Perfect Games
-- ============================================

-- Win 5 matches 10-0
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'perfect_wins_5', 
    'Flawless Victory', 
    'Win 5 matches with the score 10-0',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "perfect_wins", "target": 5, "filters": {"result": "win", "final_score": "10-0"}}',
    150,
    5,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Win 10 matches 10-0 (chain from 5)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'perfect_wins_10', 
    'Domination Expert', 
    'Win 10 matches with the score 10-0',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "perfect_wins", "target": 10, "filters": {"result": "win", "final_score": "10-0"}}',
    300,
    10,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'perfect_wins_5')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- PLAYTIME ACHIEVEMENTS - Early Bird & Night Owl
-- ============================================

-- Play 1 match before 09:00
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'early_bird_1', 
    'Early Bird', 
    'Play a match before 09:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_before_time", "target": 1, "filters": {"time_before": "09:00"}}',
    25,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play 10 matches before 09:00 (chain from 1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'early_bird_10', 
    'Morning Enthusiast', 
    'Play 10 matches before 09:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_before_time", "target": 10, "filters": {"time_before": "09:00"}}',
    75,
    10,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'early_bird_1')
) ON CONFLICT (key) DO NOTHING;

-- Play 25 matches before 09:00 (chain from 10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'early_bird_25', 
    'Dawn Champion', 
    'Play 25 matches before 09:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_before_time", "target": 25, "filters": {"time_before": "09:00"}}',
    150,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'early_bird_10')
) ON CONFLICT (key) DO NOTHING;

-- Play 1 match after 17:00
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'night_owl_1', 
    'Evening Player', 
    'Play a match after 17:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_after_time", "target": 1, "filters": {"time_after": "17:00"}}',
    25,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play 10 matches after 17:00 (chain from 1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'night_owl_10', 
    'Night Owl', 
    'Play 10 matches after 17:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_after_time", "target": 10, "filters": {"time_after": "17:00"}}',
    75,
    10,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'night_owl_1')
) ON CONFLICT (key) DO NOTHING;

-- Play 25 matches after 17:00 (chain from 10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'night_owl_25', 
    'Twilight Master', 
    'Play 25 matches after 17:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_after_time", "target": 25, "filters": {"time_after": "17:00"}}',
    150,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'night_owl_10')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- MATCHES ACHIEVEMENTS - After Meeting Party
-- ============================================

-- Play 10 matches on Wednesday between 15:00 and 18:00
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'after_meeting_party_10', 
    'After Meeting Rookie', 
    'Play 10 matches on Wednesdays between 15:00 and 18:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_in_time_window", "target": 10, "filters": {"day_of_week": "wednesday", "time_after": "15:00", "time_before": "18:00"}}',
    75,
    10,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Play 25 matches on Wednesday between 15:00 and 18:00 (chain from 10)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'after_meeting_party_25', 
    'After Meeting Regular', 
    'Play 25 matches on Wednesdays between 15:00 and 18:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_in_time_window", "target": 25, "filters": {"day_of_week": "wednesday", "time_after": "15:00", "time_before": "18:00"}}',
    150,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'after_meeting_party_10')
) ON CONFLICT (key) DO NOTHING;

-- Play 50 matches on Wednesday between 15:00 and 18:00 (chain from 25)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'after_meeting_party_50', 
    'After Meeting Legend', 
    'Play 50 matches on Wednesdays between 15:00 and 18:00',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches_in_time_window", "target": 50, "filters": {"day_of_week": "wednesday", "time_after": "15:00", "time_before": "18:00"}}',
    300,
    50,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'after_meeting_party_25')
) ON CONFLICT (key) DO NOTHING;


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 4: ENABLE REALTIME
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- Enable realtime for player_achievement_progress
ALTER PUBLICATION supabase_realtime ADD TABLE kopecht.player_achievement_progress;

-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 5: CREATE SQL WEBHOOKS (POSTGRESQL TRIGGER)
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 1. Sicherstellen, dass die pg_net Erweiterung aktiviert ist
create extension if not exists pg_net;

-- 2. Die universelle Trigger-Funktion fÃ¼r Achievements im Schema 'kopecht'
create or replace function kopecht.trigger_process_achievement()
returns trigger 
language plpgsql
security definer -- WICHTIG: LÃ¤uft mit Rechten des Erstellers (Admin)
set search_path = public, kopecht, extensions
as $$
declare
  -- KONFIGURATION
  -- URL deiner Edge Function
  endpoint_url text := 'https://dixhaxicjwqchhautpje.supabase.co/functions/v1/process-achievement';
  
  -- AUTHENTIFIZIERUNG
  -- Ersetze dies mit deinem 'service_role' secret aus dem Supabase Dashboard (Settings -> API)
  -- Dieser Key umgeht RLS und erlaubt den Zugriff auf die geschÃ¼tzte Function.
  service_role_key text := 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpeGhheGljandxY2hoYXV0cGplIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTY5ODQyODUwNSwiZXhwIjoyMDE0MDA0NTA1fQ.tzNZNw1M1NjFHuLFQ7CVkuBE4G9wcmypZBfWd3fiikc';
  
  -- Der Name des Webhooks wird als Argument Ã¼bergeben
  webhook_name text := TG_ARGV[0];
  
begin
  -- HTTP POST Request senden
  perform net.http_post(
      url := endpoint_url,
      headers := jsonb_build_object(
          'Content-Type', 'application/json',
          'Authorization', 'Bearer ' || service_role_key
      ),
      body := jsonb_build_object(
          'webhook_name', webhook_name, 
          'type', TG_OP,                -- INSERT oder UPDATE
          'table', TG_TABLE_NAME,       -- matches, goals, etc.
          'schema', TG_TABLE_SCHEMA,    -- kopecht
          'record', new,                
          'old_record', old             
      )
  );
  
  return new;
end;
$$;


-- 3. Definition der Trigger auf den Tabellen im 'kopecht' Schema

-- Webhook 1: on_achievement_unlocked_kopecht
drop trigger if exists "on_achievement_unlocked_kopecht" on kopecht.player_achievements;
create trigger "on_achievement_unlocked_kopecht"
after insert on kopecht.player_achievements
for each row
execute function kopecht.trigger_process_achievement('on_achievement_unlocked_kopecht');

-- Webhook 2: achievement-match-ended_kopecht
drop trigger if exists "achievement-match-ended_kopecht" on kopecht.matches;
create trigger "achievement-match-ended_kopecht"
after update on kopecht.matches
for each row
execute function kopecht.trigger_process_achievement('achievement-match-ended_kopecht');

-- Webhook 3: achievement-goal-scored_kopecht
drop trigger if exists "achievement-goal-scored_kopecht" on kopecht.goals;
create trigger "achievement-goal-scored_kopecht"
after insert on kopecht.goals
for each row
execute function kopecht.trigger_process_achievement('achievement-goal-scored_kopecht');

-- Webhook 4: achievement-season-ended_kopecht
drop trigger if exists "achievement-season-ended_kopecht" on kopecht.seasons;
create trigger "achievement-season-ended_kopecht"
after update on kopecht.seasons
for each row
execute function kopecht.trigger_process_achievement('achievement-season-ended_kopecht');

-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 6: ACHIEVEMENT UNLOCKED TRIGGER
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Migration: Create trigger for ACHIEVEMENT_UNLOCKED event
-- This triggers the process-achievement Edge Function when a player unlocks an achievement

-- Create the webhook trigger for player_achievements inserts
CREATE OR REPLACE FUNCTION kopecht.notify_achievement_unlocked()
RETURNS TRIGGER AS $$
DECLARE
    payload JSON;
BEGIN
    -- Build payload matching the webhook format
    payload := json_build_object(
        'type', 'INSERT',
        'table', 'player_achievements',
        'schema', 'kopecht',
        'record', row_to_json(NEW),
        'old_record', NULL
    );
    
    -- Call the Edge Function via pg_net (if available) or http extension
    -- Note: You may need to adjust this based on your Supabase setup
    PERFORM
        net.http_post(
            url := current_setting('app.settings.edge_function_url', true) || '/process-achievement',
            headers := jsonb_build_object(
                'Content-Type', 'application/json',
                'Authorization', 'Bearer ' || current_setting('app.settings.service_role_key', true)
            ),
            body := payload::jsonb
        );
    
    RETURN NEW;
EXCEPTION
    WHEN OTHERS THEN
        -- Log error but don't fail the insert
        RAISE WARNING 'Failed to notify achievement unlocked: %', SQLERRM;
        RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create the trigger
DROP TRIGGER IF EXISTS on_achievement_unlocked ON kopecht.player_achievements;
CREATE TRIGGER on_achievement_unlocked
    AFTER INSERT ON kopecht.player_achievements
    FOR EACH ROW
    EXECUTE FUNCTION kopecht.notify_achievement_unlocked();

-- Grant execute permission
GRANT EXECUTE ON FUNCTION kopecht.notify_achievement_unlocked() TO service_role;

COMMENT ON FUNCTION kopecht.notify_achievement_unlocked() IS 
    'Triggers the process-achievement Edge Function when a player unlocks an achievement';


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 7: SEASON SPECIFIC ACHIEVEMENTS
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Migration: Add season-specific achievement support
-- Schema: kopecht
-- This migration adds is_season_specific flag and season_id to progress table

SET search_path TO kopecht;

-- ============================================
-- 1. Add is_season_specific column to achievement_definitions
-- ============================================
ALTER TABLE kopecht.achievement_definitions 
ADD COLUMN IF NOT EXISTS is_season_specific BOOLEAN NOT NULL DEFAULT true;

-- ============================================
-- 2. Add season_id to player_achievement_progress
-- ============================================
ALTER TABLE kopecht.player_achievement_progress 
ADD COLUMN IF NOT EXISTS season_id BIGINT REFERENCES kopecht.seasons(id) ON DELETE SET NULL;

-- Drop old unique constraint and create new one with season_id
ALTER TABLE kopecht.player_achievement_progress 
DROP CONSTRAINT IF EXISTS player_achievement_progress_unique;

ALTER TABLE kopecht.player_achievement_progress 
ADD CONSTRAINT player_achievement_progress_unique 
UNIQUE (player_id, achievement_id, season_id);

-- Add index for season-based progress queries
CREATE INDEX IF NOT EXISTS idx_player_achievement_progress_season 
ON kopecht.player_achievement_progress(season_id);

-- ============================================
-- 3. Set is_season_specific = false for global achievements
-- Only specific achievements are global, not entire categories
-- ============================================

-- Season achievements that track all-time stats are global
-- (podium, champion - they track across seasons but the TRIGGER happens per season)
UPDATE kopecht.achievement_definitions 
SET is_season_specific = false 
WHERE category_id IN (
    SELECT id FROM kopecht.achievement_categories WHERE key = 'season'
);

-- ============================================
-- 4. Create all-time (global) versions of key achievements
-- These have higher targets and track across all seasons
-- ============================================

-- Create 'alltime' category (global - no kicker_id)
-- INSERT INTO kopecht.achievement_categories (key, name, description, icon, sort_order)
-- VALUES ('alltime', 'All-Time', 'Achievements that track your entire career across all seasons', 'ðŸŒŸ', 100)
-- ON CONFLICT (key) DO NOTHING;

-- ============================================
-- ALL-TIME MATCHES ACHIEVEMENTS
-- ============================================

-- 500 Matches All-Time (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'matches_500_alltime_1on1',
    'Veteran (1on1)',
    'Play 500 1on1 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 500, "filters": {"gamemode": "1on1"}}',
    300,
    500,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 1000 Matches All-Time (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'matches_1000_alltime_1on1',
    'Legend (1on1)',
    'Play 1000 1on1 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 1000, "filters": {"gamemode": "1on1"}}',
    500,
    1000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_500_alltime_1on1')
) ON CONFLICT (key) DO NOTHING;

-- 500 Matches All-Time (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'matches_500_alltime_2on2',
    'Veteran (2on2)',
    'Play 500 2on2 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 500, "filters": {"gamemode": "2on2"}}',
    300,
    500,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 1000 Matches All-Time (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'matches_1000_alltime_2on2',
    'Legend (2on2)',
    'Play 1000 2on2 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'matches'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "matches", "target": 1000, "filters": {"gamemode": "2on2"}}',
    500,
    1000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'matches_500_alltime_2on2')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- ALL-TIME WINS ACHIEVEMENTS
-- ============================================

-- 500 Wins All-Time (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'wins_500_alltime_1on1',
    'Champion Soul (1on1)',
    'Win 500 1on1 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 500, "filters": {"gamemode": "1on1"}}',
    400,
    500,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 1000 Wins All-Time (1on1)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'wins_1000_alltime_1on1',
    'Immortal (1on1)',
    'Win 1000 1on1 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 1000, "filters": {"gamemode": "1on1"}}',
    750,
    1000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_500_alltime_1on1')
) ON CONFLICT (key) DO NOTHING;

-- 500 Wins All-Time (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'wins_500_alltime_2on2',
    'Champion Soul (2on2)',
    'Win 500 2on2 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 500, "filters": {"gamemode": "2on2"}}',
    400,
    500,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 1000 Wins All-Time (2on2)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'wins_1000_alltime_2on2',
    'Immortal (2on2)',
    'Win 1000 2on2 matches across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'wins'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "wins", "target": 1000, "filters": {"gamemode": "2on2"}}',
    750,
    1000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'wins_500_alltime_2on2')
) ON CONFLICT (key) DO NOTHING;



-- ============================================
-- ALL-TIME PLAYTIME ACHIEVEMENTS
-- ============================================

-- 100 Hours All-Time
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'playtime_100h_alltime',
    'Dedicated',
    'Play for 100 hours across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "playtime_seconds", "target": 360000}',
    400,
    360000,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 250 Hours All-Time
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'playtime_250h_alltime',
    'Obsessed',
    'Play for 250 hours across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "playtime_seconds", "target": 900000}',
    600,
    900000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'playtime_100h_alltime')
) ON CONFLICT (key) DO NOTHING;

-- 500 Hours All-Time
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific,
    parent_id
) VALUES (
    'playtime_500h_alltime',
    'No Life',
    'Play for 500 hours across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'playtime'),
    'MATCH_ENDED',
    '{"type": "counter", "metric": "playtime_seconds", "target": 1800000}',
    1000,
    1800000,
    true,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'playtime_250h_alltime')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- 5. Add index on matches.season_id for performance
-- ============================================
CREATE INDEX IF NOT EXISTS idx_matches_season_id ON kopecht.matches(season_id);




-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 8: FIX PROGRESS UNIQUE CONSTRAINT (moved before function that uses it)
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- Fix unique constraint for player_achievement_progress to handle NULL season_id correctly
-- PostgreSQL doesn't consider NULL = NULL, so we need two partial indexes

-- First, clean up any existing duplicate rows where season_id IS NULL
DELETE FROM kopecht.player_achievement_progress a
USING kopecht.player_achievement_progress b
WHERE a.season_id IS NULL
  AND b.season_id IS NULL
  AND a.player_id = b.player_id
  AND a.achievement_id = b.achievement_id
  AND a.id < b.id
  AND (a.current_progress < b.current_progress 
       OR (a.current_progress = b.current_progress AND a.updated_at < b.updated_at)
       OR (a.current_progress = b.current_progress AND a.updated_at = b.updated_at));

DELETE FROM kopecht.player_achievement_progress a
USING kopecht.player_achievement_progress b
WHERE a.season_id IS NULL
  AND b.season_id IS NULL
  AND a.player_id = b.player_id
  AND a.achievement_id = b.achievement_id
  AND a.id > b.id
  AND (a.current_progress < b.current_progress 
       OR (a.current_progress = b.current_progress AND a.updated_at < b.updated_at));

-- Drop the existing unique constraint
ALTER TABLE kopecht.player_achievement_progress 
DROP CONSTRAINT IF EXISTS player_achievement_progress_unique;

-- Create partial unique index for rows WITH season_id
CREATE UNIQUE INDEX IF NOT EXISTS idx_player_achievement_progress_unique_with_season 
ON kopecht.player_achievement_progress (player_id, achievement_id, season_id) 
WHERE season_id IS NOT NULL;

-- Create partial unique index for rows WITHOUT season_id (all-time achievements)
CREATE UNIQUE INDEX IF NOT EXISTS idx_player_achievement_progress_unique_no_season 
ON kopecht.player_achievement_progress (player_id, achievement_id) 
WHERE season_id IS NULL;


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 9: FIX INCREMENT PROGRESS FUNCTION (uses loop with retry for 100% race-condition safety)
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Uses a loop that retries UPDATE/INSERT until it succeeds
-- This is the most robust pattern for concurrent upserts in PostgreSQL

-- Drop old function with kicker_id parameter (if exists) to avoid ambiguity
DROP FUNCTION IF EXISTS kopecht.increment_achievement_progress(BIGINT, BIGINT, BIGINT, INTEGER, BIGINT);

CREATE OR REPLACE FUNCTION kopecht.increment_achievement_progress(
    p_player_id BIGINT,
    p_achievement_id BIGINT,
    p_increment INTEGER DEFAULT 1,
    p_season_id BIGINT DEFAULT NULL
)
RETURNS TABLE (
    new_progress INTEGER,
    max_progress INTEGER,
    is_completed BOOLEAN
) AS $$
DECLARE
    v_max_progress INTEGER;
    v_new_progress INTEGER;
    v_is_completed BOOLEAN := FALSE;
    v_is_season_specific BOOLEAN;
    v_progress_season_id BIGINT;
BEGIN
    -- Get max_progress and is_season_specific from achievement definition
    SELECT ad.max_progress, COALESCE(ad.is_season_specific, true) 
    INTO v_max_progress, v_is_season_specific
    FROM kopecht.achievement_definitions ad
    WHERE ad.id = p_achievement_id;
    
    IF v_max_progress IS NULL THEN
        RAISE EXCEPTION 'Achievement not found: %', p_achievement_id;
    END IF;

    -- Determine the season_id for progress tracking
    IF v_is_season_specific THEN
        v_progress_season_id := p_season_id;
    ELSE
        v_progress_season_id := NULL;
    END IF;

    -- LOOP-BASED UPSERT: Most robust pattern for concurrent updates
    -- Keeps retrying until UPDATE or INSERT succeeds
    LOOP
        -- Step 1: Try UPDATE first (works if record exists)
        IF v_progress_season_id IS NULL THEN
            UPDATE kopecht.player_achievement_progress
            SET current_progress = LEAST(current_progress + p_increment, v_max_progress),
                updated_at = NOW()
            WHERE player_id = p_player_id 
              AND achievement_id = p_achievement_id
              AND season_id IS NULL
            RETURNING current_progress INTO v_new_progress;
        ELSE
            UPDATE kopecht.player_achievement_progress
            SET current_progress = LEAST(current_progress + p_increment, v_max_progress),
                updated_at = NOW()
            WHERE player_id = p_player_id 
              AND achievement_id = p_achievement_id
              AND season_id = v_progress_season_id
            RETURNING current_progress INTO v_new_progress;
        END IF;

        -- If UPDATE succeeded, exit loop
        IF FOUND THEN
            EXIT;
        END IF;

        -- Step 2: UPDATE didn't find a row, try INSERT
        BEGIN
            v_new_progress := LEAST(p_increment, v_max_progress);
            
            INSERT INTO kopecht.player_achievement_progress (
                player_id, 
                achievement_id, 
                current_progress,
                season_id,
                updated_at
            )
            VALUES (
                p_player_id, 
                p_achievement_id, 
                v_new_progress,
                v_progress_season_id,
                NOW()
            );
            -- INSERT succeeded, exit loop
            EXIT;
        EXCEPTION WHEN unique_violation THEN
            -- Another transaction inserted first, loop back and UPDATE
            -- This is the key: we LOOP BACK instead of trying to UPDATE here
            NULL;
        END;
    END LOOP;

    -- Check if achievement is now completed
    IF v_new_progress >= v_max_progress THEN
        BEGIN
            IF v_progress_season_id IS NULL THEN
                INSERT INTO kopecht.player_achievements (
                    player_id, achievement_id, unlocked_at, season_id
                ) 
                SELECT p_player_id, p_achievement_id, NOW(), NULL
                WHERE NOT EXISTS (
                    SELECT 1 FROM kopecht.player_achievements
                    WHERE player_id = p_player_id 
                      AND achievement_id = p_achievement_id
                      AND season_id IS NULL
                );
            ELSE
                INSERT INTO kopecht.player_achievements (
                    player_id, achievement_id, unlocked_at, season_id
                )
                SELECT p_player_id, p_achievement_id, NOW(), p_season_id
                WHERE NOT EXISTS (
                    SELECT 1 FROM kopecht.player_achievements
                    WHERE player_id = p_player_id 
                      AND achievement_id = p_achievement_id
                      AND season_id = p_season_id
                );
            END IF;
            
            IF FOUND THEN
                v_is_completed := TRUE;
            END IF;
        EXCEPTION WHEN unique_violation THEN
            -- Achievement already awarded by another concurrent request
            v_is_completed := FALSE;
        END;
    END IF;

    RETURN QUERY SELECT v_new_progress, v_max_progress, v_is_completed;
END;
$$ LANGUAGE plpgsql;

-- Grant execute permission
GRANT EXECUTE ON FUNCTION kopecht.increment_achievement_progress TO authenticated;
GRANT EXECUTE ON FUNCTION kopecht.increment_achievement_progress TO service_role;


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 9b: ATOMIC INCREMENT PROGRESS FALLBACK FUNCTION
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Fallback function using loop with retry pattern for 100% race-condition safety

CREATE OR REPLACE FUNCTION kopecht.atomic_increment_progress(
    p_player_id BIGINT,
    p_achievement_id BIGINT,
    p_increment INTEGER DEFAULT 1,
    p_max_progress INTEGER DEFAULT 1,
    p_season_id BIGINT DEFAULT NULL
)
RETURNS TABLE (
    new_progress INTEGER
) AS $$
DECLARE
    v_new_progress INTEGER;
BEGIN
    -- LOOP-BASED UPSERT: Most robust pattern for concurrent updates
    LOOP
        -- Step 1: Try UPDATE first
        IF p_season_id IS NULL THEN
            UPDATE kopecht.player_achievement_progress
            SET current_progress = LEAST(current_progress + p_increment, p_max_progress),
                updated_at = NOW()
            WHERE player_id = p_player_id 
              AND achievement_id = p_achievement_id
              AND season_id IS NULL
            RETURNING current_progress INTO v_new_progress;
        ELSE
            UPDATE kopecht.player_achievement_progress
            SET current_progress = LEAST(current_progress + p_increment, p_max_progress),
                updated_at = NOW()
            WHERE player_id = p_player_id 
              AND achievement_id = p_achievement_id
              AND season_id = p_season_id
            RETURNING current_progress INTO v_new_progress;
        END IF;

        -- If UPDATE succeeded, exit loop
        IF FOUND THEN
            EXIT;
        END IF;

        -- Step 2: Try INSERT
        BEGIN
            v_new_progress := LEAST(p_increment, p_max_progress);
            
            INSERT INTO kopecht.player_achievement_progress (
                player_id, 
                achievement_id, 
                current_progress,
                season_id,
                updated_at
            )
            VALUES (
                p_player_id, 
                p_achievement_id, 
                v_new_progress,
                p_season_id,
                NOW()
            );
            EXIT;
        EXCEPTION WHEN unique_violation THEN
            -- Loop back and try UPDATE again
            NULL;
        END;
    END LOOP;

    RETURN QUERY SELECT v_new_progress;
END;
$$ LANGUAGE plpgsql;

-- Grant execute permission
GRANT EXECUTE ON FUNCTION kopecht.atomic_increment_progress TO authenticated;
GRANT EXECUTE ON FUNCTION kopecht.atomic_increment_progress TO service_role;


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 10: OWN GOALS ACHIEVEMENTS (was PART 9 continued)
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- ============================================
-- OWN GOALS ACHIEVEMENTS - Season-Specific Chain (10/25/50/100)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'own_goals_season_10', 
    'Butterfingers (Season)', 
    'Score 10 own goals in a season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 10, "filters": {"goal_type": "own_goal"}}',
    25,
    10,
    true,
    false,
    true
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'own_goals_season_25', 
    'Wrong Way Warrior (Season)', 
    'Score 25 own goals in a season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 25, "filters": {"goal_type": "own_goal"}}',
    50,
    25,
    true,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'own_goals_season_10')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'own_goals_season_50', 
    'Self-Saboteur (Season)', 
    'Score 50 own goals in a season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 50, "filters": {"goal_type": "own_goal"}}',
    100,
    50,
    true,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'own_goals_season_25')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'own_goals_season_100', 
    'Own Goal Legend (Season)', 
    'Score 100 own goals in a season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 100, "filters": {"goal_type": "own_goal"}}',
    200,
    100,
    true,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'own_goals_season_50')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- OWN GOALS ACHIEVEMENTS - All-Time Chain (50/100/250/500)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'own_goals_alltime_50', 
    'Career Butterfingers', 
    'Score 50 own goals across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 50, "filters": {"goal_type": "own_goal"}}',
    50,
    50,
    true,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'own_goals_alltime_100', 
    'Wrong Way Veteran', 
    'Score 100 own goals across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 100, "filters": {"goal_type": "own_goal"}}',
    100,
    100,
    true,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'own_goals_alltime_50')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'own_goals_alltime_250', 
    'Self-Destruction Expert', 
    'Score 250 own goals across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 250, "filters": {"goal_type": "own_goal"}}',
    200,
    250,
    true,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'own_goals_alltime_100')
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'own_goals_alltime_500', 
    'The Anti-Striker', 
    'Score 500 own goals across all seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "counter", "metric": "own_goals", "target": 500, "filters": {"goal_type": "own_goal"}}',
    500,
    500,
    true,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'own_goals_alltime_250')
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- LOW MMR ACHIEVEMENTS - Season-Specific (below 700)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'mmr_below_700_1on1', 
    'Rock Bottom (1on1)', 
    'Drop below 700 MMR in 1on1 during a season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr_below", "target": 700, "filters": {"gamemode": "1on1"}}',
    10,
    1,
    true,
    false,
    true
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'mmr_below_700_2on2', 
    'Rock Bottom (2on2)', 
    'Drop below 700 MMR in 2on2 during a season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'MATCH_ENDED',
    '{"type": "threshold", "metric": "mmr_below", "target": 700, "filters": {"gamemode": "2on2"}}',
    10,
    1,
    true,
    false,
    true
) ON CONFLICT (key) DO NOTHING;


-- ============================================
-- FINAL NAIL IN COFFIN - Own goal at 1-9 to make it 0-9
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'final_nail_1on1', 
    'Final Nail (1on1)', 
    'Score an own goal when losing 1-9 to make it 0-9',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 1, "filters": {"gamemode": "1on1", "goal_type": "own_goal", "opponent_score": 9}}',
    50,
    1,
    true,
    false,
    true
) ON CONFLICT (key) DO NOTHING;

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'final_nail_2on2', 
    'Final Nail (2on2)', 
    'Score an own goal when losing 1-9 to make it 0-9',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'GOAL_SCORED',
    '{"type": "threshold", "metric": "own_goal_at_score", "target": 1, "filters": {"gamemode": "2on2", "goal_type": "own_goal", "opponent_score": 9}}',
    50,
    1,
    true,
    false,
    true
) ON CONFLICT (key) DO NOTHING;

-- Migration: Create rewards system tables
-- Schema: kopecht

-- ============================================
-- REWARD DEFINITIONS TABLE
-- Stores all available rewards that can be unlocked via achievements
-- ============================================
CREATE TABLE IF NOT EXISTS kopecht.reward_definitions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    key TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    description TEXT,
    type TEXT NOT NULL CHECK (type IN ('title', 'frame', 'right')),
    -- For titles: 'prefix' means "Title Name", 'suffix' means "Name, Title"
    display_position TEXT CHECK (display_position IN ('prefix', 'suffix')),
    -- The actual value: title text, frame URL, or right identifier
    display_value TEXT NOT NULL,
    -- Achievement that unlocks this reward (NULL = unlocked by default or other means)
    achievement_key TEXT REFERENCES kopecht.achievement_definitions(key),
    icon TEXT,
    sort_order INT NOT NULL DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================
-- PLAYER SELECTED REWARDS TABLE
-- Stores each player's currently active reward per type
-- ============================================
CREATE TABLE IF NOT EXISTS kopecht.player_selected_rewards (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    player_id BIGINT NOT NULL REFERENCES kopecht.player(id) ON DELETE CASCADE,
    reward_type TEXT NOT NULL CHECK (reward_type IN ('title', 'frame')),
    reward_id BIGINT REFERENCES kopecht.reward_definitions(id) ON DELETE SET NULL,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT player_selected_rewards_unique UNIQUE (player_id, reward_type)
);

-- ============================================
-- INDEXES
-- ============================================
CREATE INDEX IF NOT EXISTS idx_reward_definitions_type ON kopecht.reward_definitions(type);
CREATE INDEX IF NOT EXISTS idx_reward_definitions_achievement ON kopecht.reward_definitions(achievement_key);
CREATE INDEX IF NOT EXISTS idx_player_selected_rewards_player ON kopecht.player_selected_rewards(player_id);

-- ============================================
-- RLS POLICIES
-- ============================================
ALTER TABLE kopecht.reward_definitions ENABLE ROW LEVEL SECURITY;
ALTER TABLE kopecht.player_selected_rewards ENABLE ROW LEVEL SECURITY;

-- Reward definitions: Everyone can read
CREATE POLICY "reward_definitions_select_policy" ON kopecht.reward_definitions
    FOR SELECT USING (true);

-- Reward definitions: Only super admin can insert/update/delete
CREATE POLICY "reward_definitions_insert_policy" ON kopecht.reward_definitions
    FOR INSERT WITH CHECK (auth.uid() = 'caeedd2f-5809-41ff-8a79-0c4c64836d2b'::uuid);

CREATE POLICY "reward_definitions_update_policy" ON kopecht.reward_definitions
    FOR UPDATE USING (auth.uid() = 'caeedd2f-5809-41ff-8a79-0c4c64836d2b'::uuid);

CREATE POLICY "reward_definitions_delete_policy" ON kopecht.reward_definitions
    FOR DELETE USING (auth.uid() = 'caeedd2f-5809-41ff-8a79-0c4c64836d2b'::uuid);

-- Player selected rewards: Players can manage their own selections
CREATE POLICY "player_selected_rewards_select_policy" ON kopecht.player_selected_rewards
    FOR SELECT USING (true);

CREATE POLICY "player_selected_rewards_insert_policy" ON kopecht.player_selected_rewards
    FOR INSERT WITH CHECK (
        player_id IN (SELECT id FROM kopecht.player WHERE user_id = auth.uid())
    );

CREATE POLICY "player_selected_rewards_update_policy" ON kopecht.player_selected_rewards
    FOR UPDATE USING (
        player_id IN (SELECT id FROM kopecht.player WHERE user_id = auth.uid())
    );

CREATE POLICY "player_selected_rewards_delete_policy" ON kopecht.player_selected_rewards
    FOR DELETE USING (
        player_id IN (SELECT id FROM kopecht.player WHERE user_id = auth.uid())
    );

-- ============================================
-- RPC: Get player with rewards
-- Returns player data along with their selected title and frame
-- ============================================
CREATE OR REPLACE FUNCTION kopecht.get_player_with_rewards(p_player_id BIGINT)
RETURNS TABLE (
    player_id BIGINT,
    player_name TEXT,
    avatar TEXT,
    title_id BIGINT,
    title_name TEXT,
    title_display_position TEXT,
    title_display_value TEXT,
    frame_id BIGINT,
    frame_name TEXT,
    frame_display_value TEXT
) 
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        p.id AS player_id,
        p.name AS player_name,
        p.avatar,
        t.id AS title_id,
        t.name AS title_name,
        t.display_position AS title_display_position,
        t.display_value AS title_display_value,
        f.id AS frame_id,
        f.name AS frame_name,
        f.display_value AS frame_display_value
    FROM kopecht.player p
    LEFT JOIN kopecht.player_selected_rewards psr_title 
        ON p.id = psr_title.player_id AND psr_title.reward_type = 'title'
    LEFT JOIN kopecht.reward_definitions t 
        ON psr_title.reward_id = t.id
    LEFT JOIN kopecht.player_selected_rewards psr_frame 
        ON p.id = psr_frame.player_id AND psr_frame.reward_type = 'frame'
    LEFT JOIN kopecht.reward_definitions f 
        ON psr_frame.reward_id = f.id
    WHERE p.id = p_player_id;
END;
$$;

-- ============================================
-- RPC: Get unlocked rewards for a player
-- Returns all rewards the player has unlocked (via achievements)
-- ============================================
CREATE OR REPLACE FUNCTION kopecht.get_player_unlocked_rewards(p_player_id BIGINT)
RETURNS TABLE (
    reward_id BIGINT,
    reward_key TEXT,
    reward_name TEXT,
    reward_description TEXT,
    reward_type TEXT,
    display_position TEXT,
    display_value TEXT,
    icon TEXT,
    achievement_key TEXT,
    achievement_name TEXT,
    is_selected BOOLEAN
) 
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        rd.id AS reward_id,
        rd.key AS reward_key,
        rd.name AS reward_name,
        rd.description AS reward_description,
        rd.type AS reward_type,
        rd.display_position,
        rd.display_value,
        rd.icon,
        rd.achievement_key,
        ad.name AS achievement_name,
        CASE WHEN psr.id IS NOT NULL THEN true ELSE false END AS is_selected
    FROM kopecht.reward_definitions rd
    -- Join to get the achievement definition name
    LEFT JOIN kopecht.achievement_definitions ad ON rd.achievement_key = ad.key
    -- Check if this reward is currently selected
    LEFT JOIN kopecht.player_selected_rewards psr 
        ON psr.player_id = p_player_id 
        AND psr.reward_id = rd.id 
        AND psr.reward_type = rd.type
    WHERE 
        -- Reward has no achievement requirement (always unlocked)
        rd.achievement_key IS NULL
        OR
        -- Player has unlocked the achievement
        EXISTS (
            SELECT 1 
            FROM kopecht.player_achievements pa
            JOIN kopecht.achievement_definitions ad2 ON pa.achievement_id = ad2.id
            WHERE pa.player_id = p_player_id 
            AND ad2.key = rd.achievement_key
        )
    ORDER BY rd.type, rd.sort_order;
END;
$$;

-- ============================================
-- RPC: Update player selected reward
-- ============================================
CREATE OR REPLACE FUNCTION kopecht.update_player_selected_reward(
    p_player_id BIGINT,
    p_reward_type TEXT,
    p_reward_id BIGINT DEFAULT NULL
)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_user_id UUID;
BEGIN
    -- Get the user_id for the player
    SELECT user_id INTO v_user_id FROM kopecht.player WHERE id = p_player_id;
    
    -- Check if the current user owns this player
    IF v_user_id != auth.uid() THEN
        RAISE EXCEPTION 'Not authorized to update rewards for this player';
    END IF;

    -- If reward_id is NULL, remove the selection
    IF p_reward_id IS NULL THEN
        DELETE FROM kopecht.player_selected_rewards
        WHERE player_id = p_player_id AND reward_type = p_reward_type;
    ELSE
        -- Verify the player has unlocked this reward
        IF NOT EXISTS (
            SELECT 1 FROM kopecht.reward_definitions rd
            WHERE rd.id = p_reward_id
            AND (
                rd.achievement_key IS NULL
                OR EXISTS (
                    SELECT 1 
                    FROM kopecht.player_achievements pa
                    JOIN kopecht.achievement_definitions ad ON pa.achievement_id = ad.id
                    WHERE pa.player_id = p_player_id 
                    AND ad.key = rd.achievement_key
                )
            )
        ) THEN
            RAISE EXCEPTION 'Reward not unlocked';
        END IF;

        -- Upsert the selection
        INSERT INTO kopecht.player_selected_rewards (player_id, reward_type, reward_id, updated_at)
        VALUES (p_player_id, p_reward_type, p_reward_id, NOW())
        ON CONFLICT (player_id, reward_type) 
        DO UPDATE SET reward_id = p_reward_id, updated_at = NOW();
    END IF;

    RETURN true;
END;
$$;

-- ============================================
-- INITIAL REWARD DATA
-- Example titles linked to achievements
-- ============================================

-- Titles
INSERT INTO kopecht.reward_definitions (key, name, description, type, display_position, display_value, achievement_key, icon, sort_order) VALUES
-- Carry achievement unlocks "Carry" title
('title_carry', 'Carry', 'Show everyone you carry the team', 'title', 'prefix', 'Carry', 'carry_2on2', 'ðŸ’ª', 10),

-- Giant Slayer achievement unlocks title
('title_giant_slayer', 'Giant Slayer', 'Display your prowess against stronger opponents', 'title', 'suffix', 'the Giant Slayer', 'giant_slayer_1on1', 'âš”ï¸', 20),

-- Win streak achievements
('title_unstoppable', 'Unstoppable', 'For those on an incredible winning streak', 'title', 'prefix', 'Unstoppable', 'win_streak_10_1on1', 'ðŸ”¥', 30),

-- Perfect games
('title_perfectionist', 'Perfectionist', 'For achieving perfect victories', 'title', 'suffix', 'the Perfectionist', 'perfect_wins_10', 'âœ¨', 40),

-- Speed demon - blitzkrieg is the fast win achievement
('title_speedster', 'Speedster', 'For lightning-fast victories', 'title', 'prefix', 'Speedster', 'blitzkrieg_1on1', 'âš¡', 50),

-- Comeback king
('title_comeback_king', 'Comeback King', 'For those who never give up', 'title', 'suffix', 'the Comeback King', 'miracle_comeback', 'ðŸ‘‘', 60),

-- Veteran title
('title_veteran', 'Veteran', 'For experienced players', 'title', 'prefix', 'Veteran', 'matches_1on1_100', 'ðŸŽ–ï¸', 70),

-- Champion
('title_champion', 'Champion', 'For season champions', 'title', 'suffix', 'the Champion', 'season_champion_1on1', 'ðŸ†', 80),

-- Secret achievements - own goal specialist
('title_own_goal_master', 'Own Goal Specialist', 'Embrace your unique playstyle', 'title', 'suffix', 'the Own Goal Specialist', 'own_goals_alltime_100', 'ðŸ™ƒ', 90),

-- MMR Below 700 - for the meme
('title_underdog', 'Underdog', 'Started from the bottom', 'title', 'prefix', 'Underdog', 'mmr_below_700_1on1', 'ðŸ¢', 100),

-- Final nail - scoring own goal at 1-9
('title_final_nail', 'Final Nail', 'Master of unfortunate timing', 'title', 'suffix', 'the Final Nail', 'final_nail_1on1', 'âš°ï¸', 110)

ON CONFLICT (key) DO NOTHING;

-- Avatar Frames
INSERT INTO kopecht.reward_definitions (key, name, description, type, display_position, display_value, achievement_key, icon, sort_order) VALUES
-- Domination Expert frame (10 perfect 10-0 wins)
('frame_domination', 'Domination Frame', 'A prestigious frame for dominant players', 'frame', NULL, 'domination_frame', 'perfect_wins_10', 'ðŸ–¼ï¸', 200),

-- Grandmaster frames (1500 MMR)
('frame_grandmaster_1on1', 'Grandmaster Frame (1on1)', 'An elite frame for 1on1 grandmasters', 'frame', NULL, 'grandmaster_1on1_frame', 'mmr_1on1_1500', 'ðŸ–¼ï¸', 210),
('frame_grandmaster_2on2', 'Grandmaster Frame (2on2)', 'An elite frame for 2on2 grandmasters', 'frame', NULL, 'grandmaster_2on2_frame', 'mmr_2on2_1500', 'ðŸ–¼ï¸', 220),

-- Unstoppable frames (15 win streak)
('frame_unstoppable_1on1', 'Unstoppable Frame (1on1)', 'For those who cannot be stopped in 1on1', 'frame', NULL, 'unstoppable_1on1_frame', 'win_streak_15_1on1', 'ðŸ–¼ï¸', 230),
('frame_unstoppable_2on2', 'Unstoppable Frame (2on2)', 'For those who cannot be stopped in 2on2', 'frame', NULL, 'unstoppable_2on2_frame', 'win_streak_15_2on2', 'ðŸ–¼ï¸', 240),

-- Completionist frame (unlock all achievements)
('frame_completionist', 'Completionist Frame', 'The ultimate frame for achievement hunters', 'frame', NULL, 'completionist_frame', 'completionist', 'ðŸ–¼ï¸', 250)

ON CONFLICT (key) DO NOTHING;

-- Grant execute permissions
GRANT EXECUTE ON FUNCTION kopecht.get_player_with_rewards(BIGINT) TO authenticated;
GRANT EXECUTE ON FUNCTION kopecht.get_player_unlocked_rewards(BIGINT) TO authenticated;
GRANT EXECUTE ON FUNCTION kopecht.update_player_selected_reward(BIGINT, TEXT, BIGINT) TO authenticated;



-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 10: Status Tabellen
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Migration: Create player status system with bounties
-- Schema: kopecht

-- ============================================
-- STATUS DEFINITIONS TABLE
-- Defines all possible status effects and their thresholds
-- ============================================
CREATE TABLE IF NOT EXISTS kopecht.status_definitions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    key TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    description TEXT,
    -- Status type for categorization
    type TEXT NOT NULL CHECK (type IN ('streak', 'event', 'monthly', 'special')),
    -- Conditions for activation (JSONB for flexibility)
    -- Example: {"streak_type": "win", "min_streak": 5, "gamemode": "1on1"}
    condition JSONB NOT NULL,
    -- Bounty MMR bonus when this status' streak is broken
    bounty_per_streak INT DEFAULT 0,
    -- Maximum bounty cap (0 = no cap)
    bounty_cap INT DEFAULT 0,
    -- Priority for display (higher = more prominent)
    priority INT DEFAULT 0,
    -- Asset key matching STATUS_EFFECTS in Avatar.jsx
    asset_key TEXT NOT NULL,
    -- Duration in seconds (NULL = until condition changes)
    duration_seconds INT,
    -- Whether multiple instances can stack
    is_stackable BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================
-- PLAYER STATUS TABLE
-- Tracks each player's current status effects and bounties
-- ============================================
CREATE TABLE IF NOT EXISTS kopecht.player_status (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    player_id BIGINT NOT NULL REFERENCES kopecht.player(id) ON DELETE CASCADE,
    -- Gamemode separation (1on1 and 2on2 have independent streaks)
    gamemode TEXT NOT NULL CHECK (gamemode IN ('1on1', '2on2')),
    -- Current streak (positive = wins, negative = losses)
    current_streak INT NOT NULL DEFAULT 0,
    -- Accumulated bounty from streak (in MMR)
    current_bounty INT NOT NULL DEFAULT 0,
    -- Active status effects (keys from status_definitions)
    active_statuses TEXT[] DEFAULT '{}',
    -- Last match that affected this status
    last_match_id BIGINT,
    -- Timestamps
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    -- One entry per player per gamemode
    CONSTRAINT player_status_unique UNIQUE (player_id, gamemode)
);

-- ============================================
-- PLAYER MONTHLY STATUS TABLE
-- Tracks monthly events like 10-0 losses/wins
-- ============================================
CREATE TABLE IF NOT EXISTS kopecht.player_monthly_status (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    player_id BIGINT NOT NULL REFERENCES kopecht.player(id) ON DELETE CASCADE,
    gamemode TEXT NOT NULL CHECK (gamemode IN ('1on1', '2on2')),
    -- Year and month (e.g., '2024-12')
    month TEXT NOT NULL,
    -- Events that occurred this month
    humiliated_count INT DEFAULT 0,  -- 0-10 losses
    dominator_count INT DEFAULT 0,   -- 10-0 wins
    comeback_count INT DEFAULT 0,    -- Wins after 5+ loss streak
    underdog_count INT DEFAULT 0,    -- Wins against 200+ higher MMR
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT player_monthly_status_unique UNIQUE (player_id, gamemode, month)
);

-- ============================================
-- BOUNTY HISTORY TABLE
-- Tracks bounty payouts for statistics/leaderboards
-- ============================================
CREATE TABLE IF NOT EXISTS kopecht.bounty_history (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    -- Player who claimed the bounty
    claimer_id BIGINT NOT NULL REFERENCES kopecht.player(id) ON DELETE CASCADE,
    -- Player whose streak was broken
    victim_id BIGINT NOT NULL REFERENCES kopecht.player(id) ON DELETE CASCADE,
    -- Match where the bounty was claimed
    match_id BIGINT NOT NULL,
    gamemode TEXT NOT NULL,
    -- The streak that was broken
    streak_broken INT NOT NULL,
    -- Bounty amount paid out
    bounty_amount INT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================
-- INDEXES
-- ============================================
CREATE INDEX IF NOT EXISTS idx_player_status_player ON kopecht.player_status(player_id);
CREATE INDEX IF NOT EXISTS idx_player_status_updated ON kopecht.player_status(updated_at);
CREATE INDEX IF NOT EXISTS idx_player_monthly_status_player ON kopecht.player_monthly_status(player_id);
CREATE INDEX IF NOT EXISTS idx_player_monthly_status_month ON kopecht.player_monthly_status(month);
CREATE INDEX IF NOT EXISTS idx_bounty_history_claimer ON kopecht.bounty_history(claimer_id);
CREATE INDEX IF NOT EXISTS idx_bounty_history_victim ON kopecht.bounty_history(victim_id);
CREATE INDEX IF NOT EXISTS idx_bounty_history_created ON kopecht.bounty_history(created_at);

-- ============================================
-- RLS POLICIES
-- ============================================
ALTER TABLE kopecht.status_definitions ENABLE ROW LEVEL SECURITY;
ALTER TABLE kopecht.player_status ENABLE ROW LEVEL SECURITY;
ALTER TABLE kopecht.player_monthly_status ENABLE ROW LEVEL SECURITY;
ALTER TABLE kopecht.bounty_history ENABLE ROW LEVEL SECURITY;

-- Status definitions: Everyone can read
CREATE POLICY "status_definitions_select_policy" ON kopecht.status_definitions
    FOR SELECT USING (true);

-- Player status: Everyone can read
CREATE POLICY "player_status_select_policy" ON kopecht.player_status
    FOR SELECT USING (true);

-- Player monthly status: Everyone can read
CREATE POLICY "player_monthly_status_select_policy" ON kopecht.player_monthly_status
    FOR SELECT USING (true);

-- Bounty history: Everyone can read
CREATE POLICY "bounty_history_select_policy" ON kopecht.bounty_history
    FOR SELECT USING (true);

-- ============================================
-- INSERT DEFAULT STATUS DEFINITIONS
-- ============================================
INSERT INTO kopecht.status_definitions (key, name, description, type, condition, bounty_per_streak, bounty_cap, priority, asset_key) VALUES
-- Win streak statuses
('warming_up', 'Warming Up', 'Won 3 games in a row', 'streak', 
 '{"streak_type": "win", "min_streak": 3}', 
 3, 0, 10, 'warmingUp'),

('hot_streak', 'Hot Streak', 'Won 5 games in a row', 'streak', 
 '{"streak_type": "win", "min_streak": 5}', 
 5, 0, 20, 'hotStreak'),

('on_fire', 'On Fire!', 'Won 7+ games in a row - Unstoppable!', 'streak', 
 '{"streak_type": "win", "min_streak": 7}', 
 8, 0, 30, 'onFire'),

('legendary', 'Legendary', 'Won 10+ games in a row - A living legend!', 'streak', 
 '{"streak_type": "win", "min_streak": 10}', 
 12, 100, 40, 'legendary'),

-- Loss streak statuses
('cold', 'Cold', 'Lost 3 games in a row', 'streak', 
 '{"streak_type": "loss", "min_streak": 3}', 
 0, 0, 10, 'cold'),

('ice_cold', 'Ice Cold', 'Lost 5+ games in a row', 'streak', 
 '{"streak_type": "loss", "min_streak": 5}', 
 0, 0, 20, 'iceCold'),

('frozen', 'Frozen Solid', 'Lost 7+ games in a row - Needs help!', 'streak', 
 '{"streak_type": "loss", "min_streak": 7}', 
 0, 0, 30, 'frozen'),

-- Monthly event statuses
('humiliated', 'Humiliated', 'Suffered a 0-10 defeat this month', 'monthly', 
 '{"event": "loss_10_0"}', 
 0, 0, 5, 'humiliated'),

('dominator', 'Dominator', 'Achieved a 10-0 victory this month', 'monthly', 
 '{"event": "win_10_0"}', 
 0, 0, 15, 'dominator'),

-- Special event statuses
('comeback_king', 'Comeback King', 'Won after a 5+ loss streak', 'event', 
 '{"event": "comeback_after_loss_streak", "min_streak": 5}', 
 0, 0, 25, 'comeback'),

('underdog', 'Underdog', 'Beat an opponent with 200+ higher MMR', 'event', 
 '{"event": "beat_higher_mmr", "mmr_diff": 200}', 
 0, 0, 20, 'underdog'),

('giant_slayer', 'Giant Slayer', 'Beat the player with the highest current streak', 'event', 
 '{"event": "break_highest_streak"}', 
 0, 0, 35, 'giantSlayer');

-- ============================================
-- RPC: Update player status after match
-- Called from match-ended flow
-- ============================================
DROP FUNCTION IF EXISTS kopecht.update_player_status_after_match(BIGINT, BIGINT, TEXT, BOOLEAN, INT, INT, INT);

CREATE OR REPLACE FUNCTION kopecht.update_player_status_after_match(
    p_player_id BIGINT,
    p_match_id BIGINT,
    p_gamemode TEXT,
    p_is_winner BOOLEAN,
    p_score_diff INT,  -- Positive means player's team won by this margin
    p_own_mmr INT,
    p_opponent_mmr INT
)
RETURNS TABLE (
    bounty_claimed INT,
    bounty_victim_id BIGINT,
    bounty_gained INT,
    new_status TEXT[],
    streak INT,
    old_streak INT
) AS $$
DECLARE
    v_current_streak INT;
    v_new_streak INT;
    v_current_bounty INT;
    v_new_bounty INT;
    v_bounty_gained INT := 0;
    v_active_statuses TEXT[];
    v_bounty_to_claim INT := 0;
    v_bounty_victim BIGINT := NULL;
    v_opponent_status RECORD;
    v_status_def RECORD;
    v_month TEXT;
    v_was_on_loss_streak BOOLEAN := FALSE;
    v_loss_streak_before INT := 0;
BEGIN
    -- Get current month for monthly events
    v_month := TO_CHAR(NOW(), 'YYYY-MM');
    
    -- Get or create player status record
    INSERT INTO kopecht.player_status (player_id, gamemode, current_streak, current_bounty, active_statuses)
    VALUES (p_player_id, p_gamemode, 0, 0, '{}')
    ON CONFLICT (player_id, gamemode) DO NOTHING;
    
    -- Get current status
    SELECT ps.current_streak, ps.current_bounty, ps.active_statuses
    INTO v_current_streak, v_current_bounty, v_active_statuses
    FROM kopecht.player_status ps
    WHERE ps.player_id = p_player_id AND ps.gamemode = p_gamemode;
    
    -- Track if player was on a loss streak (for comeback detection)
    IF v_current_streak < 0 THEN
        v_was_on_loss_streak := TRUE;
        v_loss_streak_before := ABS(v_current_streak);
    END IF;
    
    -- Calculate new streak
    IF p_is_winner THEN
        IF v_current_streak >= 0 THEN
            v_new_streak := v_current_streak + 1;
        ELSE
            v_new_streak := 1;  -- Reset from loss streak
        END IF;
    ELSE
        IF v_current_streak <= 0 THEN
            v_new_streak := v_current_streak - 1;
        ELSE
            v_new_streak := -1;  -- Reset from win streak
        END IF;
    END IF;
    
    -- Calculate new bounty (only for win streaks)
    v_new_bounty := 0;
    IF v_new_streak >= 3 THEN
        -- Find applicable status definition for bounty calculation
        SELECT bounty_per_streak INTO v_new_bounty
        FROM kopecht.status_definitions
        WHERE type = 'streak' 
          AND (condition->>'streak_type') = 'win'
          AND (condition->>'min_streak')::int <= v_new_streak
        ORDER BY (condition->>'min_streak')::int DESC
        LIMIT 1;
        
        -- Add bounty: base + additional per win in streak
        v_new_bounty := COALESCE(v_new_bounty, 0) * (v_new_streak - 2);
    END IF;
    
    -- Check if we need to claim bounty from opponent (if we won and broke their streak)
    IF p_is_winner THEN
        -- Find opponent(s) from this match and check their status
        FOR v_opponent_status IN
            SELECT ps.player_id, ps.current_streak, ps.current_bounty
            FROM kopecht.player_status ps
            JOIN kopecht.matches m ON m.id = p_match_id
            WHERE ps.gamemode = p_gamemode
              AND ps.current_streak >= 3  -- Only if they had a win streak
              AND ps.player_id != p_player_id
              AND (
                  (p_gamemode = '1on1' AND ps.player_id IN (m.player1, m.player2))
                  OR
                  (p_gamemode = '2on2' AND ps.player_id IN (m.player1, m.player2, m.player3, m.player4))
              )
        LOOP
            -- Claim their bounty
            v_bounty_to_claim := v_bounty_to_claim + v_opponent_status.current_bounty;
            v_bounty_victim := v_opponent_status.player_id;
            
            -- Record bounty claim
            INSERT INTO kopecht.bounty_history (claimer_id, victim_id, match_id, gamemode, streak_broken, bounty_amount)
            VALUES (p_player_id, v_opponent_status.player_id, p_match_id, p_gamemode, v_opponent_status.current_streak, v_opponent_status.current_bounty);
        END LOOP;
    END IF;
    
    -- Determine active statuses based on new streak
    v_active_statuses := '{}';
    
    FOR v_status_def IN
        SELECT key, condition
        FROM kopecht.status_definitions
        WHERE type = 'streak'
        ORDER BY priority DESC
    LOOP
        IF (v_status_def.condition->>'streak_type') = 'win' AND v_new_streak >= (v_status_def.condition->>'min_streak')::int THEN
            v_active_statuses := array_append(v_active_statuses, v_status_def.key);
        ELSIF (v_status_def.condition->>'streak_type') = 'loss' AND v_new_streak <= -(v_status_def.condition->>'min_streak')::int THEN
            v_active_statuses := array_append(v_active_statuses, v_status_def.key);
        END IF;
    END LOOP;
    
    -- Check for special events
    
    -- Comeback King: Won after 5+ loss streak
    IF p_is_winner AND v_was_on_loss_streak AND v_loss_streak_before >= 5 THEN
        v_active_statuses := array_append(v_active_statuses, 'comeback_king');
        
        -- Update monthly stats
        INSERT INTO kopecht.player_monthly_status (player_id, gamemode, month, comeback_count)
        VALUES (p_player_id, p_gamemode, v_month, 1)
        ON CONFLICT (player_id, gamemode, month)
        DO UPDATE SET comeback_count = kopecht.player_monthly_status.comeback_count + 1, updated_at = NOW();
    END IF;
    
    -- Underdog: Beat opponent with 200+ higher MMR
    IF p_is_winner AND (p_opponent_mmr - p_own_mmr) >= 200 THEN
        v_active_statuses := array_append(v_active_statuses, 'underdog');
        
        -- Update monthly stats
        INSERT INTO kopecht.player_monthly_status (player_id, gamemode, month, underdog_count)
        VALUES (p_player_id, p_gamemode, v_month, 1)
        ON CONFLICT (player_id, gamemode, month)
        DO UPDATE SET underdog_count = kopecht.player_monthly_status.underdog_count + 1, updated_at = NOW();
    END IF;
    
    -- Dominator: 10-0 win
    IF p_is_winner AND p_score_diff = 10 THEN
        v_active_statuses := array_append(v_active_statuses, 'dominator');
        
        -- Update monthly stats
        INSERT INTO kopecht.player_monthly_status (player_id, gamemode, month, dominator_count)
        VALUES (p_player_id, p_gamemode, v_month, 1)
        ON CONFLICT (player_id, gamemode, month)
        DO UPDATE SET dominator_count = kopecht.player_monthly_status.dominator_count + 1, updated_at = NOW();
    END IF;
    
    -- Humiliated: 0-10 loss
    IF NOT p_is_winner AND p_score_diff = -10 THEN
        v_active_statuses := array_append(v_active_statuses, 'humiliated');
        
        -- Update monthly stats
        INSERT INTO kopecht.player_monthly_status (player_id, gamemode, month, humiliated_count)
        VALUES (p_player_id, p_gamemode, v_month, 1)
        ON CONFLICT (player_id, gamemode, month)
        DO UPDATE SET humiliated_count = kopecht.player_monthly_status.humiliated_count + 1, updated_at = NOW();
    END IF;
    
    -- Calculate bounty gained this match (difference from previous bounty)
    IF v_new_bounty > v_current_bounty THEN
        v_bounty_gained := v_new_bounty - v_current_bounty;
    END IF;
    
    -- Update player status
    UPDATE kopecht.player_status
    SET current_streak = v_new_streak,
        current_bounty = v_new_bounty,
        active_statuses = v_active_statuses,
        last_match_id = p_match_id,
        updated_at = NOW()
    WHERE player_id = p_player_id AND gamemode = p_gamemode;
    
    -- Return results
    bounty_claimed := v_bounty_to_claim;
    bounty_victim_id := v_bounty_victim;
    bounty_gained := v_bounty_gained;
    new_status := v_active_statuses;
    streak := v_new_streak;
    old_streak := v_current_streak;
    
    RETURN NEXT;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================
-- RPC: Get player status
-- Returns current status for a player
-- ============================================
CREATE OR REPLACE FUNCTION kopecht.get_player_status(p_player_id BIGINT)
RETURNS TABLE (
    gamemode TEXT,
    current_streak INT,
    current_bounty INT,
    active_statuses TEXT[],
    primary_status TEXT,
    updated_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        ps.gamemode,
        ps.current_streak,
        ps.current_bounty,
        ps.active_statuses,
        -- Primary status is the highest priority active status
        (
            SELECT sd.asset_key
            FROM kopecht.status_definitions sd
            WHERE sd.key = ANY(ps.active_statuses)
            ORDER BY sd.priority DESC
            LIMIT 1
        ) as primary_status,
        ps.updated_at
    FROM kopecht.player_status ps
    WHERE ps.player_id = p_player_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================
-- RPC: Get players with active bounties
-- For bounty leaderboard / hunt targets
-- ============================================
CREATE OR REPLACE FUNCTION kopecht.get_players_with_bounties(
    p_gamemode TEXT DEFAULT NULL,
    p_min_bounty INT DEFAULT 1
)
RETURNS TABLE (
    player_id BIGINT,
    player_name TEXT,
    player_avatar TEXT,
    gamemode TEXT,
    current_streak INT,
    current_bounty INT,
    active_statuses TEXT[],
    primary_status TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        ps.player_id,
        p.name as player_name,
        p.avatar as player_avatar,
        ps.gamemode,
        ps.current_streak,
        ps.current_bounty,
        ps.active_statuses,
        (
            SELECT sd.asset_key
            FROM kopecht.status_definitions sd
            WHERE sd.key = ANY(ps.active_statuses)
            ORDER BY sd.priority DESC
            LIMIT 1
        ) as primary_status
    FROM kopecht.player_status ps
    JOIN kopecht.player p ON p.id = ps.player_id
    WHERE ps.current_bounty >= p_min_bounty
      AND (p_gamemode IS NULL OR ps.gamemode = p_gamemode)
    ORDER BY ps.current_bounty DESC, ps.current_streak DESC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================
-- RPC: Get bounty leaderboard (top bounty hunters)
-- ============================================
CREATE OR REPLACE FUNCTION kopecht.get_bounty_leaderboard(
    p_limit INT DEFAULT 10,
    p_month TEXT DEFAULT NULL  -- Format: 'YYYY-MM', NULL for all time
)
RETURNS TABLE (
    player_id BIGINT,
    player_name TEXT,
    player_avatar TEXT,
    total_bounties_claimed INT,
    total_bounty_amount INT,
    biggest_bounty INT,
    biggest_streak_broken INT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        bh.claimer_id as player_id,
        p.name as player_name,
        p.avatar as player_avatar,
        COUNT(*)::INT as total_bounties_claimed,
        SUM(bh.bounty_amount)::INT as total_bounty_amount,
        MAX(bh.bounty_amount)::INT as biggest_bounty,
        MAX(bh.streak_broken)::INT as biggest_streak_broken
    FROM kopecht.bounty_history bh
    JOIN kopecht.player p ON p.id = bh.claimer_id
    WHERE (p_month IS NULL OR TO_CHAR(bh.created_at, 'YYYY-MM') = p_month)
    GROUP BY bh.claimer_id, p.name, p.avatar
    ORDER BY total_bounty_amount DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 12: status_display_config table for admin-configurable
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- Migration: Create status_display_config table for admin-configurable status display settings
-- Schema: kopecht

-- Table to store status display configuration per kicker
CREATE TABLE IF NOT EXISTS kopecht.status_display_config (
    id SERIAL PRIMARY KEY,
    kicker_id INTEGER NOT NULL REFERENCES kopecht.kicker(id) ON DELETE CASCADE,
    status_key VARCHAR(50) NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    layer VARCHAR(20) NOT NULL DEFAULT 'effect', -- 'effect', 'overlay', 'background'
    priority INTEGER NOT NULL DEFAULT 50, -- Higher = shown first when conflicts
    is_exclusive BOOLEAN NOT NULL DEFAULT true, -- If true, only one per layer
    is_enabled BOOLEAN NOT NULL DEFAULT true, -- Can be disabled without deleting
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(kicker_id, status_key)
);

-- Create index for faster lookups
CREATE INDEX IF NOT EXISTS idx_status_display_config_kicker ON kopecht.status_display_config(kicker_id);

-- Insert default configuration for all existing kicker
INSERT INTO kopecht.status_display_config (kicker_id, status_key, display_name, layer, priority, is_exclusive, is_enabled)
SELECT 
    k.id,
    s.status_key,
    s.display_name,
    s.layer,
    s.priority,
    s.is_exclusive,
    s.is_enabled
FROM kopecht.kicker k
CROSS JOIN (VALUES
    -- Effect layer (exclusive - only highest priority shown)
    ('legendary', 'Legendary', 'effect', 100, true, true),
    ('onFire', 'On Fire', 'effect', 90, true, true),
    ('hotStreak', 'Hot Streak', 'effect', 80, true, true),
    ('warmingUp', 'Warming Up', 'effect', 70, true, true),
    ('frozen', 'Frozen', 'effect', 65, true, true),
    ('iceCold', 'Ice Cold', 'effect', 60, true, true),
    ('cold', 'Cold', 'effect', 50, true, true),
    
    -- Overlay layer (non-exclusive - can show with effect layer)
    ('dominator', 'Dominator', 'overlay', 85, false, true),
    ('giantSlayer', 'Giant Slayer', 'overlay', 80, false, true),
    ('comeback', 'Comeback', 'overlay', 75, false, true),
    ('underdog', 'Underdog', 'overlay', 70, false, true),
    
    -- Background layer (non-exclusive - shown behind others)
    ('humiliated', 'Humiliated', 'background', 50, false, true)
) AS s(status_key, display_name, layer, priority, is_exclusive, is_enabled)
ON CONFLICT (kicker_id, status_key) DO NOTHING;

-- RPC function to get status display config for a kicker
CREATE OR REPLACE FUNCTION kopecht.get_status_display_config(p_kicker_id INTEGER)
RETURNS TABLE (
    id INTEGER,
    status_key VARCHAR(50),
    display_name VARCHAR(100),
    layer VARCHAR(20),
    priority INTEGER,
    is_exclusive BOOLEAN,
    is_enabled BOOLEAN
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        sdc.id,
        sdc.status_key,
        sdc.display_name,
        sdc.layer,
        sdc.priority,
        sdc.is_exclusive,
        sdc.is_enabled
    FROM kopecht.status_display_config sdc
    WHERE sdc.kicker_id = p_kicker_id
    ORDER BY sdc.priority DESC, sdc.display_name;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- RPC function to update a single status config
CREATE OR REPLACE FUNCTION kopecht.update_status_display_config(
    p_kicker_id INTEGER,
    p_status_key VARCHAR(50),
    p_layer VARCHAR(20) DEFAULT NULL,
    p_priority INTEGER DEFAULT NULL,
    p_is_exclusive BOOLEAN DEFAULT NULL,
    p_is_enabled BOOLEAN DEFAULT NULL
)
RETURNS BOOLEAN AS $$
BEGIN
    UPDATE kopecht.status_display_config
    SET 
        layer = COALESCE(p_layer, layer),
        priority = COALESCE(p_priority, priority),
        is_exclusive = COALESCE(p_is_exclusive, is_exclusive),
        is_enabled = COALESCE(p_is_enabled, is_enabled),
        updated_at = NOW()
    WHERE kicker_id = p_kicker_id AND status_key = p_status_key;
    
    RETURN FOUND;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- RPC function to batch update status configs
CREATE OR REPLACE FUNCTION kopecht.batch_update_status_display_config(
    p_kicker_id INTEGER,
    p_configs JSONB -- Array of {status_key, layer, priority, is_exclusive, is_enabled}
)
RETURNS INTEGER AS $$
DECLARE
    v_config JSONB;
    v_updated INTEGER := 0;
BEGIN
    FOR v_config IN SELECT * FROM jsonb_array_elements(p_configs)
    LOOP
        UPDATE kopecht.status_display_config
        SET 
            layer = COALESCE(v_config->>'layer', layer),
            priority = COALESCE((v_config->>'priority')::INTEGER, priority),
            is_exclusive = COALESCE((v_config->>'is_exclusive')::BOOLEAN, is_exclusive),
            is_enabled = COALESCE((v_config->>'is_enabled')::BOOLEAN, is_enabled),
            updated_at = NOW()
        WHERE kicker_id = p_kicker_id 
          AND status_key = v_config->>'status_key';
        
        IF FOUND THEN
            v_updated := v_updated + 1;
        END IF;
    END LOOP;
    
    RETURN v_updated;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Grant permissions
GRANT SELECT, INSERT, UPDATE ON kopecht.status_display_config TO authenticated;
GRANT USAGE ON SEQUENCE kopecht.status_display_config_id_seq TO authenticated;
GRANT EXECUTE ON FUNCTION kopecht.get_status_display_config(INTEGER) TO authenticated;
GRANT EXECUTE ON FUNCTION kopecht.update_status_display_config(INTEGER, VARCHAR, VARCHAR, INTEGER, BOOLEAN, BOOLEAN) TO authenticated;
GRANT EXECUTE ON FUNCTION kopecht.batch_update_status_display_config(INTEGER, JSONB) TO authenticated;

-- Enable RLS
ALTER TABLE kopecht.status_display_config ENABLE ROW LEVEL SECURITY;

-- RLS Policies
CREATE POLICY "status_display_config_select_policy" ON kopecht.status_display_config
    FOR SELECT USING (true);

CREATE POLICY "status_display_config_update_policy" ON kopecht.status_display_config
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM kopecht.kicker k
            WHERE k.id = status_display_config.kicker_id
            AND k.admin = auth.uid()
        )
    );

-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 13: Bounty Tracking Columns
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


-- ============================================
-- Migration: Add Bounty Tracking Columns
-- Adds bounty tracking to matches, season_rankings, and player_history
-- ============================================

-- ============================================
-- 1. ADD BOUNTY COLUMNS TO MATCHES TABLE
-- Stores the bounty earned by each team in a match
-- ============================================
ALTER TABLE kopecht.matches 
ADD COLUMN IF NOT EXISTS bounty_team1 INT DEFAULT 0,
ADD COLUMN IF NOT EXISTS bounty_team2 INT DEFAULT 0;

-- ============================================
-- 2. ADD BOUNTY COLUMNS TO SEASON_RANKINGS TABLE
-- Tracks total bounty claimed per player per season
-- ============================================
ALTER TABLE kopecht.season_rankings
ADD COLUMN IF NOT EXISTS bounty_claimed INT DEFAULT 0,
ADD COLUMN IF NOT EXISTS bounty_claimed_2on2 INT DEFAULT 0;

-- ============================================
-- 3. ADD BOUNTY COLUMNS TO PLAYER_HISTORY TABLE
-- Tracks daily bounty claimed for historical stats
-- ============================================
ALTER TABLE kopecht.player_history
ADD COLUMN IF NOT EXISTS bounty_claimed INT DEFAULT 0,
ADD COLUMN IF NOT EXISTS bounty_claimed_2on2 INT DEFAULT 0;

-- ============================================
-- 4. UPDATE STATUS_DEFINITIONS TO ENSURE EVEN BOUNTY VALUES
-- Bounty should always be divisible by 2 for fair 2on2 splits
-- ============================================
UPDATE kopecht.status_definitions
SET bounty_per_streak = 4
WHERE key = 'warming_up' AND bounty_per_streak = 3;

UPDATE kopecht.status_definitions
SET bounty_per_streak = 6
WHERE key = 'hot_streak' AND bounty_per_streak = 5;

UPDATE kopecht.status_definitions
SET bounty_per_streak = 8
WHERE key = 'on_fire' AND bounty_per_streak = 8;

UPDATE kopecht.status_definitions
SET bounty_per_streak = 12
WHERE key = 'legendary' AND bounty_per_streak = 12;

-- ============================================
-- 5. CREATE RPC TO GET TEAM BOUNTY
-- Returns total bounty for a list of player IDs in a given gamemode
-- ============================================
CREATE OR REPLACE FUNCTION kopecht.get_team_bounty(
    p_player_ids BIGINT[],
    p_gamemode TEXT
)
RETURNS INT AS $$
DECLARE
    v_total_bounty INT := 0;
BEGIN
    SELECT COALESCE(SUM(current_bounty), 0)
    INTO v_total_bounty
    FROM kopecht.player_status
    WHERE player_id = ANY(p_player_ids)
      AND gamemode = p_gamemode;
    
    RETURN v_total_bounty;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Grant execute permission
GRANT EXECUTE ON FUNCTION kopecht.get_team_bounty(BIGINT[], TEXT) TO authenticated;

-- ============================================
-- 6. CREATE RPC TO UPDATE SEASON RANKINGS BOUNTY
-- Increments bounty_claimed for winners
-- ============================================
CREATE OR REPLACE FUNCTION kopecht.add_bounty_to_season_rankings(
    p_player_id BIGINT,
    p_season_id BIGINT,
    p_bounty_amount INT,
    p_gamemode TEXT
)
RETURNS VOID AS $$
BEGIN
    IF p_gamemode = '1on1' THEN
        UPDATE kopecht.season_rankings
        SET bounty_claimed = bounty_claimed + p_bounty_amount
        WHERE player_id = p_player_id AND season_id = p_season_id;
    ELSE
        UPDATE kopecht.season_rankings
        SET bounty_claimed_2on2 = bounty_claimed_2on2 + p_bounty_amount
        WHERE player_id = p_player_id AND season_id = p_season_id;
    END IF;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Grant execute permission
GRANT EXECUTE ON FUNCTION kopecht.add_bounty_to_season_rankings(BIGINT, BIGINT, INT, TEXT) TO authenticated;

-- ============================================
-- 7. UPDATE update_player_history FUNCTION
-- Add bounty tracking to daily history snapshots
-- ============================================

-- Note: The existing update_player_history function will need to be updated
-- to include bounty_claimed in the daily snapshot. This is handled separately
-- if the function exists, or the bounty is tracked via direct updates.

COMMENT ON COLUMN kopecht.matches.bounty_team1 IS 'Total bounty earned by team 1 in this match';
COMMENT ON COLUMN kopecht.matches.bounty_team2 IS 'Total bounty earned by team 2 in this match';
COMMENT ON COLUMN kopecht.season_rankings.bounty_claimed IS 'Total bounty claimed in 1on1 this season';
COMMENT ON COLUMN kopecht.season_rankings.bounty_claimed_2on2 IS 'Total bounty claimed in 2on2 this season';
COMMENT ON COLUMN kopecht.player_history.bounty_claimed IS 'Bounty claimed in 1on1 on this date';
COMMENT ON COLUMN kopecht.player_history.bounty_claimed_2on2 IS 'Bounty claimed in 2on2 on this date';

-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 14: Fix Bounty Calculation
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- Migration: Fix bounty calculation - only add bounty when crossing thresholds
-- Schema: kopecht
-- 
-- BUG: Previously, bounty was calculated as `bounty_per_streak * (streak - 2)` 
-- which meant bounty increased on EVERY win after streak 3.
--
-- FIX: Bounty should only be ADDED when crossing specific thresholds:
-- - 3rd win: +4 (warming_up)
-- - 5th win: +6 (hot_streak)  
-- - 7th win: +8 (on_fire)
-- - 10th win: +12 (legendary)
--
-- Example: Player wins 6 times in a row
-- - After 3rd win: bounty = 4
-- - After 4th win: bounty = 4 (no change)
-- - After 5th win: bounty = 4 + 6 = 10
-- - After 6th win: bounty = 10 (no change)

SET search_path TO kopecht;

-- Drop existing function first (return type changed)
DROP FUNCTION IF EXISTS kopecht.update_player_status_after_match(BIGINT, BIGINT, TEXT, BOOLEAN, INT, INT, INT);

CREATE OR REPLACE FUNCTION kopecht.update_player_status_after_match(
    p_player_id BIGINT,
    p_match_id BIGINT,
    p_gamemode TEXT,
    p_is_winner BOOLEAN,
    p_score_diff INT,
    p_own_mmr INT,
    p_opponent_mmr INT
)
RETURNS TABLE (
    bounty_claimed INT,
    bounty_victim_id BIGINT,
    new_status TEXT[],
    streak INT,
    bounty_gained INT,
    old_streak INT
) AS $$
DECLARE
    v_current_streak INT;
    v_new_streak INT;
    v_current_bounty INT;
    v_new_bounty INT;
    v_threshold_bounty INT;
    v_bounty_gained INT := 0;
    v_active_statuses TEXT[];
    v_bounty_to_claim INT := 0;
    v_bounty_victim BIGINT := NULL;
    v_opponent_status RECORD;
    v_status_def RECORD;
    v_month TEXT;
    v_was_on_loss_streak BOOLEAN := FALSE;
    v_loss_streak_before INT := 0;
BEGIN
    -- Get current month for monthly events
    v_month := TO_CHAR(NOW(), 'YYYY-MM');
    
    -- Get or create player status record
    INSERT INTO kopecht.player_status (player_id, gamemode, current_streak, current_bounty, active_statuses)
    VALUES (p_player_id, p_gamemode, 0, 0, '{}')
    ON CONFLICT (player_id, gamemode) DO NOTHING;
    
    -- Get current status
    SELECT current_streak, current_bounty, active_statuses
    INTO v_current_streak, v_current_bounty, v_active_statuses
    FROM kopecht.player_status
    WHERE player_id = p_player_id AND gamemode = p_gamemode;
    
    -- Track if player was on a loss streak (for comeback detection)
    IF v_current_streak < 0 THEN
        v_was_on_loss_streak := TRUE;
        v_loss_streak_before := ABS(v_current_streak);
    END IF;
    
    -- Calculate new streak
    IF p_is_winner THEN
        IF v_current_streak >= 0 THEN
            v_new_streak := v_current_streak + 1;
        ELSE
            v_new_streak := 1;  -- Reset from loss streak
        END IF;
    ELSE
        IF v_current_streak <= 0 THEN
            v_new_streak := v_current_streak - 1;
        ELSE
            v_new_streak := -1;  -- Reset from win streak
        END IF;
    END IF;
    
    -- ============================================
    -- FIXED BOUNTY CALCULATION
    -- Only add bounty when crossing a threshold
    -- ============================================
    IF p_is_winner AND v_new_streak >= 3 THEN
        -- Keep existing bounty as base (or 0 if coming from loss streak)
        IF v_current_streak >= 0 THEN
            v_new_bounty := v_current_bounty;
        ELSE
            v_new_bounty := 0;
        END IF;
        
        -- Check if we just crossed a threshold (3, 5, 7, or 10)
        -- Only add bounty if v_new_streak matches a threshold AND v_current_streak was below it
        SELECT bounty_per_streak INTO v_threshold_bounty
        FROM kopecht.status_definitions
        WHERE type = 'streak' 
          AND (condition->>'streak_type') = 'win'
          AND (condition->>'min_streak')::int = v_new_streak
          AND v_current_streak < v_new_streak;  -- Must have just crossed this threshold
        
        -- Add threshold bounty if we crossed one
        IF v_threshold_bounty IS NOT NULL AND v_threshold_bounty > 0 THEN
            v_new_bounty := v_new_bounty + v_threshold_bounty;
            v_bounty_gained := v_threshold_bounty;  -- Track how much bounty was just gained
        END IF;
    ELSE
        -- Not on a win streak of 3+, bounty is 0
        v_new_bounty := 0;
    END IF;
    
    -- Check if we need to claim bounty from opponent (if we won and broke their streak)
    -- FIX: In 2on2, BOTH winners should claim bounty from LOSING team opponents only
    IF p_is_winner THEN
        FOR v_opponent_status IN
            SELECT ps.player_id, ps.current_streak, ps.current_bounty
            FROM kopecht.player_status ps
            JOIN kopecht.matches m ON m.id = p_match_id
            WHERE ps.gamemode = p_gamemode
              AND ps.current_streak >= 3
              AND ps.player_id != p_player_id
              AND (
                  -- 1on1: Only one opponent, simple check
                  (p_gamemode = '1on1' AND ps.player_id IN (m.player1, m.player2))
                  OR
                  -- 2on2: Check that opponent is on the LOSING team (opposite of current player's team)
                  (p_gamemode = '2on2' AND (
                      -- If current player is on Team 1 (winner), opponent must be on Team 2 (loser)
                      (p_player_id IN (m.player1, m.player3) AND m."scoreTeam1" > m."scoreTeam2" AND ps.player_id IN (m.player2, m.player4))
                      OR
                      -- If current player is on Team 2 (winner), opponent must be on Team 1 (loser)
                      (p_player_id IN (m.player2, m.player4) AND m."scoreTeam2" > m."scoreTeam1" AND ps.player_id IN (m.player1, m.player3))
                  ))
              )
        LOOP
            v_bounty_to_claim := v_bounty_to_claim + v_opponent_status.current_bounty;
            v_bounty_victim := v_opponent_status.player_id;
            
            -- Only insert into bounty_history if this bounty hasn't been claimed for this match yet
            -- This prevents duplicate entries but allows both winners to get credit
            INSERT INTO kopecht.bounty_history (claimer_id, victim_id, match_id, gamemode, streak_broken, bounty_amount)
            VALUES (p_player_id, v_opponent_status.player_id, p_match_id, p_gamemode, v_opponent_status.current_streak, v_opponent_status.current_bounty)
            ON CONFLICT DO NOTHING;  -- Ignore if already exists for this claimer/victim/match combo
        END LOOP;
    END IF;
    
    -- Determine active statuses based on new streak
    v_active_statuses := '{}';
    
    FOR v_status_def IN
        SELECT key, condition
        FROM kopecht.status_definitions
        WHERE type = 'streak'
        ORDER BY priority DESC
    LOOP
        IF (v_status_def.condition->>'streak_type') = 'win' AND v_new_streak >= (v_status_def.condition->>'min_streak')::int THEN
            v_active_statuses := array_append(v_active_statuses, v_status_def.key);
        ELSIF (v_status_def.condition->>'streak_type') = 'loss' AND v_new_streak <= -(v_status_def.condition->>'min_streak')::int THEN
            v_active_statuses := array_append(v_active_statuses, v_status_def.key);
        END IF;
    END LOOP;
    
    -- Check for special events
    
    -- Comeback King: Won after 5+ loss streak
    IF p_is_winner AND v_was_on_loss_streak AND v_loss_streak_before >= 5 THEN
        v_active_statuses := array_append(v_active_statuses, 'comeback_king');
        
        INSERT INTO kopecht.player_monthly_status (player_id, gamemode, month, comeback_count)
        VALUES (p_player_id, p_gamemode, v_month, 1)
        ON CONFLICT (player_id, gamemode, month)
        DO UPDATE SET comeback_count = kopecht.player_monthly_status.comeback_count + 1, updated_at = NOW();
    END IF;
    
    -- Underdog: Beat opponent with 200+ higher MMR
    IF p_is_winner AND (p_opponent_mmr - p_own_mmr) >= 200 THEN
        v_active_statuses := array_append(v_active_statuses, 'underdog');
        
        INSERT INTO kopecht.player_monthly_status (player_id, gamemode, month, underdog_count)
        VALUES (p_player_id, p_gamemode, v_month, 1)
        ON CONFLICT (player_id, gamemode, month)
        DO UPDATE SET underdog_count = kopecht.player_monthly_status.underdog_count + 1, updated_at = NOW();
    END IF;
    
    -- Dominator: 10-0 win
    IF p_is_winner AND p_score_diff = 10 THEN
        v_active_statuses := array_append(v_active_statuses, 'dominator');
        
        INSERT INTO kopecht.player_monthly_status (player_id, gamemode, month, dominator_count)
        VALUES (p_player_id, p_gamemode, v_month, 1)
        ON CONFLICT (player_id, gamemode, month)
        DO UPDATE SET dominator_count = kopecht.player_monthly_status.dominator_count + 1, updated_at = NOW();
    END IF;
    
    -- Humiliated: 0-10 loss
    IF NOT p_is_winner AND p_score_diff = -10 THEN
        v_active_statuses := array_append(v_active_statuses, 'humiliated');
        
        INSERT INTO kopecht.player_monthly_status (player_id, gamemode, month, humiliated_count)
        VALUES (p_player_id, p_gamemode, v_month, 1)
        ON CONFLICT (player_id, gamemode, month)
        DO UPDATE SET humiliated_count = kopecht.player_monthly_status.humiliated_count + 1, updated_at = NOW();
    END IF;
    
    -- Update player status
    UPDATE kopecht.player_status
    SET current_streak = v_new_streak,
        current_bounty = v_new_bounty,
        active_statuses = v_active_statuses,
        last_match_id = p_match_id,
        updated_at = NOW()
    WHERE player_id = p_player_id AND gamemode = p_gamemode;
    
    -- Return results
    bounty_claimed := v_bounty_to_claim;
    bounty_victim_id := v_bounty_victim;
    new_status := v_active_statuses;
    streak := v_new_streak;
    bounty_gained := v_bounty_gained;
    old_streak := v_current_streak;
    
    RETURN NEXT;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Grant execute permission
GRANT EXECUTE ON FUNCTION kopecht.update_player_status_after_match(BIGINT, BIGINT, TEXT, BOOLEAN, INT, INT, INT) TO authenticated;
GRANT EXECUTE ON FUNCTION kopecht.update_player_status_after_match(BIGINT, BIGINT, TEXT, BOOLEAN, INT, INT, INT) TO service_role;



-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 15: Bounty Achievements
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

-- Migration: Add bounty-related achievements and secret achievements
-- Schema: kopecht
-- Note: Bounty achievements are placed under 'streaks' category

SET search_path TO kopecht;

-- ============================================
-- BOUNTY HUNTER ACHIEVEMENTS (under streaks category)
-- Beat players who have a bounty on their head
-- ============================================

-- Bounty Hunter I - Beat 1 player with bounty
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'bounty_hunter_1', 
    'Bounty Hunter', 
    'Defeat a player with a bounty on their head', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_claimed',
    '{"min_count": 1}',
    10,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Bounty Hunter II - Beat 5 players with bounty
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'bounty_hunter_5', 
    'Bounty Hunter II', 
    'Defeat 5 players with a bounty on their head', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_claimed',
    '{"min_count": 5}',
    25,
    5,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'bounty_hunter_1')
) ON CONFLICT (key) DO NOTHING;

-- Bounty Hunter III - Beat 25 players with bounty
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'bounty_hunter_25', 
    'Bounty Hunter III', 
    'Defeat 25 players with a bounty on their head', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_claimed',
    '{"min_count": 25}',
    50,
    25,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'bounty_hunter_5')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- WANTED ACHIEVEMENT
-- Become wanted (reach 3 win streak)
-- ============================================

INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'wanted_1', 
    'Wanted!', 
    'Reach a 3 win streak and become a target', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'win_streak',
    '{"min_streak": 3}',
    10,
    1,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- BOUNTY COLLECTED (cumulative)
-- Collect bounty from other players
-- ============================================

-- Collect 50 bounty total
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'bounty_collected_50', 
    'Small Catch', 
    'Collect a total of 50 bounty', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_claimed',
    '{"cumulative_bounty": 50}',
    15,
    50,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Collect 100 bounty total
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'bounty_collected_100', 
    'Big Catch', 
    'Collect a total of 100 bounty', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_claimed',
    '{"cumulative_bounty": 100}',
    30,
    100,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'bounty_collected_50')
) ON CONFLICT (key) DO NOTHING;

-- Collect 250 bounty total
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'bounty_collected_250', 
    'Legendary Hunter', 
    'Collect a total of 250 bounty', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_claimed',
    '{"cumulative_bounty": 250}',
    50,
    250,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'bounty_collected_100')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- BOUNTY ACCUMULATED (cumulative)
-- Track total bounty value accumulated on your head over time
-- ============================================

-- Accumulate 25 bounty total
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'bounty_earned_25', 
    'Prize Winner', 
    'Accumulate a total of 25 bounty on your head', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_gained',
    '{"cumulative_bounty": 25}',
    10,
    25,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Accumulate 75 bounty total
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'bounty_earned_75', 
    'Most Wanted', 
    'Accumulate a total of 75 bounty on your head', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_gained',
    '{"cumulative_bounty": 75}',
    25,
    75,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'bounty_earned_25')
) ON CONFLICT (key) DO NOTHING;

-- Accumulate 150 bounty total
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, parent_id
) VALUES (
    'bounty_earned_150', 
    'Public Enemy', 
    'Accumulate a total of 150 bounty on your head', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_gained',
    '{"cumulative_bounty": 150}',
    50,
    150,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'bounty_earned_75')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- GLOBAL BOUNTY ACHIEVEMENTS (cross-season)
-- These track cumulative progress across all seasons
-- ============================================

-- GLOBAL: Accumulate bounty on head (100/250/500)
-- Root achievement: 100 bounty
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'bounty_earned_100_global', 
    'Rising Threat', 
    'Accumulate a total of 100 bounty on your head (all-time)', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_gained',
    '{"cumulative_bounty": 100}',
    20,
    100,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 250 bounty (chain from 100)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'bounty_earned_250_global', 
    'High Value Target', 
    'Accumulate a total of 250 bounty on your head (all-time)', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_gained',
    '{"cumulative_bounty": 250}',
    40,
    250,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'bounty_earned_100_global')
) ON CONFLICT (key) DO NOTHING;

-- 500 bounty (chain from 250)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'bounty_earned_500_global', 
    'Walking Goldmine', 
    'Accumulate a total of 500 bounty on your head (all-time)', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_gained',
    '{"cumulative_bounty": 500}',
    75,
    500,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'bounty_earned_250_global')
) ON CONFLICT (key) DO NOTHING;

-- GLOBAL: Collect bounty from others (150/300/600)
-- Root achievement: 150 bounty
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'bounty_collected_150_global', 
    'Headhunter', 
    'Collect a total of 150 bounty from other players (all-time)', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_claimed',
    '{"cumulative_bounty": 150}',
    25,
    150,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- 300 bounty (chain from 150)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'bounty_collected_300_global', 
    'Professional Hunter', 
    'Collect a total of 300 bounty from other players (all-time)', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_claimed',
    '{"cumulative_bounty": 300}',
    50,
    300,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'bounty_collected_150_global')
) ON CONFLICT (key) DO NOTHING;

-- 600 bounty (chain from 300)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'bounty_collected_600_global', 
    'Master Bounty Hunter', 
    'Collect a total of 600 bounty from other players (all-time)', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'streaks'),
    'bounty_claimed',
    '{"cumulative_bounty": 600}',
    100,
    600,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'bounty_collected_300_global')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- SECRET ACHIEVEMENTS (is_hidden = true)
-- ============================================

-- Humiliation 1on1 - Lose 0-10
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'humiliation_1on1', 
    'Totally Embarrassed', 
    'Lose a 1on1 match 0-10', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'match_end',
    '{"gamemode": "1on1", "score_self": 0, "score_opponent": 10, "is_winner": false}',
    5,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;

-- Humiliation 2on2 - Lose 0-10
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition, 
    points, max_progress, is_hidden, is_repeatable
) VALUES (
    'humiliation_2on2', 
    'Team Embarrassment', 
    'Lose a 2on2 match 0-10', 
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'match_end',
    '{"gamemode": "2on2", "score_self": 0, "score_opponent": 10, "is_winner": false}',
    5,
    1,
    true,
    false
) ON CONFLICT (key) DO NOTHING;



-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 16: NEW META ACHIEVEMENTS (Season-Specific and Global)
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

SET search_path TO kopecht;

-- ============================================
-- SEASON-SPECIFIC META ACHIEVEMENTS
-- These track per-season progress
-- ============================================

-- Secret Finder 10 (season) - child of secret_finder
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'secret_finder_10',
    'Secret Seeker',
    'Unlock 10 hidden achievements this season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "secret_achievements_unlocked", "target": 10}',
    200,
    10,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'secret_finder')
) ON CONFLICT (key) DO NOTHING;

-- Achievement Points 5000 (season)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'achievement_points_5000',
    'Point Collector',
    'Earn 5000 achievement points this season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievement_points", "target": 5000}',
    150,
    5000,
    false,
    false,
    true
) ON CONFLICT (key) DO NOTHING;

-- Achievement Points 10000 (season)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'achievement_points_10000',
    'Point Hoarder',
    'Earn 10000 achievement points this season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievement_points", "target": 10000}',
    250,
    10000,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'achievement_points_5000')
) ON CONFLICT (key) DO NOTHING;

-- Achievement Points 25000 (season)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'achievement_points_25000',
    'Point Master',
    'Earn 25000 achievement points this season',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievement_points", "target": 25000}',
    500,
    25000,
    false,
    false,
    true,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'achievement_points_10000')
) ON CONFLICT (key) DO NOTHING;

-- Point Master frame (25000 achievement points) - inserted here because achievement_points_25000 must exist first
INSERT INTO kopecht.reward_definitions (key, name, description, type, display_position, display_value, achievement_key, icon, sort_order) VALUES
('frame_point_master', 'Point Master Frame', 'A frame for dedicated point collectors', 'frame', NULL, 'point_master_frame', 'achievement_points_25000', 'ðŸ–¼ï¸', 260)
ON CONFLICT (key) DO NOTHING;

-- Update completionist condition to target 150 achievements
-- FIX: Changed from "threshold" to "counter" so progress increments properly (like other achievement_hunter achievements)
UPDATE kopecht.achievement_definitions 
SET condition = '{"type": "counter", "metric": "achievements_unlocked", "target": 150}'::jsonb,
    max_progress = 150,
    description = 'Unlock 150 achievements'
WHERE key = 'completionist';

-- ============================================
-- GLOBAL META ACHIEVEMENTS (All-Time)
-- These track all-time progress across all seasons
-- This is a SEPARATE chain from the season-specific meta achievements
-- ============================================

-- Achievement Hunter 100 (global) - START of global chain (no parent)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'achievements_100_global',
    'Century Achiever',
    'Unlock 100 achievements (all-time)',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievements_unlocked", "target": 100}',
    300,
    100,
    false,
    false,
    false
) ON CONFLICT (key) DO UPDATE SET parent_id = NULL;

-- Achievement Hunter 250 (global)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'achievements_250_global',
    'Achievement Legend',
    'Unlock 250 achievements (all-time)',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievements_unlocked", "target": 250}',
    500,
    250,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'achievements_100_global')
) ON CONFLICT (key) DO NOTHING;

-- Achievement Hunter 500 (global)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'achievements_500_global',
    'Achievement God',
    'Unlock 500 achievements (all-time)',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievements_unlocked", "target": 500}',
    1000,
    500,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'achievements_250_global')
) ON CONFLICT (key) DO NOTHING;

-- Achievement Points 15000 (global)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'achievement_points_15000_global',
    'Global Point Collector',
    'Earn 15000 achievement points (all-time)',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievement_points", "target": 15000}',
    200,
    15000,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Achievement Points 50000 (global)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'achievement_points_50000_global',
    'Global Point Hoarder',
    'Earn 50000 achievement points (all-time)',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievement_points", "target": 50000}',
    400,
    50000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'achievement_points_15000_global')
) ON CONFLICT (key) DO NOTHING;

-- Achievement Points 100000 (global)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'achievement_points_100000_global',
    'Global Point Legend',
    'Earn 100000 achievement points (all-time)',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "achievement_points", "target": 100000}',
    750,
    100000,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'achievement_points_50000_global')
) ON CONFLICT (key) DO NOTHING;

-- Secret Finder 10 (global)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'secrets_10_global',
    'Global Secret Seeker',
    'Unlock 10 hidden achievements (all-time)',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "secret_achievements_unlocked", "target": 10}',
    200,
    10,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Secret Finder 25 (global)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'secrets_25_global',
    'Global Secret Hunter',
    'Unlock 25 hidden achievements (all-time)',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "secret_achievements_unlocked", "target": 25}',
    350,
    25,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'secrets_10_global')
) ON CONFLICT (key) DO NOTHING;

-- Secret Finder 50 (global)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific, parent_id
) VALUES (
    'secrets_50_global',
    'Global Secret Master',
    'Unlock 50 hidden achievements (all-time)',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'meta'),
    'ACHIEVEMENT_UNLOCKED',
    '{"type": "counter", "metric": "secret_achievements_unlocked", "target": 50}',
    500,
    50,
    false,
    false,
    false,
    (SELECT id FROM kopecht.achievement_definitions WHERE key = 'secrets_25_global')
) ON CONFLICT (key) DO NOTHING;

-- ============================================
-- ALL-TIME SEASON ACHIEVEMENTS
-- Dynasty and Podium tracking across all seasons
-- ============================================

-- Dynasty 1on1 - Win 3 seasons
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'season_champion_3x_1on1',
    'Dynasty (1on1)',
    'Win 3 1on1 seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_champion_count", "target": 3, "filters": {"gamemode": "1on1"}}',
    500,
    3,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Dynasty 2on2 - Win 3 seasons
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'season_champion_3x_2on2',
    'Dynasty (2on2)',
    'Win 3 2on2 seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_champion_count", "target": 3, "filters": {"gamemode": "2on2"}}',
    500,
    3,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Podium Regular 1on1 - Top 3 in 5 seasons
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'season_podium_5x_1on1',
    'Podium Regular (1on1)',
    'Finish in top 3 in 5 1on1 seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_podium_count", "target": 5, "filters": {"gamemode": "1on1"}}',
    400,
    5,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Podium Regular 2on2 - Top 3 in 5 seasons
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'season_podium_5x_2on2',
    'Podium Regular (2on2)',
    'Finish in top 3 in 5 2on2 seasons',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'season'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_podium_count", "target": 5, "filters": {"gamemode": "2on2"}}',
    400,
    5,
    false,
    false,
    false
) ON CONFLICT (key) DO NOTHING;

-- Rock Bottom 1on1 - Last place with min 10 matches (SECRET)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'season_last_1on1',
    'Rock Bottom (1on1)',
    'Finish last place in a 1on1 season (min. 10 matches)',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_last", "target": 1, "filters": {"gamemode": "1on1", "min_matches": 10}}',
    10,
    1,
    true,
    false,
    true
) ON CONFLICT (key) DO NOTHING;

-- Rock Bottom 2on2 - Last place with min 10 matches (SECRET)
INSERT INTO kopecht.achievement_definitions (
    key, name, description, category_id, trigger_event, condition,
    points, max_progress, is_hidden, is_repeatable, is_season_specific
) VALUES (
    'season_last_2on2',
    'Rock Bottom (2on2)',
    'Finish last place in a 2on2 season (min. 10 matches)',
    (SELECT id FROM kopecht.achievement_categories WHERE key = 'secret'),
    'SEASON_ENDED',
    '{"type": "threshold", "metric": "season_last", "target": 1, "filters": {"gamemode": "2on2", "min_matches": 10}}',
    10,
    1,
    true,
    false,
    true
) ON CONFLICT (key) DO NOTHING;


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 11: GOAL INSERT TRIGGER FOR RELIABLE ACHIEVEMENT PROGRESS
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- This trigger fires on every goal INSERT and updates counter-based achievements
-- directly in the database, bypassing the webhook which can drop events under load.
-- The webhook is still used for complex achievements, but simple counters are handled here.

-- Drop existing trigger and function if they exist
DROP TRIGGER IF EXISTS trg_goal_achievement_progress ON kopecht.goals;
DROP FUNCTION IF EXISTS kopecht.handle_goal_achievement_progress();

-- Create the trigger function
CREATE OR REPLACE FUNCTION kopecht.handle_goal_achievement_progress()
RETURNS TRIGGER 
SECURITY DEFINER
SET search_path = kopecht
AS $$
DECLARE
    v_season_id BIGINT;
    v_achievement RECORD;
    v_gamemode_filter TEXT;
    v_goal_type_filter TEXT;
    v_progress_season_id BIGINT;
    v_new_progress INTEGER;
    v_max_progress INTEGER;
    v_parent_max_progress INTEGER;
    v_current_progress INTEGER;
    v_just_unlocked_ids BIGINT[] := ARRAY[]::BIGINT[];
BEGIN
    -- Skip goal removals/undos
    IF NEW.amount <= 0 AND NEW.goal_type != 'own_goal' THEN
        RETURN NEW;
    END IF;
    
    -- Skip own goal removals (amount = 0)
    IF NEW.goal_type = 'own_goal' AND NEW.amount = 0 THEN
        RETURN NEW;
    END IF;
    
    -- Get season_id from the match
    SELECT m.season_id INTO v_season_id
    FROM kopecht.matches m
    WHERE m.id = NEW.match_id;
    
    -- Process all counter-based GOAL_SCORED achievements
    -- ORDER BY parent_id NULLS FIRST ensures parents are processed before children
    FOR v_achievement IN 
        SELECT ad.id, ad.key, ad.max_progress, ad.is_season_specific, ad.condition, ad.parent_id
        FROM kopecht.achievement_definitions ad
        WHERE ad.trigger_event = 'GOAL_SCORED'
          AND ad.condition->>'type' = 'counter'
          AND ad.condition->>'metric' IN ('goals', 'own_goals')
        ORDER BY ad.parent_id NULLS FIRST, ad.id
    LOOP
        -- Extract filters from condition
        v_gamemode_filter := v_achievement.condition->'filters'->>'gamemode';
        v_goal_type_filter := v_achievement.condition->'filters'->>'goal_type';
        
        -- Check gamemode filter
        IF v_gamemode_filter IS NOT NULL AND v_gamemode_filter != NEW.gamemode THEN
            CONTINUE;
        END IF;
        
        -- Check goal_type filter
        IF v_goal_type_filter IS NOT NULL THEN
            IF v_goal_type_filter = 'own_goal' AND NEW.goal_type != 'own_goal' THEN
                CONTINUE;
            END IF;
            IF v_goal_type_filter != 'own_goal' AND NEW.goal_type = 'own_goal' THEN
                CONTINUE;
            END IF;
        ELSE
            -- No goal_type filter means standard goals only (not own goals)
            IF NEW.goal_type = 'own_goal' THEN
                CONTINUE;
            END IF;
        END IF;
        
        -- Skip season-specific achievements if match has no season
        IF v_achievement.is_season_specific AND v_season_id IS NULL THEN
            CONTINUE;
        END IF;
        
        -- Determine progress season_id
        IF v_achievement.is_season_specific THEN
            v_progress_season_id := v_season_id;
        ELSE
            v_progress_season_id := NULL;
        END IF;
        
        -- Check if achievement is already unlocked (skip if not repeatable)
        IF EXISTS (
            SELECT 1 FROM kopecht.player_achievements pa
            WHERE pa.player_id = NEW.player_id
              AND pa.achievement_id = v_achievement.id
              AND (
                  (v_progress_season_id IS NULL AND pa.season_id IS NULL) OR
                  (pa.season_id = v_progress_season_id)
              )
        ) THEN
            CONTINUE;
        END IF;
        
        -- Check parent achievement (chain logic)
        IF v_achievement.parent_id IS NOT NULL THEN
            -- Check if parent was JUST unlocked in this trigger execution
            IF v_achievement.parent_id = ANY(v_just_unlocked_ids) THEN
                -- Parent just unlocked! Initialize child with parent's max_progress
                -- Don't count this goal again - parent already counted it
                SELECT ad.max_progress INTO v_parent_max_progress
                FROM kopecht.achievement_definitions ad
                WHERE ad.id = v_achievement.parent_id;
                
                -- Initialize child progress with parent's max_progress
                v_max_progress := v_achievement.max_progress;
                v_new_progress := LEAST(v_parent_max_progress, v_max_progress);
                
                -- Insert the initialized progress
                BEGIN
                    INSERT INTO kopecht.player_achievement_progress (
                        player_id, achievement_id, current_progress, season_id, updated_at
                    ) VALUES (
                        NEW.player_id, v_achievement.id, v_new_progress, v_progress_season_id, NOW()
                    );
                EXCEPTION WHEN unique_violation THEN
                    -- Already exists, update it
                    IF v_progress_season_id IS NULL THEN
                        UPDATE kopecht.player_achievement_progress
                        SET current_progress = GREATEST(current_progress, v_new_progress),
                            updated_at = NOW()
                        WHERE player_id = NEW.player_id 
                          AND achievement_id = v_achievement.id
                          AND season_id IS NULL;
                    ELSE
                        UPDATE kopecht.player_achievement_progress
                        SET current_progress = GREATEST(current_progress, v_new_progress),
                            updated_at = NOW()
                        WHERE player_id = NEW.player_id 
                          AND achievement_id = v_achievement.id
                          AND season_id = v_progress_season_id;
                    END IF;
                END;
                
                -- Check if child is also completed
                IF v_new_progress >= v_max_progress THEN
                    BEGIN
                        INSERT INTO kopecht.player_achievements (
                            player_id, achievement_id, unlocked_at, season_id, match_id
                        ) VALUES (
                            NEW.player_id, v_achievement.id, NOW(), v_progress_season_id, NEW.match_id
                        );
                        v_just_unlocked_ids := array_append(v_just_unlocked_ids, v_achievement.id);
                    EXCEPTION WHEN unique_violation THEN
                        NULL;
                    END;
                END IF;
                
                CONTINUE; -- Skip normal increment for this achievement
            END IF;
            
            -- Parent was not just unlocked - check if it was previously unlocked
            IF NOT EXISTS (
                SELECT 1 FROM kopecht.player_achievements pa
                WHERE pa.player_id = NEW.player_id
                  AND pa.achievement_id = v_achievement.parent_id
            ) THEN
                CONTINUE; -- Parent not unlocked, skip this child
            END IF;
        END IF;
        
        -- Get max_progress
        v_max_progress := v_achievement.max_progress;
        
        -- Increment progress using loop-based upsert pattern
        LOOP
            -- Try UPDATE first
            IF v_progress_season_id IS NULL THEN
                UPDATE kopecht.player_achievement_progress
                SET current_progress = LEAST(current_progress + 1, v_max_progress),
                    updated_at = NOW()
                WHERE player_id = NEW.player_id 
                  AND achievement_id = v_achievement.id
                  AND season_id IS NULL
                RETURNING current_progress INTO v_new_progress;
            ELSE
                UPDATE kopecht.player_achievement_progress
                SET current_progress = LEAST(current_progress + 1, v_max_progress),
                    updated_at = NOW()
                WHERE player_id = NEW.player_id 
                  AND achievement_id = v_achievement.id
                  AND season_id = v_progress_season_id
                RETURNING current_progress INTO v_new_progress;
            END IF;
            
            -- If UPDATE succeeded, exit loop
            IF FOUND THEN
                EXIT;
            END IF;
            
            -- Try INSERT
            BEGIN
                v_new_progress := LEAST(1, v_max_progress);
                INSERT INTO kopecht.player_achievement_progress (
                    player_id, achievement_id, current_progress, season_id, updated_at
                ) VALUES (
                    NEW.player_id, v_achievement.id, v_new_progress, v_progress_season_id, NOW()
                );
                EXIT;
            EXCEPTION WHEN unique_violation THEN
                -- Loop back and try UPDATE again
                NULL;
            END;
        END LOOP;
        
        -- Check if achievement should be unlocked
        IF v_new_progress >= v_max_progress THEN
            BEGIN
                INSERT INTO kopecht.player_achievements (
                    player_id, achievement_id, unlocked_at, season_id, match_id
                ) VALUES (
                    NEW.player_id, v_achievement.id, NOW(), v_progress_season_id, NEW.match_id
                );
                -- Track that this achievement was just unlocked (for chain children)
                v_just_unlocked_ids := array_append(v_just_unlocked_ids, v_achievement.id);
            EXCEPTION WHEN unique_violation THEN
                -- Already unlocked by another process, ignore
                NULL;
            END;
        END IF;
        
    END LOOP;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create the trigger
CREATE TRIGGER trg_goal_achievement_progress
    AFTER INSERT ON kopecht.goals
    FOR EACH ROW
    EXECUTE FUNCTION kopecht.handle_goal_achievement_progress();

-- Grant execute permission
GRANT EXECUTE ON FUNCTION kopecht.handle_goal_achievement_progress TO service_role;


-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PART 12: UPDATE EXISTING ACHIEVEMENTS (for migrations)
-- ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Update max_progress for win streak achievements to enable progress tracking
-- Update Heavy Lifter to >= 8 goals

UPDATE kopecht.achievement_definitions SET max_progress = 5 WHERE key = 'win_streak_5_1on1';
UPDATE kopecht.achievement_definitions SET max_progress = 5 WHERE key = 'win_streak_5_2on2';
UPDATE kopecht.achievement_definitions SET max_progress = 10 WHERE key = 'win_streak_10_1on1';
UPDATE kopecht.achievement_definitions SET max_progress = 10 WHERE key = 'win_streak_10_2on2';
UPDATE kopecht.achievement_definitions SET max_progress = 15 WHERE key = 'win_streak_15_1on1';
UPDATE kopecht.achievement_definitions SET max_progress = 15 WHERE key = 'win_streak_15_2on2';

-- Update Heavy Lifter to >= 8 goals instead of exactly 9
UPDATE kopecht.achievement_definitions 
SET description = 'Score at least 8 goals in a 2on2 match and win 10-X',
    condition = '{"type": "threshold", "metric": "goals_in_match", "target": 8, "comparison": "gte", "filters": {"gamemode": "2on2", "result": "win", "team_score": 10}}'
WHERE key = 'carry_9_goals';

-- Add unique constraint to bounty_history for proper 2on2 bounty handling
-- This allows both winners to claim the same bounty via ON CONFLICT DO NOTHING
CREATE UNIQUE INDEX IF NOT EXISTS idx_bounty_history_unique_claim
ON kopecht.bounty_history(claimer_id, victim_id, match_id);

-- Update the bounty function to properly handle 2on2 bounty claims
-- Both winners should get credit for bounties from LOSING team opponents only
-- FIX: Split bounty between winners in 2on2 (each gets half, not full amount)
DROP FUNCTION IF EXISTS kopecht.update_player_status_after_match(BIGINT, BIGINT, TEXT, BOOLEAN, INT, INT, INT);

CREATE OR REPLACE FUNCTION kopecht.update_player_status_after_match(
    p_player_id BIGINT,
    p_match_id BIGINT,
    p_gamemode TEXT,
    p_is_winner BOOLEAN,
    p_score_diff INT,
    p_own_mmr INT,
    p_opponent_mmr INT
)
RETURNS TABLE (
    bounty_claimed INT,
    bounty_victim_id BIGINT,
    new_status TEXT[],
    streak INT,
    bounty_gained INT,
    old_streak INT
) AS $$
DECLARE
    v_current_streak INT;
    v_new_streak INT;
    v_current_bounty INT;
    v_new_bounty INT;
    v_threshold_bounty INT;
    v_bounty_gained INT := 0;
    v_active_statuses TEXT[];
    v_bounty_to_claim INT := 0;
    v_bounty_victim BIGINT := NULL;
    v_opponent_status RECORD;
    v_status_def RECORD;
    v_month TEXT;
    v_was_on_loss_streak BOOLEAN := FALSE;
    v_loss_streak_before INT := 0;
    v_winner_count INT := 1;
BEGIN
    -- Get current month for monthly events
    v_month := TO_CHAR(NOW(), 'YYYY-MM');
    
    -- Get or create player status record
    INSERT INTO kopecht.player_status (player_id, gamemode, current_streak, current_bounty, active_statuses)
    VALUES (p_player_id, p_gamemode, 0, 0, '{}')
    ON CONFLICT (player_id, gamemode) DO NOTHING;
    
    -- Get current status
    SELECT current_streak, current_bounty, active_statuses
    INTO v_current_streak, v_current_bounty, v_active_statuses
    FROM kopecht.player_status
    WHERE player_id = p_player_id AND gamemode = p_gamemode;
    
    -- Track if player was on a loss streak (for comeback detection)
    IF v_current_streak < 0 THEN
        v_was_on_loss_streak := TRUE;
        v_loss_streak_before := ABS(v_current_streak);
    END IF;
    
    -- Calculate new streak
    IF p_is_winner THEN
        IF v_current_streak >= 0 THEN
            v_new_streak := v_current_streak + 1;
        ELSE
            v_new_streak := 1;  -- Reset from loss streak
        END IF;
    ELSE
        IF v_current_streak <= 0 THEN
            v_new_streak := v_current_streak - 1;
        ELSE
            v_new_streak := -1;  -- Reset from win streak
        END IF;
    END IF;
    
    -- ============================================
    -- FIXED BOUNTY CALCULATION
    -- Only add bounty when crossing a threshold
    -- ============================================
    IF p_is_winner AND v_new_streak >= 3 THEN
        -- Keep existing bounty as base (or 0 if coming from loss streak)
        IF v_current_streak >= 0 THEN
            v_new_bounty := v_current_bounty;
        ELSE
            v_new_bounty := 0;
        END IF;
        
        -- Check if we just crossed a threshold (3, 5, 7, or 10)
        -- Only add bounty if v_new_streak matches a threshold AND v_current_streak was below it
        SELECT bounty_per_streak INTO v_threshold_bounty
        FROM kopecht.status_definitions
        WHERE type = 'streak' 
          AND (condition->>'streak_type') = 'win'
          AND (condition->>'min_streak')::int = v_new_streak
          AND v_current_streak < v_new_streak;  -- Must have just crossed this threshold
        
        -- Add threshold bounty if we crossed one
        IF v_threshold_bounty IS NOT NULL AND v_threshold_bounty > 0 THEN
            v_new_bounty := v_new_bounty + v_threshold_bounty;
            v_bounty_gained := v_threshold_bounty;  -- Track how much bounty was just gained
        END IF;
    ELSE
        -- Not on a win streak of 3+, bounty is 0
        v_new_bounty := 0;
    END IF;
    
    -- Check if we need to claim bounty from opponent (if we won and broke their streak)
    -- FIX: In 2on2, BOTH winners claim bounty from LOSING team opponents only
    IF p_is_winner THEN
        FOR v_opponent_status IN
            SELECT ps.player_id, ps.current_streak, ps.current_bounty
            FROM kopecht.player_status ps
            JOIN kopecht.matches m ON m.id = p_match_id
            WHERE ps.gamemode = p_gamemode
              AND ps.current_streak >= 3
              AND ps.player_id != p_player_id
              AND (
                  -- 1on1: Only one opponent, simple check
                  (p_gamemode = '1on1' AND ps.player_id IN (m.player1, m.player2))
                  OR
                  -- 2on2: Check that opponent is on the LOSING team (opposite of current player's team)
                  (p_gamemode = '2on2' AND (
                      -- If current player is on Team 1 (winner), opponent must be on Team 2 (loser)
                      (p_player_id IN (m.player1, m.player3) AND m."scoreTeam1" > m."scoreTeam2" AND ps.player_id IN (m.player2, m.player4))
                      OR
                      -- If current player is on Team 2 (winner), opponent must be on Team 1 (loser)
                      (p_player_id IN (m.player2, m.player4) AND m."scoreTeam2" > m."scoreTeam1" AND ps.player_id IN (m.player1, m.player3))
                  ))
              )
        LOOP
            v_bounty_to_claim := v_bounty_to_claim + v_opponent_status.current_bounty;
            v_bounty_victim := v_opponent_status.player_id;
            
            -- Insert into bounty_history - ON CONFLICT allows both winners to track their bounty claim
            INSERT INTO kopecht.bounty_history (claimer_id, victim_id, match_id, gamemode, streak_broken, bounty_amount)
            VALUES (p_player_id, v_opponent_status.player_id, p_match_id, p_gamemode, v_opponent_status.current_streak, v_opponent_status.current_bounty)
            ON CONFLICT (claimer_id, victim_id, match_id) DO NOTHING;
        END LOOP;
        
        -- FIX: Split bounty between winners in 2on2 matches
        -- Each winner gets their share (half in 2on2, full in 1on1/2on1)
        IF p_gamemode = '2on2' AND v_bounty_to_claim > 0 THEN
            -- Count the number of winners on the winning team
            SELECT 
                CASE 
                    WHEN m."scoreTeam1" > m."scoreTeam2" THEN
                        (CASE WHEN m.player1 IS NOT NULL THEN 1 ELSE 0 END) +
                        (CASE WHEN m.player3 IS NOT NULL THEN 1 ELSE 0 END)
                    ELSE
                        (CASE WHEN m.player2 IS NOT NULL THEN 1 ELSE 0 END) +
                        (CASE WHEN m.player4 IS NOT NULL THEN 1 ELSE 0 END)
                END INTO v_winner_count
            FROM kopecht.matches m
            WHERE m.id = p_match_id;
            
            -- Safety check: ensure at least 1 winner
            IF v_winner_count IS NULL OR v_winner_count < 1 THEN
                v_winner_count := 2;  -- Default to 2 for 2on2
            END IF;
            
            -- Split the bounty among winners (integer division)
            v_bounty_to_claim := v_bounty_to_claim / v_winner_count;
        END IF;
    END IF;
    
    -- Determine active statuses based on new streak
    v_active_statuses := '{}';
    
    FOR v_status_def IN
        SELECT key, condition
        FROM kopecht.status_definitions
        WHERE type = 'streak'
        ORDER BY priority DESC
    LOOP
        IF (v_status_def.condition->>'streak_type') = 'win' AND v_new_streak >= (v_status_def.condition->>'min_streak')::int THEN
            v_active_statuses := array_append(v_active_statuses, v_status_def.key);
        ELSIF (v_status_def.condition->>'streak_type') = 'loss' AND v_new_streak <= -(v_status_def.condition->>'min_streak')::int THEN
            v_active_statuses := array_append(v_active_statuses, v_status_def.key);
        END IF;
    END LOOP;
    
    -- Check for special events
    
    -- Comeback King: Won after 5+ loss streak
    IF p_is_winner AND v_was_on_loss_streak AND v_loss_streak_before >= 5 THEN
        v_active_statuses := array_append(v_active_statuses, 'comeback_king');
        
        INSERT INTO kopecht.player_monthly_status (player_id, gamemode, month, comeback_count)
        VALUES (p_player_id, p_gamemode, v_month, 1)
        ON CONFLICT (player_id, gamemode, month)
        DO UPDATE SET comeback_count = kopecht.player_monthly_status.comeback_count + 1, updated_at = NOW();
    END IF;
    
    -- Underdog: Beat opponent with 200+ higher MMR
    IF p_is_winner AND (p_opponent_mmr - p_own_mmr) >= 200 THEN
        v_active_statuses := array_append(v_active_statuses, 'underdog');
        
        INSERT INTO kopecht.player_monthly_status (player_id, gamemode, month, underdog_count)
        VALUES (p_player_id, p_gamemode, v_month, 1)
        ON CONFLICT (player_id, gamemode, month)
        DO UPDATE SET underdog_count = kopecht.player_monthly_status.underdog_count + 1, updated_at = NOW();
    END IF;
    
    -- Dominator: 10-0 win
    IF p_is_winner AND p_score_diff = 10 THEN
        v_active_statuses := array_append(v_active_statuses, 'dominator');
        
        INSERT INTO kopecht.player_monthly_status (player_id, gamemode, month, dominator_count)
        VALUES (p_player_id, p_gamemode, v_month, 1)
        ON CONFLICT (player_id, gamemode, month)
        DO UPDATE SET dominator_count = kopecht.player_monthly_status.dominator_count + 1, updated_at = NOW();
    END IF;
    
    -- Humiliated: 0-10 loss
    IF NOT p_is_winner AND p_score_diff = -10 THEN
        v_active_statuses := array_append(v_active_statuses, 'humiliated');
        
        INSERT INTO kopecht.player_monthly_status (player_id, gamemode, month, humiliated_count)
        VALUES (p_player_id, p_gamemode, v_month, 1)
        ON CONFLICT (player_id, gamemode, month)
        DO UPDATE SET humiliated_count = kopecht.player_monthly_status.humiliated_count + 1, updated_at = NOW();
    END IF;
    
    -- Update player status
    UPDATE kopecht.player_status
    SET current_streak = v_new_streak,
        current_bounty = v_new_bounty,
        active_statuses = v_active_statuses,
        last_match_id = p_match_id,
        updated_at = NOW()
    WHERE player_id = p_player_id AND gamemode = p_gamemode;
    
    -- Return results
    bounty_claimed := v_bounty_to_claim;
    bounty_victim_id := v_bounty_victim;
    new_status := v_active_statuses;
    streak := v_new_streak;
    bounty_gained := v_bounty_gained;
    old_streak := v_current_streak;
    
    RETURN NEXT;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION kopecht.update_player_status_after_match(BIGINT, BIGINT, TEXT, BOOLEAN, INT, INT, INT) TO authenticated;
GRANT EXECUTE ON FUNCTION kopecht.update_player_status_after_match(BIGINT, BIGINT, TEXT, BOOLEAN, INT, INT, INT) TO service_role;


-- ============================================
-- ROBUST POINT COLLECTOR SYNC TRIGGER
-- Synchronously updates Point Collector achievements when any achievement is unlocked
-- Uses absolute values (idempotent) to prevent race conditions and lost webhooks
-- ============================================

-- Helper function to update a point collector and its chain
CREATE OR REPLACE FUNCTION kopecht.update_point_collector_progress(
    p_player_id BIGINT,
    p_achievement_key TEXT,
    p_total_points INTEGER,
    p_season_id BIGINT
)
RETURNS VOID AS $$
DECLARE
    v_achievement RECORD;
    v_current_key TEXT := p_achievement_key;
    v_parent_unlocked BOOLEAN := TRUE;
BEGIN
    -- Walk through the chain starting from the base achievement
    WHILE v_current_key IS NOT NULL AND v_parent_unlocked LOOP
        -- Get this achievement's details
        SELECT id, max_progress, parent_id, key INTO v_achievement
        FROM kopecht.achievement_definitions
        WHERE key = v_current_key;

        IF v_achievement.id IS NULL THEN
            EXIT;  -- Achievement not found, stop
        END IF;

        -- Check if parent is unlocked (for chain achievements)
        IF v_achievement.parent_id IS NOT NULL THEN
            IF p_season_id IS NULL THEN
                SELECT EXISTS(
                    SELECT 1 FROM kopecht.player_achievements
                    WHERE player_id = p_player_id
                    AND achievement_id = v_achievement.parent_id
                    AND season_id IS NULL
                ) INTO v_parent_unlocked;
            ELSE
                SELECT EXISTS(
                    SELECT 1 FROM kopecht.player_achievements
                    WHERE player_id = p_player_id
                    AND achievement_id = v_achievement.parent_id
                    AND season_id = p_season_id
                ) INTO v_parent_unlocked;
            END IF;

            IF NOT v_parent_unlocked THEN
                EXIT;  -- Parent not unlocked, can't progress this chain
            END IF;
        END IF;

        -- Update or insert progress (idempotent - sets absolute value, only increases)
        -- Use UPDATE first, then INSERT to handle NULL season_id correctly
        -- Use absolute value (p_total_points), NOT GREATEST - we calculate the real total each time
        IF p_season_id IS NULL THEN
            -- Try UPDATE first for NULL season_id
            UPDATE kopecht.player_achievement_progress
            SET current_progress = p_total_points,
                updated_at = NOW()
            WHERE player_id = p_player_id 
              AND achievement_id = v_achievement.id
              AND season_id IS NULL;
            
            -- If no row was updated, insert (no ON CONFLICT needed, we just checked)
            IF NOT FOUND THEN
                INSERT INTO kopecht.player_achievement_progress (
                    player_id, achievement_id, current_progress, season_id, updated_at
                ) VALUES (
                    p_player_id, v_achievement.id, p_total_points, NULL, NOW()
                );
            END IF;
        ELSE
            -- Try UPDATE first for non-NULL season_id too
            UPDATE kopecht.player_achievement_progress
            SET current_progress = p_total_points,
                updated_at = NOW()
            WHERE player_id = p_player_id 
              AND achievement_id = v_achievement.id
              AND season_id = p_season_id;
            
            -- If no row was updated, insert
            IF NOT FOUND THEN
                INSERT INTO kopecht.player_achievement_progress (
                    player_id, achievement_id, current_progress, season_id, updated_at
                ) VALUES (
                    p_player_id, v_achievement.id, p_total_points, p_season_id, NOW()
                );
            END IF;
        END IF;

        -- Check if this achievement is now completed
        IF p_total_points >= v_achievement.max_progress THEN
            -- Try to award achievement (idempotent - uses WHERE NOT EXISTS)
            IF p_season_id IS NULL THEN
                INSERT INTO kopecht.player_achievements (
                    player_id, achievement_id, unlocked_at, season_id
                )
                SELECT p_player_id, v_achievement.id, NOW(), NULL
                WHERE NOT EXISTS (
                    SELECT 1 FROM kopecht.player_achievements
                    WHERE player_id = p_player_id
                    AND achievement_id = v_achievement.id
                    AND season_id IS NULL
                );
            ELSE
                INSERT INTO kopecht.player_achievements (
                    player_id, achievement_id, unlocked_at, season_id
                )
                SELECT p_player_id, v_achievement.id, NOW(), p_season_id
                WHERE NOT EXISTS (
                    SELECT 1 FROM kopecht.player_achievements
                    WHERE player_id = p_player_id
                    AND achievement_id = v_achievement.id
                    AND season_id = p_season_id
                );
            END IF;
        END IF;

        -- Move to next in chain (find child achievement)
        SELECT key INTO v_current_key
        FROM kopecht.achievement_definitions
        WHERE parent_id = v_achievement.id
        AND key LIKE 'achievement_points_%'
        LIMIT 1;
    END LOOP;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Main trigger function
CREATE OR REPLACE FUNCTION kopecht.sync_point_collector_on_achievement()
RETURNS TRIGGER AS $$
DECLARE
    v_achievement_key TEXT;
    v_season_points INTEGER;
    v_global_points INTEGER;
BEGIN
    -- Get the key of the achievement that was just unlocked
    SELECT key INTO v_achievement_key
    FROM kopecht.achievement_definitions
    WHERE id = NEW.achievement_id;

    -- Skip if this IS a point collector achievement (prevent infinite loop)
    -- Also skip if achievement not found
    IF v_achievement_key IS NULL OR v_achievement_key LIKE 'achievement_points_%' THEN
        RETURN NEW;
    END IF;

    -- Calculate season-specific points (only from season-specific achievements in this season)
    IF NEW.season_id IS NOT NULL THEN
        SELECT COALESCE(SUM(ad.points), 0) INTO v_season_points
        FROM kopecht.player_achievements pa
        JOIN kopecht.achievement_definitions ad ON pa.achievement_id = ad.id
        WHERE pa.player_id = NEW.player_id
        AND pa.season_id = NEW.season_id
        AND ad.is_season_specific = true
        AND ad.key NOT LIKE 'achievement_points_%';  -- Don't count point collector points

        -- Update season Point Collector chain (5000 -> 10000 -> 25000)
        PERFORM kopecht.update_point_collector_progress(
            NEW.player_id,
            'achievement_points_5000',
            v_season_points,
            NEW.season_id
        );
    END IF;

    -- Calculate global points (ALL achievements, all time)
    SELECT COALESCE(SUM(ad.points), 0) INTO v_global_points
    FROM kopecht.player_achievements pa
    JOIN kopecht.achievement_definitions ad ON pa.achievement_id = ad.id
    WHERE pa.player_id = NEW.player_id
    AND ad.key NOT LIKE 'achievement_points_%';  -- Don't count point collector points

    -- Update global Point Collector chain (15000 -> 50000 -> 100000)
    PERFORM kopecht.update_point_collector_progress(
        NEW.player_id,
        'achievement_points_15000_global',
        v_global_points,
        NULL
    );

    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create the trigger (AFTER INSERT to ensure the achievement is already in the table)
DROP TRIGGER IF EXISTS sync_point_collector_trigger ON kopecht.player_achievements;
CREATE TRIGGER sync_point_collector_trigger
    AFTER INSERT ON kopecht.player_achievements
    FOR EACH ROW
    EXECUTE FUNCTION kopecht.sync_point_collector_on_achievement();

-- Grant execute permissions
GRANT EXECUTE ON FUNCTION kopecht.sync_point_collector_on_achievement() TO service_role;
GRANT EXECUTE ON FUNCTION kopecht.update_point_collector_progress(BIGINT, TEXT, INTEGER, BIGINT) TO service_role;


-- ============================================
-- Migration: Add Season Announcement Seen Column
-- Tracks whether a player has seen the new season announcement
-- ============================================

ALTER TABLE kopecht.season_rankings
ADD COLUMN IF NOT EXISTS season_announcement_seen BOOLEAN DEFAULT FALSE;
